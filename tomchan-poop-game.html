<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>„Éà„É†„Å°„ÇÉ„Çì„ÅÆ„ÅÜ„Çì„Å°„Ç≤„Éº„É†</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: 'Segoe UI', sans-serif;
  overflow: hidden;
  user-select: none;
  background: #222;
}

#game-container {
  width: 800px;
  height: 600px;
  margin: 10px auto;
  position: relative;
  border: 3px solid #555;
  border-radius: 8px;
  overflow: hidden;
  touch-action: manipulation;
}

/* HUD */
#hud {
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 44px;
  background: linear-gradient(180deg, rgba(20,15,10,0.85), rgba(30,25,18,0.8));
  color: #e8e0d8;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  font-size: 15px;
  z-index: 100;
  border-bottom: 1px solid rgba(120,100,70,0.3);
}
#hud .label { font-weight: bold; color: #c8baa8; }
#poop-bar-container {
  width: 200px; height: 14px;
  background: rgba(60,50,35,0.7); border-radius: 7px;
  overflow: hidden;
  border: 1px solid rgba(100,80,50,0.3);
}
#poop-bar {
  height: 100%; width: 0%;
  background: linear-gradient(90deg, #8a6a3a, #c05030, #aa2020);
  transition: width 0.3s;
  border-radius: 7px;
}
#timer { font-size: 22px; font-weight: bold; color: #e8dcd0; letter-spacing: 1px; }

/* Rooms */
.room {
  width: 100%; height: 100%;
  position: absolute;
  top: 0; left: 0;
  display: none;
  image-rendering: auto;
}
.room.active { display: block; }

/* Room tabs */
#room-tabs {
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 48px;
  background: linear-gradient(180deg, rgba(30,25,18,0.8), rgba(20,15,10,0.9));
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  z-index: 100;
  border-top: 1px solid rgba(120,100,70,0.3);
}
.room-tab {
  padding: 8px 18px;
  background: rgba(70,60,45,0.7);
  color: #d8d0c4;
  border: 1px solid rgba(120,100,70,0.4);
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  font-weight: bold;
  transition: all 0.2s;
}
.room-tab:hover { background: rgba(100,85,60,0.7); }
.room-tab.active { background: rgba(160,120,50,0.7); color: #fff; border-color: rgba(200,160,60,0.6); }
.room-tab .tab-poop { color: #c09050; margin-left: 4px; font-weight: bold; }

/* Entities */
.poop {
  position: absolute;
  width: 36px;
  height: 38px;
  cursor: pointer;
  z-index: 10;
  transition: transform 0.1s;
  animation: poopAppear 0.4s ease-out;
  filter: drop-shadow(1px 2px 3px rgba(0,0,0,0.35));
}
.poop svg {
  width: 100%;
  height: 100%;
  display: block;
}
.poop:hover {
  transform: scale(1.25);
  filter: drop-shadow(2px 3px 5px rgba(0,0,0,0.45));
}
@keyframes poopAppear {
  0% { transform: scale(0) rotate(-90deg); opacity: 0; }
  70% { transform: scale(1.1) rotate(5deg); opacity: 1; }
  100% { transform: scale(1) rotate(0deg); opacity: 1; }
}
.poop.cleaned {
  animation: poopClean 0.3s ease-in forwards;
}
@keyframes poopClean {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(0.8) rotate(10deg); opacity: 0.5; }
  100% { transform: scale(0) rotate(20deg); opacity: 0; }
}

#tom {
  position: absolute;
  z-index: 20;
  transition: left 0.6s ease, top 0.6s ease;
  cursor: pointer;
  width: 80px;
  height: 48px;
}
#tom svg {
  width: 80px;
  height: 48px;
  display: block;
}
.tom-icon-inline {
  width: 64px; height: 38px; display: inline-block; vertical-align: middle;
}
.tom-icon-large {
  width: 96px; height: 58px; display: inline-block; vertical-align: middle;
}
#tom.caged {
  cursor: default;
}
/* Pet crate / „Éö„ÉÉ„Éà„Ç±„Éº„Ç∏ */
#tom.caged::before {
  content: '';
  position: absolute;
  top: -18px; left: -14px;
  width: 108px; height: 78px;
  border: 4px solid #708090;
  border-radius: 10px 10px 6px 6px;
  background:
    repeating-linear-gradient(90deg, transparent 0px, transparent 10px, rgba(120,140,160,0.6) 10px, rgba(120,140,160,0.6) 12px),
    linear-gradient(180deg, rgba(180,200,220,0.15) 0%, rgba(100,120,140,0.1) 100%);
  box-shadow:
    0 3px 10px rgba(0,0,0,0.3),
    inset 0 0 10px rgba(255,255,255,0.1);
  z-index: 25;
  animation: crateAppear 0.3s ease-out;
}
/* Crate door / gate pattern */
#tom.caged::after {
  content: '';
  position: absolute;
  top: -14px; left: -10px;
  width: 100px; height: 70px;
  background:
    repeating-linear-gradient(0deg, transparent 0px, transparent 10px, rgba(120,140,160,0.35) 10px, rgba(120,140,160,0.35) 12px);
  border-radius: 8px;
  z-index: 25;
  pointer-events: none;
  animation: crateAppear 0.3s ease-out;
}
@keyframes crateAppear {
  0% { transform: scale(0.3) translateY(-30px); opacity: 0; }
  60% { transform: scale(1.05) translateY(2px); opacity: 0.9; }
  100% { transform: scale(1) translateY(0); opacity: 1; }
}
#cage-timer-bar {
  position: absolute;
  bottom: -10px; left: -10px;
  width: 100px; height: 6px;
  background: #444;
  border-radius: 3px;
  overflow: hidden;
  display: none;
  z-index: 26;
}
#cage-timer-bar .bar-fill {
  height: 100%;
  width: 100%;
  background: linear-gradient(90deg, #ff4444, #ffaa00);
  transition: width 0.1s linear;
}

#eiko {
  position: absolute;
  z-index: 20;
  width: 50px;
  height: 80px;
  transition: left 0.15s, top 0.15s;
}
#eiko svg {
  width: 50px;
  height: 80px;
  display: block;
}

#yoko {
  position: absolute;
  z-index: 19;
  width: 46px;
  height: 74px;
  transition: left 0.8s ease, top 0.8s ease;
}
#yoko svg {
  width: 46px;
  height: 74px;
  display: block;
}
#yoko.pooping::after {
  content: 'üí®';
  position: absolute;
  bottom: 0;
  left: -10px;
  font-size: 18px;
  animation: puffAnim 0.5s ease-out;
}
#yoko.stomping {
  animation: yokoStomp 0.4s ease-in-out;
}
@keyframes yokoStomp {
  0%, 100% { transform: scale(1); }
  30% { transform: scale(1.2) rotate(-5deg); }
  60% { transform: scale(0.95) rotate(3deg); }
}
#yoko.helping::after {
  content: '‚ú®';
  position: absolute;
  top: -15px;
  left: 10px;
  font-size: 20px;
  animation: puffAnim 0.5s ease-out;
}
.yoko-icon-inline {
  width: 30px; height: 48px; display: inline-block; vertical-align: middle;
}
.eiko-icon-inline {
  width: 30px; height: 48px; display: inline-block; vertical-align: middle;
}
.eiko-icon-large {
  width: 50px; height: 80px; display: inline-block; vertical-align: middle;
}

/* Clean effect (spray / wipe) */
.sparkle {
  position: absolute;
  font-size: 16px;
  z-index: 15;
  pointer-events: none;
  animation: sparkleAnim 0.6s ease-out forwards;
  color: rgba(180,200,220,0.8);
}
@keyframes sparkleAnim {
  0% { transform: scale(0.8); opacity: 1; }
  40% { transform: scale(1.3) translateY(-8px); opacity: 0.8; }
  100% { transform: scale(1.8) translateY(-25px); opacity: 0; }
}

/* Stage mechanic: pee puddle */
.pee-puddle {
  position: absolute;
  border-radius: 50%;
  background: radial-gradient(ellipse, rgba(255,220,50,0.45), rgba(220,190,30,0.15));
  border: 1px solid rgba(200,180,30,0.3);
  pointer-events: none;
  z-index: 3;
  animation: puddleAppear 0.5s ease-out;
}
@keyframes puddleAppear {
  0% { transform: scale(0); opacity: 0; }
  100% { transform: scale(1); opacity: 1; }
}

/* Eiko stunned (pee puddle / awakening recoil) */
#eiko.stunned {
  filter: grayscale(0.5) brightness(0.8);
  animation: stunShake 0.15s ease-in-out infinite alternate;
}
@keyframes stunShake {
  0% { transform: translateX(-3px); }
  100% { transform: translateX(3px); }
}

/* Eiko awakened mode */
#eiko.awakened {
  filter: drop-shadow(0 0 8px rgba(255,100,0,0.6));
  animation: awakenPulse 0.4s ease-in-out infinite alternate;
}
@keyframes awakenPulse {
  0% { filter: drop-shadow(0 0 6px rgba(255,100,0,0.4)); }
  100% { filter: drop-shadow(0 0 14px rgba(255,100,0,0.8)); }
}

/* Tom frozen by snack */
#tom.frozen {
  filter: brightness(1.3) saturate(0.4);
  opacity: 0.65;
}

/* Tom slippery stage movement */
#tom.slippery-stage {
  transition: left 1.2s cubic-bezier(0.25,0.1,0.25,1.5), top 1.2s cubic-bezier(0.25,0.1,0.25,1.5) !important;
}

/* Misclick penalty flash */
.misclick-flash {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(255,0,0,0.1);
  pointer-events: none;
  z-index: 90;
  animation: misclickFlash 0.3s ease-out forwards;
}
@keyframes misclickFlash {
  0% { opacity: 1; }
  100% { opacity: 0; }
}

/* Hidden poop (shimasa room mechanic) */
.poop.hidden-poop {
  opacity: 0.15;
  transition: opacity 0.3s;
}
.poop.hidden-poop:hover {
  opacity: 0.7;
}
.full-armor-active .poop.hidden-poop {
  opacity: 0.4;
  box-shadow: 0 0 8px rgba(100,200,255,0.6);
}

/* Trap poop (eiko room mechanic) */
.poop.trap-poop {
  filter: drop-shadow(0 0 4px rgba(180,0,255,0.4)) hue-rotate(40deg);
}

/* Active item HUD buttons */
.active-item-btn {
  background: rgba(20,15,10,0.85);
  border: 1px solid rgba(200,160,60,0.5);
  border-radius: 6px;
  padding: 3px 10px;
  cursor: pointer;
  font-size: 14px;
  color: #e8dcc8;
  transition: transform 0.15s, border-color 0.2s;
  margin: 0 2px;
}
.active-item-btn:hover {
  transform: scale(1.1);
  border-color: rgba(255,200,60,0.8);
}
.active-item-btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}
.active-item-btn.cooldown {
  border-color: rgba(200,60,60,0.5);
  color: #c07050;
}
.active-item-btn.selected {
  border-color: rgba(100,255,100,0.9);
  background: rgba(40,80,40,0.9);
  color: #aaffaa;
  box-shadow: 0 0 8px rgba(100,255,100,0.4);
  animation: selectedPulse 0.8s ease-in-out infinite alternate;
}
@keyframes selectedPulse {
  0% { box-shadow: 0 0 6px rgba(100,255,100,0.3); }
  100% { box-shadow: 0 0 12px rgba(100,255,100,0.6); }
}
#game-container.item-selected { cursor: crosshair; }

/* Screens */
.screen-overlay {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 200;
  background: rgba(15,12,10,0.88);
  color: #f0ece8;
}
.screen-overlay h1 {
  font-size: 40px;
  margin-bottom: 14px;
  letter-spacing: 2px;
  text-shadow: 0 2px 8px rgba(0,0,0,0.5);
}
.screen-overlay p { font-size: 19px; margin-bottom: 8px; text-align: center; line-height: 1.6; color: #d8d0c8; }
.screen-overlay .subtitle { font-size: 15px; color: #9a9088; margin-bottom: 24px; }
.btn {
  padding: 14px 40px;
  font-size: 20px;
  font-weight: bold;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  margin-top: 16px;
  transition: transform 0.15s, box-shadow 0.15s;
  letter-spacing: 1px;
}
.btn:hover { transform: scale(1.04); box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
.btn-start { background: linear-gradient(180deg, #5a9a5a, #3a7a3a); color: #f0f0e8; }
.btn-retry { background: linear-gradient(180deg, #c06040, #a04830); color: #f0f0e8; }

#title-screen .characters {
  font-size: 64px;
  margin-bottom: 16px;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  gap: 8px;
}
.poop-icon-title {
  width: 48px; height: 52px;
  display: inline-block;
  vertical-align: bottom;
  filter: drop-shadow(1px 2px 4px rgba(0,0,0,0.4));
}

/* Game Over flood */
.flood-poop {
  position: absolute;
  z-index: 190;
  pointer-events: none;
  animation: floodIn 0.5s ease-out forwards;
  filter: drop-shadow(1px 2px 4px rgba(0,0,0,0.4));
}
.flood-poop svg {
  width: 100%;
  height: 100%;
  display: block;
}
@keyframes floodIn {
  0% { opacity: 0; transform: scale(0) rotate(-30deg); }
  100% { opacity: 1; transform: scale(1) rotate(0deg); }
}

/* Stage indicator */
#stage-indicator {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  font-size: 36px;
  font-weight: bold;
  color: #fff;
  text-shadow: 2px 2px 8px rgba(0,0,0,0.8);
  z-index: 150;
  animation: stageIn 2s ease-out forwards;
  pointer-events: none;
}
@keyframes stageIn {
  0% { opacity: 0; transform: translate(-50%,-50%) scale(2); }
  20% { opacity: 1; transform: translate(-50%,-50%) scale(1); }
  80% { opacity: 1; }
  100% { opacity: 0; }
}

/* Room backgrounds */
#room-living {
  background:
    linear-gradient(180deg, #f5e6d3 0%, #ecdcc5 55%, transparent 55%),
    linear-gradient(180deg, transparent 55%, #c9a96e 55%, #b89860 100%);
  background-color: #f5e6d3;
}
/* Living room wall detail: wainscoting */
#room-living::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 55%;
  background:
    repeating-linear-gradient(90deg, transparent 0px, transparent 198px, rgba(0,0,0,0.04) 198px, rgba(0,0,0,0.04) 200px),
    linear-gradient(180deg, rgba(255,255,255,0.15) 0%, transparent 30%, transparent 65%, rgba(0,0,0,0.08) 100%);
  border-bottom: 6px solid #a0845a;
  z-index: 1;
}
/* Living room baseboard */
#room-living::after {
  content: '';
  position: absolute;
  bottom: 48px; left: 0; right: 0;
  height: 8px;
  background: linear-gradient(180deg, #8B7355, #6d5a42);
  z-index: 1;
}

#room-kitchen {
  background:
    linear-gradient(180deg, #f0f4f0 0%, #e8ece8 55%, transparent 55%),
    linear-gradient(180deg, transparent 55%, #d4c8b0 55%, #c4b8a0 100%);
  background-color: #f0f4f0;
}
/* Kitchen wall tiles */
#room-kitchen::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 55%;
  background:
    repeating-linear-gradient(0deg, transparent 0px, transparent 38px, rgba(180,200,180,0.3) 38px, rgba(180,200,180,0.3) 40px),
    repeating-linear-gradient(90deg, transparent 0px, transparent 38px, rgba(180,200,180,0.3) 38px, rgba(180,200,180,0.3) 40px),
    linear-gradient(180deg, rgba(255,255,255,0.2) 0%, transparent 40%);
  z-index: 1;
}
#room-kitchen::after {
  content: '';
  position: absolute;
  bottom: 48px; left: 0; right: 0;
  height: 6px;
  background: #9a8a7a;
  z-index: 1;
}

#room-bedroom {
  background:
    linear-gradient(180deg, #e8e0f0 0%, #ddd4ea 55%, transparent 55%),
    linear-gradient(180deg, transparent 55%, #c0b0a0 55%, #b0a090 100%);
  background-color: #e8e0f0;
}
/* Bedroom wall: subtle stripe wallpaper */
#room-bedroom::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 55%;
  background:
    repeating-linear-gradient(90deg, transparent 0px, transparent 30px, rgba(200,180,220,0.2) 30px, rgba(200,180,220,0.2) 32px),
    linear-gradient(180deg, rgba(255,255,255,0.1) 0%, transparent 50%);
  z-index: 1;
}
#room-bedroom::after {
  content: '';
  position: absolute;
  bottom: 48px; left: 0; right: 0;
  height: 6px;
  background: #8a7a90;
  z-index: 1;
}

#room-garden { background: linear-gradient(180deg, #87CEEB 0%, #a8d8ea 35%, #6dbd5a 40%, #4a8f3a 100%); }
/* Garden: clouds */
#room-garden::before {
  content: '';
  position: absolute;
  top: 40px; left: 80px;
  width: 120px; height: 40px;
  background: rgba(255,255,255,0.7);
  border-radius: 40px;
  box-shadow:
    200px 20px 0 10px rgba(255,255,255,0.5),
    450px -10px 0 5px rgba(255,255,255,0.6),
    350px 30px 0 15px rgba(255,255,255,0.4);
  z-index: 1;
}

/* Furniture */
.furniture {
  position: absolute;
  z-index: 5;
  pointer-events: none;
}

/* ---- Living Room ---- */
.sofa {
  bottom: 80px; left: 40px;
  width: 200px; height: 90px;
  background: linear-gradient(180deg, #6d3a1a, #8B4513 30%, #7a3c14 100%);
  border-radius: 18px 18px 6px 6px;
  border: 3px solid #5a2e10;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3), inset 0 -4px 8px rgba(0,0,0,0.15);
}
.sofa::before {
  content: ''; position: absolute;
  bottom: 4px; left: 12px;
  width: 80px; height: 55px;
  background: linear-gradient(135deg, #c47a4a, #a0623a);
  border-radius: 10px;
  box-shadow: 92px 0 0 0 #a0623a;
}
.sofa::after {
  content: ''; position: absolute;
  bottom: -10px; left: 15px;
  width: 12px; height: 10px;
  background: #4a2a0a;
  border-radius: 0 0 3px 3px;
  box-shadow: 165px 0 0 0 #4a2a0a;
}
/* Cushions on sofa */
.sofa-cushion {
  bottom: 130px; left: 70px;
  width: 40px; height: 35px;
  background: linear-gradient(135deg, #d4956a, #c47a4a);
  border-radius: 8px;
  border: 2px solid #b06840;
  box-shadow: 55px 5px 0 0 #c8845a;
  transform: rotate(-8deg);
}

.tv-stand {
  bottom: 56px; right: 50px;
  width: 130px; height: 50px;
  background: linear-gradient(180deg, #5a4030, #4a3020);
  border-radius: 4px;
  border: 2px solid #3a2518;
  box-shadow: 0 3px 8px rgba(0,0,0,0.3);
}
.tv-stand::before {
  content: ''; position: absolute;
  top: -65px; left: 10px;
  width: 110px; height: 62px;
  background: linear-gradient(135deg, #1a1a2e, #222);
  border: 3px solid #111;
  border-radius: 4px;
  box-shadow: inset 0 0 30px rgba(50,80,120,0.3), 0 2px 6px rgba(0,0,0,0.4);
}
.tv-stand::after {
  content: ''; position: absolute;
  top: -5px; left: 55px;
  width: 20px; height: 5px;
  background: #333;
  border-radius: 2px;
}

.rug {
  bottom: 10px; left: 50%;
  transform: translateX(-50%);
  width: 280px; height: 35px;
  background: radial-gradient(ellipse, #cd853f 0%, #b8742e 60%, #a06020 100%);
  border-radius: 50%;
  opacity: 0.5;
  box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

/* Side table */
.side-table {
  bottom: 58px; left: 280px;
  width: 55px; height: 55px;
  background: linear-gradient(180deg, #6d5030, #5a4028);
  border-radius: 4px;
  border: 2px solid #4a3420;
  box-shadow: 0 3px 6px rgba(0,0,0,0.2);
}
.side-table::before {
  content: 'ü™¥'; position: absolute;
  top: -28px; left: 50%;
  transform: translateX(-50%);
  font-size: 28px;
}

/* Window */
.window-living {
  top: 60px; right: 180px;
  width: 100px; height: 100px;
  background: linear-gradient(180deg, #a8d8ea 0%, #c8e8f0 100%);
  border: 6px solid #8B7355;
  border-radius: 4px;
  box-shadow: inset 0 0 15px rgba(135,206,235,0.3), 0 2px 8px rgba(0,0,0,0.2);
}
.window-living::before {
  content: ''; position: absolute;
  top: 0; left: 50%;
  width: 4px; height: 100%;
  background: #8B7355;
  transform: translateX(-50%);
}
.window-living::after {
  content: ''; position: absolute;
  top: 50%; left: 0;
  width: 100%; height: 4px;
  background: #8B7355;
  transform: translateY(-50%);
}
/* Curtains */
.curtain-l {
  top: 48px; right: 268px;
  width: 22px; height: 120px;
  background: linear-gradient(90deg, #c49060, #daa878, #c49060);
  border-radius: 4px 0 0 4px;
}
.curtain-r {
  top: 48px; right: 168px;
  width: 22px; height: 120px;
  background: linear-gradient(90deg, #c49060, #daa878, #c49060);
  border-radius: 0 4px 4px 0;
}

/* ---- Kitchen ---- */
.counter {
  bottom: 56px; left: 15px;
  width: 320px; height: 75px;
  background: linear-gradient(180deg, #e8e0d8, #ddd5c8 40%, #c0b0a0 100%);
  border: 2px solid #a09080;
  border-radius: 3px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}
.counter::before {
  content: ''; position: absolute;
  top: 0; left: 0; right: 0;
  height: 8px;
  background: linear-gradient(180deg, #f0e8e0, #e0d8d0);
  border-radius: 3px 3px 0 0;
}
.counter::after {
  content: ''; position: absolute;
  top: 20px; left: 15px;
  width: 60px; height: 45px;
  background: linear-gradient(135deg, #d0d0d0, #bbb);
  border-radius: 5px;
  border: 2px solid #999;
  box-shadow: 80px 0 0 0 #bbb, inset 0 10px 15px rgba(255,255,255,0.3);
}
/* Stove */
.stove {
  bottom: 56px; left: 200px;
  width: 130px; height: 75px;
  background: linear-gradient(180deg, #2a2a2a, #333);
  border: 2px solid #1a1a1a;
  border-radius: 3px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}
.stove::before {
  content: ''; position: absolute;
  top: 12px; left: 15px;
  width: 30px; height: 30px;
  background: radial-gradient(circle, #555 30%, #444 50%, #333 70%);
  border-radius: 50%;
  border: 2px solid #222;
  box-shadow: 55px 0 0 0 #444;
}

.fridge {
  bottom: 56px; right: 30px;
  width: 90px; height: 160px;
  background: linear-gradient(135deg, #e8e8e8 0%, #d8d8d8 50%, #ccc 100%);
  border: 2px solid #b0b0b0;
  border-radius: 6px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.25), inset 2px 0 8px rgba(255,255,255,0.4);
}
.fridge::before {
  content: ''; position: absolute;
  top: 42%; left: 0; right: 0;
  height: 2px;
  background: #a0a0a0;
  box-shadow: 0 1px 0 rgba(255,255,255,0.5);
}
.fridge::after {
  content: ''; position: absolute;
  top: 15%; right: 8px;
  width: 4px; height: 22%;
  background: linear-gradient(180deg, #bbb, #999);
  border-radius: 2px;
  box-shadow: 0 calc(90px) 0 0 #999;
}

.table-k {
  bottom: 70px; left: 400px;
  width: 130px; height: 55px;
  background: linear-gradient(180deg, #c49850, #b08840);
  border-radius: 6px;
  border: 2px solid #907030;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}
.table-k::before {
  content: ''; position: absolute;
  bottom: -30px; left: 10px;
  width: 8px; height: 30px;
  background: #907030;
  border-radius: 0 0 3px 3px;
  box-shadow: 100px 0 0 0 #907030;
}
/* Kitchen window */
.window-kitchen {
  top: 50px; left: 160px;
  width: 120px; height: 90px;
  background: linear-gradient(180deg, #a8d8ea, #c8e8f0);
  border: 5px solid #ddd;
  border-radius: 3px;
  box-shadow: inset 0 0 12px rgba(135,206,235,0.3);
}
.window-kitchen::before {
  content: ''; position: absolute;
  top: 0; left: 50%;
  width: 3px; height: 100%;
  background: #ddd;
  transform: translateX(-50%);
}
/* Kitchen shelf */
.shelf-k {
  top: 80px; right: 140px;
  width: 150px; height: 8px;
  background: linear-gradient(180deg, #b09070, #9a7a60);
  border-radius: 2px;
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
}
.shelf-k::before {
  content: 'ü´ñ'; position: absolute;
  top: -28px; left: 10px;
  font-size: 24px;
}
.shelf-k::after {
  content: 'üç∂'; position: absolute;
  top: -26px; right: 15px;
  font-size: 22px;
}

/* ---- Bedroom ---- */
.bed {
  bottom: 56px; left: 20px;
  width: 220px; height: 110px;
  background: linear-gradient(180deg, #f8f0e8, #e8e0d4);
  border: 4px solid #7a6550;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.25);
}
.bed::before {
  content: ''; position: absolute;
  top: 6px; left: 6px;
  width: 65px; height: 45px;
  background: linear-gradient(135deg, #f5e8d8, #e8d8c8);
  border-radius: 8px;
  border: 2px solid #d0c0a8;
  box-shadow: 80px 5px 0 0 #e8d8c8;
}
.bed::after {
  content: ''; position: absolute;
  top: 10px; left: 0; right: 0;
  height: 60px;
  background: linear-gradient(180deg, rgba(180,160,200,0.3), rgba(160,140,180,0.5));
  border-radius: 6px;
  z-index: 1;
}
/* Headboard */
.headboard {
  bottom: 128px; left: 20px;
  width: 220px; height: 50px;
  background: linear-gradient(180deg, #6a5540, #7a6550, #6a5540);
  border-radius: 8px 8px 0 0;
  border: 3px solid #5a4530;
  box-shadow: 0 -2px 6px rgba(0,0,0,0.15);
}

.desk {
  bottom: 56px; right: 30px;
  width: 150px; height: 72px;
  background: linear-gradient(180deg, #c49850, #b08840);
  border: 2px solid #907030;
  border-radius: 4px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}
.desk::before {
  content: ''; position: absolute;
  top: -45px; left: 25px;
  width: 70px; height: 44px;
  background: linear-gradient(135deg, #2a2a3a, #333);
  border: 3px solid #1a1a2a;
  border-radius: 3px 3px 0 0;
  box-shadow: inset 0 0 20px rgba(80,120,200,0.15);
}
.desk::after {
  content: ''; position: absolute;
  bottom: -25px; left: 12px;
  width: 8px; height: 25px;
  background: #907030;
  box-shadow: 118px 0 0 0 #907030;
}

.closet {
  bottom: 56px; left: 290px;
  width: 110px; height: 160px;
  background: linear-gradient(135deg, #deb887, #c8a870);
  border: 3px solid #a08050;
  border-radius: 4px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2), inset -3px 0 8px rgba(0,0,0,0.1);
}
.closet::before {
  content: ''; position: absolute;
  top: 0; left: 50%;
  width: 3px; height: 100%;
  background: #a08050;
  transform: translateX(-50%);
}
.closet::after {
  content: ''; position: absolute;
  top: 45%; left: 22px;
  width: 6px; height: 6px;
  background: #886830;
  border-radius: 50%;
  box-shadow: 54px 0 0 0 #886830;
}

/* Bedroom window */
.window-bedroom {
  top: 50px; left: 440px;
  width: 90px; height: 90px;
  background: linear-gradient(180deg, #c0b8e0, #d8d0f0);
  border: 5px solid #9080a0;
  border-radius: 3px;
  box-shadow: inset 0 0 10px rgba(180,160,220,0.3);
}
.window-bedroom::before {
  content: ''; position: absolute;
  top: 0; left: 50%;
  width: 3px; height: 100%;
  background: #9080a0;
  transform: translateX(-50%);
}
/* Nightstand */
.nightstand {
  bottom: 56px; left: 248px;
  width: 40px; height: 50px;
  background: linear-gradient(180deg, #7a6550, #6a5540);
  border-radius: 3px;
  border: 2px solid #5a4530;
  box-shadow: 0 3px 6px rgba(0,0,0,0.2);
}
.nightstand::before {
  content: 'üïê'; position: absolute;
  top: -22px; left: 50%;
  transform: translateX(-50%);
  font-size: 18px;
}

/* ---- Garden ---- */
.tree {
  bottom: 120px; left: 60px;
  width: 20px; height: 80px;
  background: linear-gradient(90deg, #6B3410, #8B4513, #6B3410);
  border-radius: 4px;
}
.tree::before {
  content: ''; position: absolute;
  top: -55px; left: 50%;
  transform: translateX(-50%);
  width: 90px; height: 70px;
  background: radial-gradient(ellipse at 50% 60%, #3a8a2a, #2a6a1a 70%);
  border-radius: 50%;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}
.tree::after {
  content: ''; position: absolute;
  top: -35px; left: -25px;
  width: 60px; height: 50px;
  background: radial-gradient(ellipse, #4a9a3a, #3a7a2a 70%);
  border-radius: 50%;
}
.flower1 { bottom: 130px; right: 100px; font-size: 36px; }
.flower1::before { content: 'üåª'; }
.flower2 { bottom: 145px; right: 200px; font-size: 28px; }
.flower2::before { content: 'üå∑'; }
.flower3 { bottom: 125px; right: 300px; font-size: 24px; }
.flower3::before { content: 'üå∏'; }
.fence {
  bottom: 100px; left: 0; right: 0;
  height: 35px;
  background:
    repeating-linear-gradient(90deg, #deb887 0px, #deb887 18px, transparent 18px, transparent 24px);
  border-top: 5px solid #b8860b;
  border-bottom: 3px solid #a07a08;
  opacity: 0.55;
}
/* Garden path */
.garden-path {
  bottom: 48px; left: 300px;
  width: 100px; height: 55px;
  background: repeating-linear-gradient(
    0deg,
    #c8b89a 0px, #c8b89a 10px,
    #b8a88a 10px, #b8a88a 12px
  );
  border-radius: 50%;
  opacity: 0.5;
}

/* ---- „Åó„Åæ„Åï„ÅÆÈÉ®Â±ã (Japanese room) ---- */
#room-shimasa {
  background:
    linear-gradient(180deg, #e8dcc8 0%, #e0d0b8 55%, transparent 55%),
    linear-gradient(180deg, transparent 55%, #7a9b5f 55%, #6a8b4f 100%);
  background-color: #e8dcc8;
}
#room-shimasa::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 55%;
  background:
    repeating-linear-gradient(180deg, transparent 0px, transparent 19px, rgba(139,115,85,0.08) 19px, rgba(139,115,85,0.08) 20px),
    linear-gradient(180deg, rgba(255,255,255,0.1) 0%, transparent 40%);
  z-index: 1;
}
#room-shimasa::after {
  content: '';
  position: absolute;
  bottom: calc(45% - 4px); left: 0; right: 0;
  height: 8px;
  background: linear-gradient(180deg, #8b7355, #6d5a42);
  z-index: 1;
}
.zataku {
  bottom: 100px; left: 50%; transform: translateX(-50%);
  width: 180px; height: 45px;
  background: linear-gradient(180deg, #5d4037, #4e342e);
  border-radius: 4px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.3);
  border: 2px solid #3e2723;
}
.zataku::after {
  content: ''; position: absolute;
  bottom: -8px; left: 15px;
  width: 10px; height: 8px;
  background: #4e342e;
  border-radius: 0 0 2px 2px;
  box-shadow: 140px 0 0 0 #4e342e;
}
.zabuton1 {
  bottom: 80px; left: 240px;
  width: 50px; height: 50px;
  background: radial-gradient(circle, #d32f2f, #b71c1c);
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.25);
}
.zabuton2 {
  bottom: 80px; right: 240px;
  width: 50px; height: 50px;
  background: radial-gradient(circle, #d32f2f, #b71c1c);
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.25);
}
.tv-shimasa {
  bottom: 270px; left: 50px;
  width: 90px; height: 55px;
  background: linear-gradient(135deg, #1a1a2e, #222);
  border: 3px solid #424242;
  border-radius: 4px;
  box-shadow: inset 0 0 20px rgba(50,80,120,0.3), 0 2px 6px rgba(0,0,0,0.4);
}
.tv-shimasa::after {
  content: ''; position: absolute;
  bottom: -15px; left: 50%; transform: translateX(-50%);
  width: 70px; height: 14px;
  background: linear-gradient(180deg, #6d4c41, #5d3c31);
  border-radius: 2px;
}
.shoji {
  top: 50px; right: 50px;
  width: 130px; height: 200px;
  background: #f5f0e8;
  border: 5px solid #5d4037;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}
.shoji::before {
  content: ''; position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background:
    repeating-linear-gradient(90deg, #5d4037 0px, #5d4037 2px, transparent 2px, transparent 42px),
    repeating-linear-gradient(180deg, #5d4037 0px, #5d4037 2px, transparent 2px, transparent 65px);
}

/* ---- „Åà„ÅÑ„Åì„ÅÆÈÉ®Â±ã (Eiko's messy room) ---- */
#room-eiko-room {
  background:
    linear-gradient(180deg, #4a4458 0%, #3e3850 55%, transparent 55%),
    linear-gradient(180deg, transparent 55%, #3d2f2f 55%, #352828 100%);
  background-color: #4a4458;
}
#room-eiko-room::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 55%;
  background:
    radial-gradient(circle at 20% 30%, rgba(80,60,50,0.3) 0%, transparent 3%),
    radial-gradient(circle at 60% 70%, rgba(60,50,60,0.25) 0%, transparent 4%),
    radial-gradient(circle at 80% 20%, rgba(70,60,50,0.2) 0%, transparent 2%),
    repeating-linear-gradient(95deg, transparent 0px, transparent 40px, rgba(0,0,0,0.08) 40px, rgba(0,0,0,0.08) 42px);
  z-index: 1;
}
#room-eiko-room::after {
  content: '';
  position: absolute;
  bottom: calc(45% - 4px); left: 0; right: 0;
  height: 6px;
  background: #2a2020;
  z-index: 1;
}
.bed-eiko {
  bottom: 260px; left: 40px;
  width: 160px; height: 80px;
  background: linear-gradient(135deg, #5e4a56, #4e3a46);
  border-radius: 4px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.4);
  border: 2px solid #3e2a36;
}
.bed-eiko::before {
  content: ''; position: absolute;
  top: 5px; left: 10px;
  width: 140px; height: 50px;
  background: linear-gradient(135deg, #7d5a6f, #6d4a5f);
  border-radius: 6px;
  transform: skewY(-2deg);
}
.bed-eiko::after {
  content: ''; position: absolute;
  bottom: -8px; left: 8px;
  width: 12px; height: 8px;
  background: #3d2a35;
  border-radius: 0 0 2px 2px;
  box-shadow: 130px 0 0 0 #3d2a35;
}
.dresser {
  bottom: 260px; right: 80px;
  width: 100px; height: 75px;
  background: linear-gradient(180deg, #4a3f35, #3a2f25);
  border-radius: 4px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.4);
  border: 2px solid #2a1f15;
}
.dresser::before {
  content: ''; position: absolute;
  top: -50px; left: 50%; transform: translateX(-50%);
  width: 70px; height: 48px;
  background: rgba(180,180,200,0.12);
  border: 3px solid #3a3a3a;
  border-radius: 40px 40px 4px 4px;
}
.bookshelf-eiko {
  top: 60px; right: 30px;
  width: 90px; height: 160px;
  background: #3e2f2a;
  border: 2px solid #2a1f1a;
  box-shadow: 0 4px 8px rgba(0,0,0,0.4);
}
.bookshelf-eiko::before {
  content: ''; position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background:
    repeating-linear-gradient(180deg, transparent 0px, transparent 38px, #2a1f1a 38px, #2a1f1a 40px),
    repeating-linear-gradient(180deg,
      #8b4513 0px, #8b4513 12px, #6b8e23 12px, #6b8e23 22px,
      #4682b4 22px, #4682b4 30px, transparent 30px, transparent 40px);
}
.clothes-pile {
  bottom: 100px; left: 280px;
  width: 80px; height: 35px;
  background: linear-gradient(135deg, #6b5b6f, #8b6b7f, #5b4b5f);
  border-radius: 50% 60% 40% 55%;
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  transform: rotate(-5deg);
}
.clothes-pile::after {
  content: ''; position: absolute;
  top: -8px; left: 20px;
  width: 40px; height: 20px;
  background: #7a6a4a;
  border-radius: 50%;
  transform: rotate(10deg);
}

/* ---- Additional Living Room furniture ---- */
.floor-lamp {
  bottom: 56px; right: 220px;
  width: 14px; height: 110px;
  background: linear-gradient(90deg, #8a7a6a, #9a8a7a, #8a7a6a);
  border-radius: 2px;
}
.floor-lamp::before {
  content: ''; position: absolute;
  top: -30px; left: 50%; transform: translateX(-50%);
  width: 40px; height: 30px;
  background: linear-gradient(180deg, #f5e6c8, #e8d4a8);
  border-radius: 50% 50% 40% 40%;
  border: 2px solid #d4c098;
  box-shadow: 0 0 15px rgba(255,230,150,0.4);
}
.floor-lamp::after {
  content: ''; position: absolute;
  bottom: -4px; left: 50%; transform: translateX(-50%);
  width: 28px; height: 5px;
  background: #6a5a4a;
  border-radius: 3px;
}
.magazine-rack {
  bottom: 56px; left: 350px;
  width: 40px; height: 38px;
  background: linear-gradient(180deg, #7a6a5a, #6a5a4a);
  border-radius: 3px;
  border: 2px solid #5a4a3a;
}
.magazine-rack::before {
  content: ''; position: absolute;
  top: 2px; left: 3px;
  width: 12px; height: 30px;
  background: linear-gradient(135deg, #e74c3c, #c0392b);
  border-radius: 1px;
  transform: rotate(-8deg);
  box-shadow: 8px 2px 0 #3498db, 16px 1px 0 #f1c40f;
}
.wall-clock {
  top: 70px; left: 120px;
  width: 45px; height: 45px;
  background: radial-gradient(circle, #fff 60%, #e8e0d0 80%, #c8b89a 100%);
  border-radius: 50%;
  border: 3px solid #8B7355;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}
.wall-clock::before {
  content: ''; position: absolute;
  top: 50%; left: 50%;
  width: 2px; height: 14px;
  background: #333;
  transform-origin: bottom center;
  transform: translate(-50%, -100%) rotate(30deg);
}
.wall-clock::after {
  content: ''; position: absolute;
  top: 50%; left: 50%;
  width: 1.5px; height: 10px;
  background: #333;
  transform-origin: bottom center;
  transform: translate(-50%, -100%) rotate(-60deg);
}

/* ---- Additional Kitchen furniture ---- */
.dish-rack {
  top: 80px; left: 40px;
  width: 80px; height: 8px;
  background: linear-gradient(180deg, #b09070, #9a7a60);
  border-radius: 2px;
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
}
.dish-rack::before {
  content: 'üçΩÔ∏è'; position: absolute;
  top: -28px; left: 8px;
  font-size: 22px;
}
.dish-rack::after {
  content: '‚òï'; position: absolute;
  top: -26px; right: 8px;
  font-size: 20px;
}
.kitchen-mat {
  bottom: 10px; left: 180px;
  width: 140px; height: 25px;
  background: linear-gradient(90deg, #c0392b, #e74c3c, #c0392b);
  border-radius: 4px;
  opacity: 0.35;
}
.rice-cooker {
  bottom: 132px; left: 345px;
  width: 36px; height: 28px;
  background: linear-gradient(180deg, #e0e0e0, #ccc);
  border-radius: 6px 6px 2px 2px;
  border: 2px solid #aaa;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.rice-cooker::before {
  content: ''; position: absolute;
  top: -6px; left: 50%; transform: translateX(-50%);
  width: 28px; height: 6px;
  background: #bbb;
  border-radius: 3px 3px 0 0;
}
.rice-cooker::after {
  content: ''; position: absolute;
  top: 8px; left: 50%; transform: translateX(-50%);
  width: 6px; height: 3px;
  background: #e74c3c;
  border-radius: 2px;
  box-shadow: 0 0 4px rgba(231,76,60,0.6);
}

/* ---- Additional Shimasa Room furniture ---- */
.kakejiku {
  top: 60px; left: 220px;
  width: 50px; height: 100px;
  background: linear-gradient(180deg, #f5f0e0, #e8e0d0);
  border: 2px solid #8b7355;
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
}
.kakejiku::before {
  content: 'Â±±'; position: absolute;
  top: 25px; left: 50%; transform: translateX(-50%);
  font-size: 28px;
  color: #555;
  font-family: serif;
}
.kakejiku::after {
  content: ''; position: absolute;
  bottom: -8px; left: 50%; transform: translateX(-50%);
  width: 36px; height: 5px;
  background: #6d5a42;
  border-radius: 2px;
}
.tansu {
  bottom: 200px; right: 60px;
  width: 100px; height: 80px;
  background: linear-gradient(180deg, #5d4037, #4e342e);
  border: 2px solid #3e2723;
  border-radius: 3px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}
.tansu::before {
  content: ''; position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background:
    repeating-linear-gradient(180deg, transparent 0px, transparent 24px, #3e2723 24px, #3e2723 26px);
}
.tansu::after {
  content: ''; position: absolute;
  top: 10px; left: 50%; transform: translateX(-50%);
  width: 8px; height: 8px;
  background: #886830;
  border-radius: 50%;
  box-shadow: 0 26px 0 #886830, 0 52px 0 #886830;
}
.bonsai {
  bottom: 148px; left: 50px;
  width: 1px; height: 1px;
}
.bonsai::before {
  content: 'üå≥'; position: absolute;
  font-size: 28px;
  top: -15px; left: -14px;
}
.bonsai::after {
  content: ''; position: absolute;
  top: 16px; left: -12px;
  width: 24px; height: 10px;
  background: linear-gradient(180deg, #8b5e3c, #6d4c33);
  border-radius: 4px 4px 2px 2px;
  border: 1px solid #5a3e2a;
}

/* ---- Additional Eiko Room furniture ---- */
.small-table-eiko {
  bottom: 140px; left: 220px;
  width: 70px; height: 35px;
  background: linear-gradient(180deg, #4a3f35, #3a2f25);
  border-radius: 4px;
  border: 2px solid #2a1f15;
  box-shadow: 0 3px 6px rgba(0,0,0,0.3);
}
.small-table-eiko::before {
  content: ''; position: absolute;
  bottom: -16px; left: 6px;
  width: 6px; height: 16px;
  background: #3a2f25;
  border-radius: 0 0 2px 2px;
  box-shadow: 50px 0 0 0 #3a2f25;
}
.small-table-eiko::after {
  content: '‚òï'; position: absolute;
  top: -22px; left: 10px;
  font-size: 18px;
}
.manga-pile {
  bottom: 100px; right: 50px;
  width: 55px; height: 25px;
  background: linear-gradient(135deg, #e74c3c 0%, #e74c3c 33%, #3498db 33%, #3498db 66%, #f1c40f 66%);
  border-radius: 2px;
  transform: rotate(-3deg);
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}
.manga-pile::before {
  content: ''; position: absolute;
  top: -10px; left: 8px;
  width: 40px; height: 12px;
  background: linear-gradient(135deg, #27ae60, #2ecc71);
  border-radius: 1px;
  transform: rotate(5deg);
}
.stand-light {
  bottom: 56px; left: 420px;
  width: 10px; height: 80px;
  background: linear-gradient(90deg, #333, #444, #333);
  border-radius: 2px;
}
.stand-light::before {
  content: ''; position: absolute;
  top: -18px; left: 50%; transform: translateX(-50%);
  width: 28px; height: 18px;
  background: linear-gradient(180deg, #6a5a8a, #5a4a7a);
  border-radius: 50% 50% 40% 40%;
  border: 2px solid #4a3a6a;
  box-shadow: 0 0 12px rgba(140,100,200,0.3);
}
.stand-light::after {
  content: ''; position: absolute;
  bottom: -3px; left: 50%; transform: translateX(-50%);
  width: 22px; height: 4px;
  background: #222;
  border-radius: 2px;
}

/* Shimasa scold event */
.shimasa-scold {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 22px; font-weight: bold;
  color: #ff6644;
  text-shadow: 2px 2px 6px rgba(0,0,0,0.8);
  background: rgba(0,0,0,0.8);
  padding: 10px 20px;
  border-radius: 10px;
  border: 2px solid rgba(255,100,50,0.6);
  z-index: 160;
  pointer-events: none;
  animation: shimasa-scold-anim 2.5s ease-out forwards;
}
.shimasa-scold svg {
  width: 80px; height: 80px;
  flex-shrink: 0;
}
.shimasa-scold .scold-text {
  white-space: nowrap;
}
@keyframes shimasa-scold-anim {
  0% { opacity: 0; transform: translate(-150%,-50%); }
  8% { opacity: 1; transform: translate(-50%,-50%) scale(1.05); }
  15% { transform: translate(-50%,-50%) scale(1); }
  75% { opacity: 1; }
  100% { opacity: 0; transform: translate(-50%,-50%); }
}
#tom.scolded {
  animation: tom-scolded-shake 0.3s ease-in-out 4;
}
@keyframes tom-scolded-shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-6px) rotate(-5deg); }
  75% { transform: translateX(6px) rotate(5deg); }
}

/* Tom poop animation */
#tom.pooping::after {
  content: 'üí®';
  position: absolute;
  bottom: -5px;
  right: -10px;
  font-size: 20px;
  animation: puffAnim 0.5s ease-out;
}
@keyframes puffAnim {
  0% { opacity: 0; transform: scale(0); }
  50% { opacity: 1; transform: scale(1.2); }
  100% { opacity: 0; transform: scale(0.5) translateY(-10px); }
}

/* Tom facial expressions overlay */
.tom-face-sad, .tom-face-smug, .tom-face-dejected { display: none; }
#tom.caged .tom-face-sad { display: block; }
#tom.pooping .tom-face-smug { display: block; }
#tom.scolded .tom-face-dejected { display: block; }

/* Tom special behaviors */
#tom.dashing { transition: left 0.3s linear, top 0.3s linear !important; }
#tom.hiding { opacity: 0.2; filter: blur(1px); pointer-events: none; }

/* Weather events */
.weather-rain {
  position: absolute; top: 0; left: 0; right: 0; bottom: 0;
  pointer-events: none; z-index: 50;
  background: repeating-linear-gradient(
    transparent, transparent 95%, rgba(150,180,255,0.3) 95%, rgba(150,180,255,0.3) 100%
  );
  background-size: 3px 20px;
  animation: rainFall 0.3s linear infinite;
}
@keyframes rainFall { 0% { background-position: 0 0; } 100% { background-position: 0 20px; } }
.weather-thunder-flash {
  position: absolute; top: 0; left: 0; right: 0; bottom: 0;
  background: white; z-index: 60; pointer-events: none;
  animation: thunderFlash 0.2s ease-out forwards;
}
@keyframes thunderFlash { 0% { opacity: 1; } 100% { opacity: 0; } }

/* Level select */
.level-btns {
  display: flex; gap: 12px; margin-top: 16px;
}
.btn-level {
  padding: 12px 24px;
  font-size: 17px; font-weight: bold;
  border: 2px solid; border-radius: 8px;
  cursor: pointer;
  background: rgba(40,35,28,0.8); color: #e0d8cc;
  transition: transform 0.15s, box-shadow 0.15s;
  letter-spacing: 1px;
}
.btn-level.easy { border-color: rgba(90,160,90,0.7); }
.btn-level.normal { border-color: rgba(200,150,50,0.7); }
.btn-level.hard { border-color: rgba(190,60,50,0.7); }
.btn-level:hover { transform: scale(1.04); box-shadow: 0 3px 10px rgba(0,0,0,0.3); }

/* Cage button hint */
#cage-hint {
  position: absolute;
  top: 48px; right: 10px;
  background: rgba(20,15,10,0.8);
  color: #c8baa8;
  padding: 4px 10px;
  border-radius: 4px;
  font-size: 12px;
  z-index: 100;
  display: none;
  border: 1px solid rgba(100,80,50,0.3);
}
#cage-cooldown-text {
  color: #c07050;
}

/* Shop overlay */
.shop-overlay {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(30,22,15,0.95);
  display: flex; flex-direction: column;
  align-items: center; justify-content: flex-start;
  z-index: 200;
  color: #f0ece4;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding: 18px 0;
}
.shop-title {
  font-size: 26px; font-weight: bold;
  color: #f4e4c1; margin-bottom: 4px;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.7);
}
.shop-stage-info {
  font-size: 13px; color: #a09888; margin-bottom: 6px;
}
.shop-coins {
  font-size: 18px; color: #ffd700; font-weight: bold;
  margin-bottom: 8px;
  text-shadow: 1px 1px 3px rgba(0,0,0,0.6);
}
.shop-items {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 6px;
  max-width: 720px; width: 100%;
  padding: 0 8px;
  margin-bottom: 10px;
}
.shop-item {
  background: rgba(50,40,30,0.9);
  border: 2px solid rgba(120,100,70,0.5);
  border-radius: 8px;
  padding: 6px;
  display: flex; flex-direction: column;
  align-items: center; gap: 2px;
  transition: border-color 0.2s;
}
.shop-item:hover { border-color: rgba(200,160,60,0.6); }
.shop-item-icon { font-size: 24px; }
.shop-item-name { font-size: 11px; font-weight: bold; color: #e8dcc8; }
.shop-item-desc { font-size: 10px; color: #a09888; text-align: center; line-height: 1.3; }
.shop-item-price { font-size: 13px; color: #ffd700; font-weight: bold; }
.shop-item-btn {
  padding: 4px 12px; font-size: 11px; font-weight: bold;
  border: none; border-radius: 5px; cursor: pointer;
  background: linear-gradient(180deg, #5a9a5a, #3a7a3a); color: #f0f0e8;
  transition: transform 0.15s, opacity 0.2s;
}
.shop-item-btn:hover { transform: scale(1.05); }
.shop-item-btn:disabled {
  background: #555; color: #888; cursor: not-allowed; opacity: 0.6;
}
.shop-item-btn.bought {
  background: #4a6a8a; color: #c0d0e0; cursor: default;
}
.shop-item-btn.bought:hover { transform: none; }
.shop-next-btn {
  padding: 10px 30px; font-size: 16px; font-weight: bold;
  background: linear-gradient(180deg, #d4a050, #b08030); color: #1a1510;
  border: 2px solid rgba(200,160,60,0.5); border-radius: 8px;
  cursor: pointer; transition: transform 0.15s;
  letter-spacing: 1px;
  margin-top: 8px;
}
.shop-next-btn:hover { transform: scale(1.04); }
/* Synergy display */
.synergy-active {
  background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,180,0,0.1));
  border: 1px solid rgba(255,215,0,0.5);
  border-radius: 6px; padding: 6px 12px; margin: 6px 0;
  font-size: 13px; color: #ffd700; text-align: center;
}
.synergy-hints {
  display: flex; flex-wrap: wrap; gap: 6px; margin: 6px 0; align-items: center;
  justify-content: center;
}
.synergy-hints-title { font-size: 11px; color: #999; }
.synergy-hint {
  font-size: 11px; color: #777; background: rgba(255,255,255,0.05);
  padding: 2px 6px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.1);
}
.synergy-hint.synergy-ready { color: #bba040; border-color: rgba(255,215,0,0.3); }
.synergy-hint.synergy-active-hint { color: #ffd700; border-color: #ffd700; background: rgba(255,215,0,0.15); }
/* Craft section */
.craft-section {
  margin: 6px 0; padding: 6px 8px;
  background: rgba(100,50,200,0.1); border: 1px solid rgba(150,100,255,0.3);
  border-radius: 8px; max-width: 720px; width: 100%;
}
.craft-title { font-size: 13px; font-weight: bold; color: #c0a0ff; text-align: center; margin-bottom: 4px; }
.craft-recipe {
  display: flex; align-items: center; gap: 6px;
  padding: 4px 6px; margin: 3px 0;
  background: rgba(0,0,0,0.3); border-radius: 6px;
  border: 1px solid rgba(150,100,255,0.2);
  font-size: 11px;
}
.craft-recipe.crafted { opacity: 0.5; }
.craft-ingredients { font-size: 12px; color: #ccc; min-width: 160px; }
.craft-arrow { font-size: 18px; color: #c0a0ff; }
.craft-result-info { flex: 1; }
.craft-result-icon { font-size: 18px; }
.craft-result-name { font-size: 13px; font-weight: bold; color: #e0c0ff; margin-left: 4px; }
.craft-result-desc { font-size: 11px; color: #aaa; margin-top: 2px; }
.craft-btn { background: linear-gradient(180deg, #8a60d0, #6a40b0) !important; color: #fff !important; }
.craft-btn:hover { background: linear-gradient(180deg, #9a70e0, #7a50c0) !important; }
.craft-status { font-size: 11px; color: #888; }
.craft-locked { color: #666; }
.shop-item.crafted-item { border-color: rgba(150,100,255,0.5); }
.shop-item-side { font-size: 10px; color: #e06060; text-align: center; line-height: 1.3; }
.shop-item-type { font-size: 10px; color: #7a9abc; font-weight: bold; margin-top: 2px; }
.shop-item.equipped { border-color: #5a9a5a; box-shadow: 0 0 8px rgba(90,180,90,0.4); }
.shop-item-btn.equipped-btn {
  background: linear-gradient(180deg, #7a4a4a, #5a3030); color: #f0c0c0;
}
.shop-item-btn.equip-btn {
  background: linear-gradient(180deg, #4a7a9a, #305a7a); color: #c0e0f0;
}
.shop-item-btn.sell-btn {
  background: linear-gradient(180deg, #9a4a4a, #7a2a2a); color: #f0d0d0;
  font-size: 11px; padding: 4px 12px; margin-top: 4px;
}
.shop-item-btn.sell-btn:hover { background: linear-gradient(180deg, #b05050, #903030); }
.equip-slots { margin-bottom: 8px; text-align: center; }
.equip-slots-title { font-size: 13px; color: #d4c0a0; margin-bottom: 4px; font-weight: bold; }
.equip-slots-row { display: flex; gap: 10px; justify-content: center; }
.equip-slot {
  width: 120px; height: 48px; border-radius: 8px; display: flex; flex-direction: column;
  align-items: center; justify-content: center; gap: 1px;
  border: 2px dashed rgba(120,100,70,0.5); background: rgba(40,32,24,0.8); cursor: default;
  transition: border-color 0.2s, background 0.2s;
}
.equip-slot.filled { border-style: solid; border-color: #5a9a5a; cursor: pointer; background: rgba(50,60,40,0.8); }
.equip-slot.filled:hover { border-color: #e06060; background: rgba(60,30,30,0.8); }
.equip-slot-icon { font-size: 20px; }
.equip-slot-name { font-size: 11px; color: #c0b8a0; }
.equip-slot-remove { font-size: 9px; color: #e08080; display: none; }
.equip-slot.filled:hover .equip-slot-remove { display: block; }
.equip-slot.filled:hover .equip-slot-name { display: none; }

/* Stage banner */
.stage-banner {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  font-size: 32px; font-weight: bold;
  color: #fff;
  text-shadow: 2px 2px 8px rgba(0,0,0,0.8);
  background: rgba(0,0,0,0.6);
  padding: 16px 40px;
  border-radius: 10px;
  z-index: 160;
  pointer-events: none;
  animation: stageBannerAnim 2.5s ease-out forwards;
}
.stage-banner .stage-num { color: #ffd700; font-size: 38px; }
@keyframes stageBannerAnim {
  0% { opacity: 0; transform: translate(-50%,-50%) scale(1.5); }
  15% { opacity: 1; transform: translate(-50%,-50%) scale(1); }
  75% { opacity: 1; }
  100% { opacity: 0; }
}

/* Spray button in HUD */
#spray-btn {
  padding: 4px 10px; font-size: 12px; font-weight: bold;
  background: linear-gradient(180deg, #5ab0d0, #3a8ab0); color: #fff;
  border: 1px solid rgba(80,160,200,0.5); border-radius: 4px;
  cursor: pointer; display: none;
  transition: transform 0.15s;
}
#spray-btn:hover { transform: scale(1.05); }
#spray-btn:disabled { background: #555; color: #888; cursor: not-allowed; }

/* Active items display */
.active-items {
  position: absolute;
  top: 48px; left: 10px;
  display: flex; gap: 6px;
  z-index: 100;
}
.active-item-icon {
  background: rgba(20,15,10,0.8);
  padding: 2px 6px; border-radius: 4px;
  font-size: 14px;
  border: 1px solid rgba(100,80,50,0.3);
}

/* Golden poop */
.poop.golden {
  filter: drop-shadow(0 0 8px rgba(255,215,0,0.7)) drop-shadow(0 0 16px rgba(255,200,0,0.3));
  animation: goldenAppear 0.5s ease-out, goldenPulse 0.8s ease-in-out 0.5s infinite;
}
.poop.golden:hover {
  filter: drop-shadow(0 0 12px rgba(255,215,0,0.9)) drop-shadow(0 0 20px rgba(255,200,0,0.5));
  transform: scale(1.35);
}
@keyframes goldenAppear {
  0% { transform: scale(0) rotate(-180deg); opacity: 0; }
  60% { transform: scale(1.2) rotate(10deg); opacity: 1; }
  100% { transform: scale(1) rotate(0deg); opacity: 1; }
}
@keyframes goldenPulse {
  0%, 100% { filter: drop-shadow(0 0 8px rgba(255,215,0,0.7)) drop-shadow(0 0 16px rgba(255,200,0,0.3)); }
  50% { filter: drop-shadow(0 0 14px rgba(255,215,0,0.9)) drop-shadow(0 0 24px rgba(255,200,0,0.5)); }
}
/* Golden timer bar */
.golden-timer {
  position: absolute;
  bottom: -6px; left: 0;
  width: 100%; height: 4px;
  background: rgba(0,0,0,0.3);
  border-radius: 2px;
  overflow: hidden;
}
.golden-timer .gt-fill {
  height: 100%; width: 100%;
  background: linear-gradient(90deg, #ffd700, #ffaa00);
  transition: width 0.1s linear;
}
/* Score popup */
.score-popup {
  position: absolute;
  z-index: 30;
  font-size: 14px;
  font-weight: bold;
  color: #c0e0c0;
  text-shadow: 0 1px 4px rgba(0,0,0,0.6);
  pointer-events: none;
  animation: scorePopup 0.7s ease-out forwards;
}
@keyframes scorePopup {
  0% { transform: translateY(0) scale(1); opacity: 1; }
  100% { transform: translateY(-40px) scale(1.3); opacity: 0; }
}
/* Combo counter HUD */
#combo-display {
  position: absolute;
  top: 50px; left: 50%;
  transform: translateX(-50%);
  z-index: 35;
  font-size: 16px;
  font-weight: bold;
  color: #ffd700;
  text-shadow: 0 1px 3px rgba(0,0,0,0.5);
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.2s;
}
#combo-display.active {
  opacity: 0.8;
}
#combo-display.hot {
  color: #ff8844;
}
#combo-display.fire {
  color: #ff4444;
}

/* === Juice / Polish effects === */

/* Tom squat animation before poop */
@keyframes tomSquat {
  0%   { transform: scaleY(1) translateY(0); }
  30%  { transform: scaleY(0.75) translateY(6px); }
  60%  { transform: scaleY(0.75) translateY(6px); }
  80%  { transform: scaleY(1.05) translateY(-2px); }
  100% { transform: scaleY(1) translateY(0); }
}
#tom.squatting svg {
  animation: tomSquat 0.5s ease-in-out;
}

/* Poop drop animation */
@keyframes poopDrop {
  0%   { transform: scale(0.3) translateY(-30px); opacity: 0.5; }
  50%  { transform: scale(1.15) translateY(2px); opacity: 1; }
  70%  { transform: scale(0.95) translateY(-1px); opacity: 1; }
  100% { transform: scale(1) translateY(0); opacity: 1; }
}
.poop.dropping {
  animation: poopDrop 0.4s ease-out !important;
}


/* Cage slam effect */
@keyframes cageSlam {
  0%   { transform: translate(0, 0); }
  25%  { transform: translate(-4px, -3px); }
  50%  { transform: translate(4px, 2px); }
  75%  { transform: translate(-2px, 1px); }
  100% { transform: translate(0, 0); }
}
#game-container.cage-slam {
  animation: cageSlam 0.25s ease-out;
}

/* Enhanced clean effect - replaces single emoji sparkle */
.clean-burst {
  position: absolute;
  pointer-events: none;
  z-index: 16;
  font-size: 14px;
  animation: cleanBurstAnim 0.6s ease-out forwards;
}
@keyframes cleanBurstAnim {
  0%   { transform: scale(0.5); opacity: 1; }
  50%  { transform: scale(1.2); opacity: 0.8; }
  100% { transform: scale(1.5); opacity: 0; }
}

/* Rush mode */
.rush-active {
  animation: rushBorder 0.3s ease-in-out infinite alternate;
}
@keyframes rushBorder {
  0% { box-shadow: inset 0 0 30px rgba(255,60,30,0.15); }
  100% { box-shadow: inset 0 0 60px rgba(255,60,30,0.3); }
}
#rush-banner {
  position: absolute;
  top: 46px; left: 50%;
  transform: translateX(-50%);
  background: linear-gradient(90deg, rgba(180,30,10,0.85), rgba(200,60,20,0.9), rgba(180,30,10,0.85));
  color: #ffd;
  padding: 4px 24px;
  border-radius: 4px;
  font-size: 15px;
  font-weight: bold;
  letter-spacing: 2px;
  z-index: 110;
  display: none;
  animation: rushBannerPulse 0.5s ease-in-out infinite alternate;
  border: 1px solid rgba(255,100,50,0.4);
}
@keyframes rushBannerPulse {
  0% { opacity: 0.8; }
  100% { opacity: 1; }
}

/* Happy end */
.happy-overlay {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  z-index: 200;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  background: rgba(10,8,5,0.92);
  color: #f0ece4;
  animation: happyFadeIn 1s ease-out;
}
@keyframes happyFadeIn {
  0% { opacity: 0; }
  100% { opacity: 1; }
}
.happy-overlay h1 { font-size: 38px; margin-bottom: 10px; color: #ffd700; text-shadow: 0 2px 10px rgba(255,215,0,0.4); }
.happy-overlay p { font-size: 18px; margin-bottom: 6px; color: #d8d0c4; text-align: center; line-height: 1.6; }
.happy-confetti {
  position: absolute;
  width: 8px; height: 8px;
  z-index: 210;
  pointer-events: none;
  animation: confettiFall linear forwards;
  border-radius: 2px;
}
@keyframes confettiFall {
  0% { transform: translateY(-20px) rotate(0deg); opacity: 1; }
  100% { transform: translateY(620px) rotate(720deg); opacity: 0.3; }
}

/* Stage clear rank display */
.rank-display {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  z-index: 180;
  pointer-events: none;
  font-size: 80px;
  font-weight: bold;
  text-shadow: 0 0 20px rgba(0,0,0,0.5);
  animation: rankAppear 1.2s ease-out forwards;
}
@keyframes rankAppear {
  0% { opacity: 0; transform: translate(-50%,-50%) scale(3) rotate(-10deg); }
  20% { opacity: 1; transform: translate(-50%,-50%) scale(1) rotate(2deg); }
  30% { transform: translate(-50%,-50%) scale(1.1) rotate(0deg); }
  40% { transform: translate(-50%,-50%) scale(1); }
  80% { opacity: 1; }
  100% { opacity: 0; transform: translate(-50%,-50%) scale(0.8); }
}
.rank-S { color: #FFD700; text-shadow: 0 0 30px rgba(255,215,0,0.7), 0 0 60px rgba(255,215,0,0.3); }
.rank-A { color: #54a0ff; text-shadow: 0 0 20px rgba(84,160,255,0.6); }
.rank-B { color: #4ecdc4; text-shadow: 0 0 15px rgba(78,205,196,0.5); }
.rank-C { color: #aaa; text-shadow: 0 0 10px rgba(170,170,170,0.4); }
.rank-badge { font-weight: bold; font-size: 28px; margin: 0 6px; }

/* Mess events (trash, scratch, water) */
.mess {
  position: absolute;
  cursor: pointer;
  z-index: 15;
  font-size: 28px;
  transition: transform 0.2s, opacity 0.3s;
  pointer-events: auto;
}
.mess:hover { transform: scale(1.2); }
.mess.cleaned {
  transform: scale(0);
  opacity: 0;
  pointer-events: none;
  transition: transform 0.3s, opacity 0.3s;
}
.mess-trash {
  filter: drop-shadow(0 1px 3px rgba(100,80,0,0.4));
  animation: messFloat 2s ease-in-out infinite;
}
/* Trash can */
.trash-can {
  position: absolute; z-index: 12; font-size: 36px;
  bottom: 30px; right: 30px;
  transition: transform 0.3s;
  pointer-events: none;
}
.trash-can.shaking {
  animation: trashCanShake 0.4s ease-in-out;
}
@keyframes trashCanShake {
  0%, 100% { transform: rotate(0deg); }
  20% { transform: rotate(-15deg); }
  40% { transform: rotate(12deg); }
  60% { transform: rotate(-8deg); }
  80% { transform: rotate(5deg); }
}
@keyframes trashFlyOut {
  0% { transform: scale(0.3); opacity: 0.5; }
  50% { transform: scale(1.1); opacity: 1; }
  100% { transform: scale(1); opacity: 1; }
}
.mess-scratch {
  filter: drop-shadow(0 0 4px rgba(200,50,30,0.5));
  animation: messPulse 1s ease-in-out infinite;
}
.mess-water {
  filter: drop-shadow(0 0 5px rgba(50,120,220,0.5));
  animation: messFloat 1.5s ease-in-out infinite;
}
@keyframes messFloat {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-4px); }
}
@keyframes messPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.1); }
}

/* Lucky event */
.lucky-event-flash {
  position: absolute;
  top: 60px; left: 50%;
  transform: translateX(-50%);
  z-index: 170;
  padding: 8px 24px;
  border-radius: 20px;
  font-size: 20px; font-weight: bold;
  color: #fff;
  background: linear-gradient(90deg, #ff9ff3, #ffd700, #54a0ff, #ff9ff3);
  background-size: 300% 100%;
  animation: luckyFlash 1.5s ease-out forwards, luckyShimmer 0.5s linear infinite;
  pointer-events: none;
  text-shadow: 0 1px 4px rgba(0,0,0,0.4);
  white-space: nowrap;
}
@keyframes luckyFlash {
  0% { opacity: 0; transform: translateX(-50%) scale(0.5); }
  15% { opacity: 1; transform: translateX(-50%) scale(1.1); }
  30% { transform: translateX(-50%) scale(1); }
  80% { opacity: 1; }
  100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
}
@keyframes luckyShimmer {
  0% { background-position: 0% 50%; }
  100% { background-position: 100% 50%; }
}

/* Bad end */
.bad-overlay {
  position: absolute;
  top: 0; left: 0; right: 0; bottom: 0;
  z-index: 200;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  color: #e0d0c0;
  animation: badFadeIn 1.5s ease-out;
}
@keyframes badFadeIn {
  0% { opacity: 0; }
  100% { opacity: 1; }
}
.bad-overlay h1 { font-size: 36px; margin-bottom: 10px; color: #c04030; text-shadow: 0 2px 10px rgba(200,50,30,0.4); }
.bad-overlay p { font-size: 17px; margin-bottom: 6px; color: #a09080; text-align: center; line-height: 1.6; }
.bad-bg {
  position: absolute; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(20,10,5,0.95);
  animation: badBgPulse 2s ease-in-out infinite alternate;
  z-index: -1;
}
@keyframes badBgPulse {
  0% { background: rgba(20,10,5,0.95); }
  100% { background: rgba(40,15,8,0.95); }
}

/* ===== Mobile / Responsive Support ===== */

/* Portrait orientation overlay (controlled by JS) */
#rotate-hint {
  display: none;
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(15,12,10,0.95);
  z-index: 99999;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: #e8dcd0;
  font-family: 'Segoe UI', sans-serif;
  text-align: center;
  gap: 16px;
}
#rotate-hint.visible { display: flex; }
#rotate-hint .rotate-icon {
  font-size: 64px;
  animation: rotatePhone 2s ease-in-out infinite;
}
@keyframes rotatePhone {
  0%, 100% { transform: rotate(0deg); }
  30%, 70% { transform: rotate(90deg); }
}
#rotate-hint p {
  font-size: 20px;
  font-weight: bold;
  letter-spacing: 1px;
}
#rotate-hint .sub {
  font-size: 14px;
  color: #9a9088;
}

/* Mobile styles */
.mobile-mode body,
.mobile-mode {
  overflow: hidden;
  position: fixed;
  width: 100%;
  height: 100%;
}
.mobile-mode #game-container {
  position: fixed;
  left: 50%;
  top: 50%;
  margin: 0;
  border: none;
  border-radius: 0;
}
.mobile-mode .poop {
  width: 44px;
  height: 46px;
  min-width: 44px;
  min-height: 44px;
}
.mobile-mode .room-tab {
  padding: 10px 14px;
  font-size: 13px;
}
.mobile-mode #room-tabs {
  height: 52px;
  gap: 5px;
}
.mobile-mode #hud {
  height: 48px;
  font-size: 14px;
  padding: 0 10px;
}
.mobile-mode .active-item-btn {
  padding: 6px 12px;
  font-size: 15px;
}
.mobile-mode .shop-items {
  grid-template-columns: repeat(2, 1fr);
  gap: 8px;
}
.mobile-mode .shop-item-btn {
  padding: 8px 16px;
  font-size: 13px;
}
.mobile-mode .shop-next-btn {
  padding: 14px 36px;
  font-size: 18px;
}
.mobile-mode .btn {
  padding: 16px 44px;
  font-size: 22px;
}
.mobile-mode .mess {
  font-size: 32px !important;
  min-width: 44px;
  min-height: 44px;
}

/* Touch device: remove hover effects that cause sticky states */
@media (hover: none) {
  .poop:hover {
    transform: none;
    filter: drop-shadow(1px 2px 3px rgba(0,0,0,0.35));
  }
  .room-tab:hover {
    background: rgba(70,60,45,0.7);
  }
  .shop-item:hover {
    border-color: rgba(120,100,70,0.5);
  }
  .equip-slot.filled:hover {
    border-color: #5a9a5a;
    background: rgba(50,60,40,0.8);
  }
  .equip-slot.filled:hover .equip-slot-remove { display: none; }
  .equip-slot.filled:hover .equip-slot-name { display: block; }
}
</style>
</head>
<body>

<!-- Rotate phone hint for portrait mode -->
<div id="rotate-hint">
  <div class="rotate-icon">üì±</div>
  <p>„Çπ„Éû„Éõ„ÇíÊ®™Âêë„Åç„Å´„Åó„Å¶„Å≠ÔºÅ</p>
  <div class="sub">Ê®™Âêë„Åç„Å´„Åô„Çã„Å®„Éï„É´„Çπ„ÇØ„É™„Éº„É≥„ÅßÈÅä„Åπ„Åæ„Åô</div>
</div>

<!-- Dachshund SVG template -->
<svg style="display:none;" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <!-- Realistic poop -->
    <g id="poop-realistic">
      <!-- Puddle / stain underneath -->
      <ellipse cx="16" cy="30" rx="14" ry="4" fill="rgba(80,50,20,0.25)"/>
      <!-- Base mass -->
      <ellipse cx="16" cy="26" rx="11" ry="5.5" fill="#5a3a18"/>
      <ellipse cx="16" cy="25.5" rx="10" ry="5" fill="#6b4420"/>
      <!-- Middle coil -->
      <ellipse cx="16" cy="20" rx="8.5" ry="5" fill="#5a3a18"/>
      <ellipse cx="16" cy="19.5" rx="7.5" ry="4.5" fill="#6b4420"/>
      <!-- Top coil (smaller) -->
      <ellipse cx="16" cy="14.5" rx="6" ry="4" fill="#5a3a18"/>
      <ellipse cx="16" cy="14" rx="5" ry="3.5" fill="#6b4420"/>
      <!-- Tip -->
      <ellipse cx="16" cy="10" rx="3" ry="2.5" fill="#5a3a18"/>
      <ellipse cx="16" cy="9.8" rx="2.2" ry="2" fill="#6b4420"/>
      <!-- Texture ridges / creases -->
      <path d="M8 26 Q10 24 12 26" stroke="#4a2a10" stroke-width="0.6" fill="none" opacity="0.5"/>
      <path d="M18 25 Q21 23 24 25" stroke="#4a2a10" stroke-width="0.6" fill="none" opacity="0.5"/>
      <path d="M10 20 Q12 18 15 20" stroke="#4a2a10" stroke-width="0.5" fill="none" opacity="0.4"/>
      <path d="M17 19 Q20 17 22 19" stroke="#4a2a10" stroke-width="0.5" fill="none" opacity="0.4"/>
      <path d="M12 14 Q14 12 16 14" stroke="#4a2a10" stroke-width="0.4" fill="none" opacity="0.4"/>
      <!-- Wet sheen / highlights -->
      <ellipse cx="12" cy="24" rx="3" ry="1.5" fill="rgba(255,255,255,0.1)"/>
      <ellipse cx="13" cy="18" rx="2.5" ry="1.2" fill="rgba(255,255,255,0.08)"/>
      <ellipse cx="14" cy="13" rx="2" ry="1" fill="rgba(255,255,255,0.08)"/>
      <circle cx="19" cy="22" r="0.8" fill="rgba(255,255,255,0.12)"/>
      <circle cx="11" cy="15" r="0.6" fill="rgba(255,255,255,0.1)"/>
      <!-- Steam / smell lines -->
      <path d="M8 8 Q7 4 9 2" stroke="rgba(120,100,60,0.35)" stroke-width="0.7" fill="none"/>
      <path d="M16 6 Q15 2 17 0" stroke="rgba(120,100,60,0.3)" stroke-width="0.7" fill="none"/>
      <path d="M22 8 Q23 4 21 2" stroke="rgba(120,100,60,0.25)" stroke-width="0.7" fill="none"/>
      <!-- Small particle specks for realism -->
      <circle cx="10" cy="27" r="0.5" fill="#4a2a10" opacity="0.3"/>
      <circle cx="22" cy="25" r="0.4" fill="#4a2a10" opacity="0.3"/>
      <circle cx="8" cy="22" r="0.3" fill="#4a2a10" opacity="0.25"/>
      <circle cx="21" cy="17" r="0.4" fill="#4a2a10" opacity="0.2"/>
    </g>
    <!-- Golden poop -->
    <g id="poop-golden">
      <ellipse cx="16" cy="30" rx="14" ry="4" fill="rgba(200,170,50,0.25)"/>
      <ellipse cx="16" cy="26" rx="11" ry="5.5" fill="#b8960a"/>
      <ellipse cx="16" cy="25.5" rx="10" ry="5" fill="#d4aa20"/>
      <ellipse cx="16" cy="20" rx="8.5" ry="5" fill="#b8960a"/>
      <ellipse cx="16" cy="19.5" rx="7.5" ry="4.5" fill="#d4aa20"/>
      <ellipse cx="16" cy="14.5" rx="6" ry="4" fill="#b8960a"/>
      <ellipse cx="16" cy="14" rx="5" ry="3.5" fill="#d4aa20"/>
      <ellipse cx="16" cy="10" rx="3" ry="2.5" fill="#b8960a"/>
      <ellipse cx="16" cy="9.8" rx="2.2" ry="2" fill="#d4aa20"/>
      <path d="M8 26 Q10 24 12 26" stroke="#9a7a08" stroke-width="0.6" fill="none" opacity="0.5"/>
      <path d="M18 25 Q21 23 24 25" stroke="#9a7a08" stroke-width="0.6" fill="none" opacity="0.5"/>
      <path d="M10 20 Q12 18 15 20" stroke="#9a7a08" stroke-width="0.5" fill="none" opacity="0.4"/>
      <ellipse cx="12" cy="24" rx="3" ry="1.5" fill="rgba(255,255,200,0.3)"/>
      <ellipse cx="13" cy="18" rx="2.5" ry="1.2" fill="rgba(255,255,200,0.25)"/>
      <ellipse cx="14" cy="13" rx="2" ry="1" fill="rgba(255,255,200,0.25)"/>
      <circle cx="19" cy="22" r="1" fill="rgba(255,255,240,0.4)"/>
      <circle cx="11" cy="15" r="0.8" fill="rgba(255,255,240,0.35)"/>
      <circle cx="20" cy="13" r="0.6" fill="rgba(255,255,240,0.3)"/>
      <!-- Sparkle rays -->
      <path d="M4 8 L6 10" stroke="#ffe060" stroke-width="1" opacity="0.7"/>
      <path d="M28 6 L26 9" stroke="#ffe060" stroke-width="1" opacity="0.7"/>
      <path d="M16 2 L16 5" stroke="#ffe060" stroke-width="1" opacity="0.7"/>
      <path d="M6 16 L8 17" stroke="#ffe060" stroke-width="0.8" opacity="0.5"/>
      <path d="M26 18 L24 18" stroke="#ffe060" stroke-width="0.8" opacity="0.5"/>
      <circle cx="5" cy="5" r="1" fill="#ffe060" opacity="0.6"/>
      <circle cx="27" cy="3" r="0.8" fill="#ffe060" opacity="0.5"/>
    </g>
    <g id="dachshund">
      <!-- Body -->
      <ellipse cx="40" cy="28" rx="30" ry="12" fill="#8B4513"/>
      <!-- Belly highlight -->
      <ellipse cx="40" cy="32" rx="24" ry="7" fill="#A0522D"/>
      <!-- Chest -->
      <ellipse cx="63" cy="28" rx="10" ry="11" fill="#8B4513"/>
      <!-- Head -->
      <ellipse cx="72" cy="18" rx="11" ry="10" fill="#8B4513"/>
      <!-- Snout -->
      <ellipse cx="82" cy="21" rx="8" ry="5" fill="#9B5523"/>
      <!-- Nose -->
      <ellipse cx="89" cy="20" rx="2.5" ry="2" fill="#222"/>
      <!-- Eye -->
      <circle cx="74" cy="15" r="2.5" fill="#fff"/>
      <circle cx="74.5" cy="15" r="1.5" fill="#1a1a1a"/>
      <circle cx="75" cy="14.3" r="0.5" fill="#fff"/>
      <!-- Eyebrow -->
      <path d="M71 12 Q74 10 77 12" stroke="#6B3410" stroke-width="0.8" fill="none"/>
      <!-- Ear -->
      <ellipse cx="67" cy="13" rx="7" ry="12" fill="#7B3A10" transform="rotate(20, 67, 13)"/>
      <ellipse cx="67" cy="14" rx="5" ry="9" fill="#6B2A00" transform="rotate(20, 67, 14)"/>
      <!-- Mouth -->
      <path d="M84 23 Q87 26 89 23" stroke="#5a2a0a" stroke-width="0.6" fill="none"/>
      <!-- Front leg left -->
      <rect x="57" y="35" width="5" height="12" rx="2" fill="#7B3A10"/>
      <ellipse cx="59.5" cy="47" rx="3.5" ry="1.5" fill="#6B2A00"/>
      <!-- Front leg right -->
      <rect x="63" y="35" width="5" height="12" rx="2" fill="#8B4513"/>
      <ellipse cx="65.5" cy="47" rx="3.5" ry="1.5" fill="#7B3A10"/>
      <!-- Back leg left -->
      <rect x="16" y="34" width="5.5" height="12" rx="2" fill="#7B3A10"/>
      <ellipse cx="18.8" cy="46" rx="3.5" ry="1.5" fill="#6B2A00"/>
      <!-- Back leg right -->
      <rect x="23" y="34" width="5.5" height="12" rx="2" fill="#8B4513"/>
      <ellipse cx="25.8" cy="46" rx="3.5" ry="1.5" fill="#7B3A10"/>
      <!-- Tail -->
      <path d="M10 24 Q4 18 6 10" stroke="#8B4513" stroke-width="3.5" fill="none" stroke-linecap="round"/>
      <!-- Collar -->
      <rect x="63" y="25" width="12" height="3.5" rx="1.5" fill="#cc2222"/>
      <circle cx="69" cy="28.5" r="1.5" fill="#ffcc00"/>
    </g>
    <!-- Eiko: 50s woman, long dark hair, apron, warm friendly face -->
    <g id="eiko-body">
      <!-- Shadow -->
      <ellipse cx="25" cy="78" rx="14" ry="3" fill="rgba(0,0,0,0.13)"/>

      <!-- Left leg -->
      <rect x="18" y="58" width="6" height="17" rx="2.5" fill="#d4a574"/>
      <rect x="17" y="72" width="8" height="5" rx="2.5" fill="#5a3a28"/>
      <!-- Right leg -->
      <rect x="27" y="58" width="6" height="17" rx="2.5" fill="#cea06e"/>
      <rect x="26" y="72" width="8" height="5" rx="2.5" fill="#5a3a28"/>

      <!-- Long hair behind body (behind everything) -->
      <path d="M12 14 Q9 22 7 36 Q6 46 9 52 Q11 47 12 36 Z" fill="#2a2020"/>
      <path d="M38 14 Q41 22 43 36 Q44 46 41 52 Q39 47 38 36 Z" fill="#2a2020"/>
      <!-- Hair behind shoulders -->
      <path d="M9 36 Q8 42 10 48" stroke="#231818" stroke-width="2" fill="none"/>
      <path d="M41 36 Q42 42 40 48" stroke="#231818" stroke-width="2" fill="none"/>

      <!-- Body / blouse (warm burgundy) -->
      <rect x="13" y="30" width="25" height="30" rx="6" fill="#a8486a"/>
      <!-- Collar -->
      <path d="M19 30 Q25 35 31 30" fill="#c06080"/>

      <!-- Apron -->
      <rect x="17" y="35" width="17" height="23" rx="3" fill="#f5f0e8"/>
      <rect x="20" y="30" width="11" height="6" rx="2" fill="#f5f0e8"/>
      <!-- Apron strings -->
      <path d="M17 39 Q10 41 12 35" stroke="#e8e0d0" stroke-width="1.5" fill="none"/>
      <path d="M34 39 Q41 41 39 35" stroke="#e8e0d0" stroke-width="1.5" fill="none"/>
      <!-- Apron pocket -->
      <rect x="21" y="47" width="9" height="6" rx="1.5" fill="#ede8e0" stroke="#ddd5c8" stroke-width="0.5"/>

      <!-- Left arm -->
      <rect x="7" y="32" width="7" height="16" rx="3.5" fill="#a8486a"/>
      <ellipse cx="10.5" cy="49" rx="3.5" ry="3" fill="#d4a574"/>
      <!-- Right arm -->
      <rect x="37" y="32" width="7" height="16" rx="3.5" fill="#a8486a"/>
      <ellipse cx="40.5" cy="49" rx="3.5" ry="3" fill="#d4a574"/>
      <!-- Broom in right hand -->
      <rect x="39" y="22" width="2" height="32" rx="1" fill="#b8860b" transform="rotate(12, 40, 40)"/>
      <path d="M36 18 Q40 16 44 18 Q44 22 40 21 Q36 22 36 18 Z" fill="#8B6914" transform="rotate(12, 40, 20)"/>

      <!-- Neck -->
      <rect x="22" y="26" width="7" height="6" rx="3" fill="#d4a574"/>

      <!-- Head -->
      <ellipse cx="25" cy="17" rx="12.5" ry="13.5" fill="#d4a574"/>

      <!-- Long hair top (swept back, parted) -->
      <ellipse cx="25" cy="9" rx="14" ry="9" fill="#2a2020"/>
      <!-- Hair volume on top -->
      <ellipse cx="25" cy="6" rx="12" ry="5.5" fill="#332828"/>
      <!-- Left side hair -->
      <path d="M11.5 9 Q10 15 10.5 20 Q11 15 12 11 Z" fill="#2a2020"/>
      <!-- Right side hair -->
      <path d="M38.5 9 Q40 15 39.5 20 Q39 15 38 11 Z" fill="#2a2020"/>
      <!-- Hair shine highlights -->
      <path d="M17 5 Q19 3 21 5.5" stroke="rgba(255,255,255,0.12)" stroke-width="1.2" fill="none"/>
      <path d="M29 5 Q31 3 33 5.5" stroke="rgba(255,255,255,0.12)" stroke-width="1.2" fill="none"/>

      <!-- Eyes: almond-shaped, warm brown, gentle expression -->
      <!-- Left eye -->
      <path d="M16.5 18 Q20 14.5 23.5 18 Q20 20 16.5 18 Z" fill="#fff"/>
      <ellipse cx="20" cy="17.8" rx="2.2" ry="2.2" fill="#5a3520"/>
      <circle cx="20" cy="17.8" r="1.4" fill="#2a1508"/>
      <circle cx="20.8" cy="17" r="0.7" fill="rgba(255,255,255,0.85)"/>
      <circle cx="19.2" cy="18.5" r="0.35" fill="rgba(255,255,255,0.5)"/>
      <!-- Upper eyelid line -->
      <path d="M16.5 18 Q20 14.5 23.5 18" stroke="#4a3020" stroke-width="0.7" fill="none"/>
      <!-- Lower lash line (subtle) -->
      <path d="M17 18.3 Q20 19.8 23 18.3" stroke="#8a6a50" stroke-width="0.35" fill="none"/>
      <!-- Eyelashes (a few subtle ones) -->
      <path d="M16.8 17.8 L15.8 17" stroke="#3a2518" stroke-width="0.4" fill="none"/>
      <path d="M17.5 17 L17 16" stroke="#3a2518" stroke-width="0.35" fill="none"/>
      <path d="M23.2 17.8 L24 17" stroke="#3a2518" stroke-width="0.4" fill="none"/>

      <!-- Right eye -->
      <path d="M26.5 18 Q30 14.5 33.5 18 Q30 20 26.5 18 Z" fill="#fff"/>
      <ellipse cx="30" cy="17.8" rx="2.2" ry="2.2" fill="#5a3520"/>
      <circle cx="30" cy="17.8" r="1.4" fill="#2a1508"/>
      <circle cx="30.8" cy="17" r="0.7" fill="rgba(255,255,255,0.85)"/>
      <circle cx="29.2" cy="18.5" r="0.35" fill="rgba(255,255,255,0.5)"/>
      <!-- Upper eyelid line -->
      <path d="M26.5 18 Q30 14.5 33.5 18" stroke="#4a3020" stroke-width="0.7" fill="none"/>
      <!-- Lower lash line -->
      <path d="M27 18.3 Q30 19.8 33 18.3" stroke="#8a6a50" stroke-width="0.35" fill="none"/>
      <!-- Eyelashes -->
      <path d="M26.8 17.8 L26 17" stroke="#3a2518" stroke-width="0.4" fill="none"/>
      <path d="M33.2 17.8 L34.2 17" stroke="#3a2518" stroke-width="0.4" fill="none"/>
      <path d="M32.5 17 L33 16" stroke="#3a2518" stroke-width="0.35" fill="none"/>

      <!-- Eyebrows (natural, gentle arch) -->
      <path d="M16 14.8 Q20 12.8 23.5 14.5" stroke="#4a3828" stroke-width="0.9" fill="none" stroke-linecap="round"/>
      <path d="M26.5 14.5 Q30 12.8 34 14.8" stroke="#4a3828" stroke-width="0.9" fill="none" stroke-linecap="round"/>

      <!-- Nose (soft, natural) -->
      <path d="M25 20 Q23.5 23 24.5 24" stroke="#c08860" stroke-width="0.7" fill="none"/>
      <ellipse cx="25" cy="24" rx="1.8" ry="1" fill="rgba(192,136,96,0.35)"/>

      <!-- Mouth (warm smile with slight parting) -->
      <path d="M21 26.5 Q23 28.5 25 28.8 Q27 28.5 29 26.5" stroke="#b05a4a" stroke-width="0.9" fill="none"/>
      <!-- Upper lip -->
      <path d="M21.5 26.5 Q23 25.8 25 26.2 Q27 25.8 28.5 26.5" stroke="#c06a58" stroke-width="0.5" fill="none"/>
      <!-- Lower lip hint -->
      <ellipse cx="25" cy="28.2" rx="3" ry="1.2" fill="rgba(200,100,90,0.15)"/>

      <!-- Smile lines (subtle, age-appropriate) -->
      <path d="M17 22 Q18.5 25.5 20.5 27" stroke="rgba(180,140,110,0.25)" stroke-width="0.5" fill="none"/>
      <path d="M33 22 Q31.5 25.5 29.5 27" stroke="rgba(180,140,110,0.25)" stroke-width="0.5" fill="none"/>

      <!-- Cheek blush (warm, natural) -->
      <ellipse cx="17" cy="23" rx="3.5" ry="2" fill="rgba(220,130,110,0.2)"/>
      <ellipse cx="33" cy="23" rx="3.5" ry="2" fill="rgba(220,130,110,0.2)"/>

      <!-- Ears (peeking from hair) -->
      <ellipse cx="12.5" cy="19" rx="1.5" ry="2.5" fill="#cda06e"/>
      <ellipse cx="37.5" cy="19" rx="1.5" ry="2.5" fill="#cda06e"/>
    </g>

    <!-- Yoko: 80-year-old grandmother, hunched, cane, white hair -->
    <g id="yoko-body">
      <!-- Shadow -->
      <ellipse cx="25" cy="78" rx="14" ry="3" fill="rgba(0,0,0,0.15)"/>
      <!-- Cane -->
      <rect x="6" y="40" width="2.5" height="36" rx="1" fill="#8B6914"/>
      <path d="M6 40 Q4 36 8 34" stroke="#8B6914" stroke-width="2.5" fill="none" stroke-linecap="round"/>
      <!-- Left leg (slightly bent, elderly posture) -->
      <rect x="19" y="60" width="5.5" height="15" rx="2" fill="#c9986a" transform="rotate(2, 21, 60)"/>
      <rect x="17" y="72" width="8" height="4.5" rx="2" fill="#555"/>
      <!-- Right leg -->
      <rect x="27" y="60" width="5.5" height="15" rx="2" fill="#c0906a" transform="rotate(-2, 29, 60)"/>
      <rect x="26" y="72" width="8" height="4.5" rx="2" fill="#555"/>
      <!-- Body / kimono-style top (slightly hunched) -->
      <path d="M13 32 Q12 46 14 60 L37 60 Q39 46 38 32 Z" rx="5" fill="#7b6898"/>
      <!-- Kimono overlap -->
      <path d="M25 32 L20 60" stroke="#6a5888" stroke-width="1" fill="none"/>
      <!-- Obi (belt) -->
      <rect x="14" y="48" width="23" height="5" rx="2" fill="#c8a84e"/>
      <!-- Left arm (holding cane) -->
      <rect x="7" y="34" width="7" height="14" rx="3" fill="#7b6898"/>
      <circle cx="10" cy="42" r="3" fill="#c9986a"/>
      <!-- Right arm -->
      <rect x="37" y="34" width="7" height="14" rx="3" fill="#7b6898"/>
      <circle cx="40" cy="48" r="3" fill="#c9986a"/>
      <!-- Neck -->
      <rect x="22" y="27" width="7" height="6" rx="2" fill="#c9986a"/>
      <!-- Head (slightly forward, hunched posture) -->
      <ellipse cx="25" cy="18" rx="11" ry="12" fill="#c9986a"/>
      <!-- White/silver permed hair -->
      <ellipse cx="25" cy="11" rx="12.5" ry="10" fill="#d0d0d0"/>
      <circle cx="14" cy="13" r="4.5" fill="#c8c8c8"/>
      <circle cx="36" cy="13" r="4.5" fill="#c8c8c8"/>
      <circle cx="16" cy="17" r="3" fill="#d0d0d0"/>
      <circle cx="34" cy="17" r="3" fill="#d0d0d0"/>
      <circle cx="19" cy="7" r="3" fill="#d8d8d8"/>
      <circle cx="31" cy="7" r="3" fill="#d8d8d8"/>
      <circle cx="25" cy="5" r="3.5" fill="#ddd"/>
      <!-- Wrinkles on forehead -->
      <path d="M18 13 Q25 11.5 32 13" stroke="#b8967a" stroke-width="0.4" fill="none"/>
      <path d="M19 14.5 Q25 13 31 14.5" stroke="#b8967a" stroke-width="0.4" fill="none"/>
      <!-- Eyes (smaller, squinting) -->
      <ellipse cx="20" cy="18" rx="2" ry="1.8" fill="#fff"/>
      <circle cx="20.3" cy="18.2" r="1.1" fill="#2a1a0a"/>
      <circle cx="20.6" cy="17.6" r="0.35" fill="#fff"/>
      <ellipse cx="30" cy="18" rx="2" ry="1.8" fill="#fff"/>
      <circle cx="30.3" cy="18.2" r="1.1" fill="#2a1a0a"/>
      <circle cx="30.6" cy="17.6" r="0.35" fill="#fff"/>
      <!-- Crow's feet wrinkles -->
      <path d="M15 18 L13.5 17" stroke="#b8967a" stroke-width="0.4" fill="none"/>
      <path d="M15 19 L13.5 19.5" stroke="#b8967a" stroke-width="0.4" fill="none"/>
      <path d="M35 18 L36.5 17" stroke="#b8967a" stroke-width="0.4" fill="none"/>
      <path d="M35 19 L36.5 19.5" stroke="#b8967a" stroke-width="0.4" fill="none"/>
      <!-- Eyebrows (thin, sparse) -->
      <path d="M17 15.5 Q20 14.5 23 15.5" stroke="#aaa" stroke-width="0.6" fill="none"/>
      <path d="M27 15.5 Q30 14.5 33 15.5" stroke="#aaa" stroke-width="0.6" fill="none"/>
      <!-- Glasses (round, old-fashioned) -->
      <circle cx="20" cy="18" r="4" stroke="#8B6914" stroke-width="0.8" fill="none"/>
      <circle cx="30" cy="18" r="4" stroke="#8B6914" stroke-width="0.8" fill="none"/>
      <line x1="24" y1="18" x2="26" y2="18" stroke="#8B6914" stroke-width="0.8"/>
      <line x1="16" y1="17.5" x2="13" y2="16" stroke="#8B6914" stroke-width="0.8"/>
      <line x1="34" y1="17.5" x2="37" y2="16" stroke="#8B6914" stroke-width="0.8"/>
      <!-- Nose -->
      <path d="M25 20 Q23.5 22.5 25 24 Q26.5 22.5 25 20" fill="#b8866a"/>
      <!-- Mouth (gentle smile, wrinkle lines) -->
      <path d="M22 26 Q25 28.5 28 26" stroke="#a0523d" stroke-width="0.8" fill="none"/>
      <!-- Nasolabial folds -->
      <path d="M18 22 Q19 25 21 27" stroke="#b8967a" stroke-width="0.4" fill="none"/>
      <path d="M32 22 Q31 25 29 27" stroke="#b8967a" stroke-width="0.4" fill="none"/>
      <!-- Cheek blush -->
      <ellipse cx="17" cy="23" rx="2.5" ry="1.5" fill="rgba(255,130,130,0.25)"/>
      <ellipse cx="33" cy="23" rx="2.5" ry="1.5" fill="rgba(255,130,130,0.25)"/>
    </g>
  </defs>
</svg>

<div id="game-container">
  <!-- HUD -->
  <div id="hud" style="display:none;">
    <div>
      <span class="label">„ÅÜ„Çì„Å°Âç±Èô∫Â∫¶: </span>
      <div id="poop-bar-container"><div id="poop-bar"></div></div>
    </div>
    <div>
      <span class="label">„Çπ„Ç≥„Ç¢: </span><span id="score">0</span>
    </div>
    <div id="timer">60</div>
    <div>
      <span class="label" style="color:#c0884a;">„ÅÜ„Çì„Å°:</span><span id="poop-count">0</span> / <span id="poop-max">20</span>
    </div>
    <div>
      <span class="label" style="color:#6ecf6e;">ÂõûÂèé:</span><span id="cleaned-count">0</span> / <span id="clear-count">10</span>
    </div>
    <button id="spray-btn" style="display:none">üß¥</button>
  </div>

  <!-- Rooms -->
  <div id="room-living" class="room active">
    <div class="furniture window-living"></div>
    <div class="furniture curtain-l"></div>
    <div class="furniture curtain-r"></div>
    <div class="furniture sofa"></div>
    <div class="furniture sofa-cushion"></div>
    <div class="furniture tv-stand"></div>
    <div class="furniture side-table"></div>
    <div class="furniture rug"></div>
    <div class="furniture floor-lamp"></div>
    <div class="furniture magazine-rack"></div>
    <div class="furniture wall-clock"></div>
    <div class="trash-can">üóëÔ∏è</div>
  </div>
  <div id="room-kitchen" class="room">
    <div class="furniture window-kitchen"></div>
    <div class="furniture shelf-k"></div>
    <div class="furniture counter"></div>
    <div class="furniture stove"></div>
    <div class="furniture fridge"></div>
    <div class="furniture table-k"></div>
    <div class="furniture dish-rack"></div>
    <div class="furniture kitchen-mat"></div>
    <div class="furniture rice-cooker"></div>
    <div class="trash-can">üóëÔ∏è</div>
  </div>
  <div id="room-shimasa" class="room">
    <div class="furniture shoji"></div>
    <div class="furniture tv-shimasa"></div>
    <div class="furniture zataku"></div>
    <div class="furniture zabuton1"></div>
    <div class="furniture zabuton2"></div>
    <div class="furniture kakejiku"></div>
    <div class="furniture tansu"></div>
    <div class="furniture bonsai"></div>
    <div class="trash-can">üóëÔ∏è</div>
  </div>
  <div id="room-eiko-room" class="room">
    <div class="furniture bed-eiko"></div>
    <div class="furniture dresser"></div>
    <div class="furniture bookshelf-eiko"></div>
    <div class="furniture clothes-pile"></div>
    <div class="furniture small-table-eiko"></div>
    <div class="furniture manga-pile"></div>
    <div class="furniture stand-light"></div>
    <div class="trash-can">üóëÔ∏è</div>
  </div>

  <!-- Tom & Eiko & Yoko -->
  <div id="tom"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 95 50"><use href="#dachshund"/><g class="tom-face-sad"><rect x="69" y="10" width="22" height="18" fill="#8B4513" rx="3"/><rect x="69" y="17" width="22" height="9" fill="#9B5523" rx="2"/><path d="M72 16 Q74 19 76 16" stroke="#1a1a1a" stroke-width="1.2" fill="none"/><circle cx="77" cy="18" r="1" fill="#5bf"/><circle cx="77.5" cy="20" r="0.7" fill="#5bf" opacity="0.6"/><path d="M71 13 Q74 14 77 13" stroke="#6B3410" stroke-width="0.8" fill="none"/><path d="M84 24 Q87 22 89 24" stroke="#5a2a0a" stroke-width="0.8" fill="none"/></g><g class="tom-face-smug"><rect x="69" y="10" width="22" height="18" fill="#8B4513" rx="3"/><rect x="69" y="17" width="22" height="9" fill="#9B5523" rx="2"/><path d="M72 15 L77 15" stroke="#1a1a1a" stroke-width="1.5" stroke-linecap="round"/><path d="M71 11 Q74 9 77 11" stroke="#6B3410" stroke-width="1" fill="none"/><path d="M83 23 Q86 27 90 23" stroke="#5a2a0a" stroke-width="0.8" fill="none"/><text x="79" y="12" font-size="4" fill="#FFD700">&#x2726;</text></g><g class="tom-face-dejected"><rect x="69" y="10" width="22" height="18" fill="#8B4513" rx="3"/><rect x="69" y="17" width="22" height="9" fill="#9B5523" rx="2"/><path d="M72 16 L76 14" stroke="#1a1a1a" stroke-width="1.2" stroke-linecap="round"/><path d="M72 14 L76 16" stroke="#1a1a1a" stroke-width="1.2" stroke-linecap="round"/><path d="M71 11 Q74 13 77 11" stroke="#6B3410" stroke-width="0.8" fill="none"/><path d="M84 24 Q85.5 22.5 87 24 Q88.5 25.5 89 24" stroke="#5a2a0a" stroke-width="0.7" fill="none"/><path d="M80 11 L80.5 14" stroke="#5bf" stroke-width="0.8" stroke-linecap="round"/></g></svg><div id="cage-timer-bar"><div class="bar-fill"></div></div></div>
  <div id="eiko"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 82"><use href="#eiko-body"/></svg></div>
  <div id="yoko"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 82"><use href="#yoko-body"/></svg></div>
  <div id="cage-hint"><svg class="tom-icon-inline" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 95 50"><use href="#dachshund"/></svg>„Çí„ÇØ„É™„ÉÉ„ÇØ„Åß„Ç±„Éº„Ç∏„Å´ÂÖ•„Çå„ÇãÔºÅ <span id="cage-cooldown-text"></span></div>
  <div id="combo-display"></div>

  <!-- Active Items Display -->
  <div id="active-items" class="active-items" style="display:none;"></div>

  <!-- Shop Screen -->
  <div id="shop-screen" style="display:none;"></div>

  <!-- Title Screen -->
  <div id="title-screen" class="screen-overlay">
    <div class="characters"><svg class="tom-icon-large" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 95 50"><use href="#dachshund"/></svg><svg class="poop-icon-title" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 34"><use href="#poop-realistic"/></svg><svg class="eiko-icon-large" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 82"><use href="#eiko-body"/></svg><svg class="poop-icon-title" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 34"><use href="#poop-realistic"/></svg><svg class="yoko-icon-inline" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 82"><use href="#yoko-body"/></svg></div>
    <h1>„Éà„É†„Å°„ÇÉ„Çì„ÅÆ„ÅÜ„Çì„Å°„Ç≤„Éº„É†</h1>
    <p>Áä¨„ÅÆ„Éà„É†„Å°„ÇÉ„Çì„Åå„ÅÜ„Çì„Å°„Çí„Åô„ÇãÔºÅ<br>
    „Åà„ÅÑ„Åì„Åï„Çì„ÅåÂà∂ÈôêÊôÇÈñìÂÜÖ„Å´ÂÖ®„Å¶Áâá‰ªò„Åë„Çà„ÅÜÔºÅ</p>
    <p class="subtitle">„ÅÜ„Çì„Å°„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶Áâá‰ªò„Åë„Çà„ÅÜÔºÅ<br>üîí „Éà„É†„Å°„ÇÉ„Çì„Çí„ÇØ„É™„ÉÉ„ÇØ„Åß„Ç±„Éº„Ç∏„Å´ÂÖ•„Çå„Å¶„ÅÜ„Çì„Å°„ÇíÈòªÊ≠¢ÔºÅ<br>ÂÖ®4„Çπ„ÉÜ„Éº„Ç∏„Çí„ÇØ„É™„Ç¢„Åó„Çà„ÅÜÔºÅ</p>
    <div class="level-btns">
      <button class="btn-level normal" onclick="startStageGame()">„Ç≤„Éº„É†„Çπ„Çø„Éº„Éà</button>
    </div>
  </div>

  <!-- Game Over Screen (Bad End) -->
  <div id="gameover-screen" style="display:none;"></div>

  <!-- Clear Screen (Happy End) -->
  <div id="clear-screen" style="display:none;"></div>

  <!-- Rush Banner -->
  <div id="rush-banner">RUSH MODE</div>

  <!-- Stage Indicator -->
  <div id="stage-indicator" style="display:none;"></div>
</div>

<script>
// Sound effects using Web Audio API
let audioCtx = null;
function getAudioCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  return audioCtx;
}
function playPikonSound() {
  const ctx = getAudioCtx();
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.connect(gain);
  gain.connect(ctx.destination);
  osc.type = 'sine';
  const now = ctx.currentTime;
  osc.frequency.setValueAtTime(880, now);
  osc.frequency.setValueAtTime(1318.5, now + 0.08);
  gain.gain.setValueAtTime(0.3, now);
  gain.gain.exponentialRampToValueAtTime(0.01, now + 0.25);
  osc.start(now);
  osc.stop(now + 0.25);
}

function playKyainSound() {
  const ctx = getAudioCtx();
  const now = ctx.currentTime;

  // Layer 1: Main yelp - high pitched whine with rapid pitch drop
  const osc1 = ctx.createOscillator();
  const gain1 = ctx.createGain();
  osc1.connect(gain1);
  gain1.connect(ctx.destination);
  osc1.type = 'sawtooth';
  osc1.frequency.setValueAtTime(1800, now);
  osc1.frequency.exponentialRampToValueAtTime(1200, now + 0.06);
  osc1.frequency.exponentialRampToValueAtTime(900, now + 0.15);
  osc1.frequency.exponentialRampToValueAtTime(600, now + 0.35);
  gain1.gain.setValueAtTime(0, now);
  gain1.gain.linearRampToValueAtTime(0.22, now + 0.02);
  gain1.gain.setValueAtTime(0.22, now + 0.05);
  gain1.gain.exponentialRampToValueAtTime(0.01, now + 0.35);
  osc1.start(now);
  osc1.stop(now + 0.38);

  // Layer 2: Breathy/noisy component for realism
  const bufSize = ctx.sampleRate * 0.4;
  const noiseBuf = ctx.createBuffer(1, bufSize, ctx.sampleRate);
  const data = noiseBuf.getChannelData(0);
  for (let i = 0; i < bufSize; i++) {
    data[i] = (Math.random() * 2 - 1) * 0.5;
  }
  const noise = ctx.createBufferSource();
  noise.buffer = noiseBuf;
  const noiseFilter = ctx.createBiquadFilter();
  noiseFilter.type = 'bandpass';
  noiseFilter.frequency.setValueAtTime(2200, now);
  noiseFilter.frequency.exponentialRampToValueAtTime(1000, now + 0.3);
  noiseFilter.Q.value = 3;
  const noiseGain = ctx.createGain();
  noise.connect(noiseFilter);
  noiseFilter.connect(noiseGain);
  noiseGain.connect(ctx.destination);
  noiseGain.gain.setValueAtTime(0, now);
  noiseGain.gain.linearRampToValueAtTime(0.06, now + 0.02);
  noiseGain.gain.exponentialRampToValueAtTime(0.005, now + 0.3);
  noise.start(now);
  noise.stop(now + 0.4);

  // Layer 3: Second harmonic for vocal quality
  const osc2 = ctx.createOscillator();
  const gain2 = ctx.createGain();
  osc2.connect(gain2);
  gain2.connect(ctx.destination);
  osc2.type = 'triangle';
  osc2.frequency.setValueAtTime(2400, now);
  osc2.frequency.exponentialRampToValueAtTime(1600, now + 0.05);
  osc2.frequency.exponentialRampToValueAtTime(1100, now + 0.25);
  gain2.gain.setValueAtTime(0, now);
  gain2.gain.linearRampToValueAtTime(0.08, now + 0.015);
  gain2.gain.exponentialRampToValueAtTime(0.005, now + 0.25);
  osc2.start(now);
  osc2.stop(now + 0.28);

  // Layer 4: Sub "body" of the yelp
  const osc3 = ctx.createOscillator();
  const gain3 = ctx.createGain();
  osc3.connect(gain3);
  gain3.connect(ctx.destination);
  osc3.type = 'sine';
  osc3.frequency.setValueAtTime(800, now);
  osc3.frequency.exponentialRampToValueAtTime(400, now + 0.2);
  gain3.gain.setValueAtTime(0, now);
  gain3.gain.linearRampToValueAtTime(0.1, now + 0.02);
  gain3.gain.exponentialRampToValueAtTime(0.005, now + 0.25);
  osc3.start(now);
  osc3.stop(now + 0.28);

  // Layer 5: Quick vibrato wobble for natural dog voice
  const vibrato = ctx.createOscillator();
  const vibratoGain = ctx.createGain();
  vibrato.connect(vibratoGain);
  vibratoGain.connect(osc1.frequency);
  vibrato.frequency.value = 30;
  vibratoGain.gain.setValueAtTime(80, now + 0.05);
  vibratoGain.gain.linearRampToValueAtTime(0, now + 0.3);
  vibrato.start(now);
  vibrato.stop(now + 0.38);
}

const ROOMS = ['living', 'kitchen', 'shimasa', 'eiko-room'];
const ROOM_NAMES = { living: '„É™„Éì„É≥„Ç∞', kitchen: 'Âè∞ÊâÄ', shimasa: '„Åó„Åæ„Åï„ÅÆÈÉ®Â±ã', 'eiko-room': '„Åà„ÅÑ„Åì„ÅÆÈÉ®Â±ã' };

const STAGES = [
  { room: 'living',    name: '„É™„Éì„É≥„Ç∞',       time: 30, maxPoop: 20, clearCount: 15, poopInterval: [600, 1100],  tomSpeed: 1800, yokoActive: false, mechanic: 'slippery',         peeInterval: null,         slideDist: 50 },
  { room: 'kitchen',   name: 'Âè∞ÊâÄ',           time: 30, maxPoop: 17, clearCount: 20, poopInterval: [450, 900],   tomSpeed: 1400, yokoActive: false, mechanic: 'pee_puddle',       peeInterval: [3500, 6000], slideDist: 0 },
  { room: 'shimasa',   name: '„Åó„Åæ„Åï„ÅÆÈÉ®Â±ã',    time: 30, maxPoop: 14, clearCount: 25, poopInterval: [300, 650],   tomSpeed: 1000, yokoActive: true,  mechanic: 'hidden_poop',      peeInterval: null,         slideDist: 0 },
  { room: 'eiko-room', name: '„Åà„ÅÑ„Åì„ÅÆÈÉ®Â±ã',    time: 30, maxPoop: 15, clearCount: 25, poopInterval: [300, 550],   tomSpeed: 700,  yokoActive: true,  mechanic: 'misclick_penalty', peeInterval: null,         slideDist: 0 },
];

const MAX_EQUIP_SLOTS = 2;

const SHOP_ITEMS = [
  { id: 'overload_vacuum',  name: 'ÈÅéË≤†Ëç∑ÊéÉÈô§Ê©ü',     icon: 'üßπ', desc: '1Áßí„Åî„Å®Ëá™ÂãïÂõûÂèé', side: 'ÂâØ‰ΩúÁî®ÔºöË¶ñÁïå„Åå20%Êöó„Åè„Å™„Çã', price: 80, type: 'passive' },
  { id: 'strong_deodorant', name: 'Âº∑ÂäõÊ∂àËá≠Ââ§',       icon: 'üß¥', desc: '4ÁßíÈñìÁô∫ÁîüÂÅúÊ≠¢', side: 'ÂâØ‰ΩúÁî®ÔºöÁµÇ‰∫ÜÂæå4ÁßíÈñì Áô∫ÁîüÁéá+50%', price: 60, type: 'active' },
  { id: 'tom_chip',         name: '„Éà„É†ÊäëÂà∂„ÉÅ„ÉÉ„Éó',   icon: 'üê∂', desc: 'Áô∫ÁîüÈ†ªÂ∫¶-70%', side: 'ÂâØ‰ΩúÁî®ÔºöÁßªÂãïÈÄüÂ∫¶-10%', price: 90, type: 'passive' },
  { id: 'eiko_awaken',      name: '„Åà„ÅÑ„ÅìË¶öÈÜí„É¢„Éº„Éâ', icon: 'üî•', desc: '7ÁßíÈñìÂõûÂèéÁØÑÂõ≤2ÂÄç+ÁßªÂãïÈÄüÂ∫¶2ÂÄç', side: 'ÂâØ‰ΩúÁî®ÔºöÁµÇ‰∫ÜÂæå1.5ÁßíÈñìÊìç‰Ωú‰∏çËÉΩ', price: 100, type: 'active' },
  { id: 'shimasa_dignity',   name: '„Åó„Åæ„Åï„ÅÆÂ®ÅÂé≥',     icon: 'üë¥', desc: '„Åó„Åæ„ÅïÂè¨Âñö„Åß„Éà„É†5ÁßíÂÅúÊ≠¢+„ÅÜ„Çì„Å°3ÂÄãÊ∂àÊªÖ', side: 'ÂâØ‰ΩúÁî®ÔºöÁµÇ‰∫ÜÂæå„Éà„É†„Åå„Éë„Éã„ÉÉ„ÇØ„Åß2ÂÄã„ÅÜ„Çì„Å°', price: 65, type: 'active' },
  { id: 'evade_cloak',      name: 'Á∑äÊÄ•ÂõûÈÅø„Éû„É≥„Éà',   icon: 'üß•', desc: '„Åä„Åó„Å£„Åì„Çπ„É™„ÉÉ„ÉóÁÑ°Âäπ', side: 'ÂâØ‰ΩúÁî®Ôºö„ÅÜ„Çì„Å°Âà§ÂÆö10%Á∏ÆÂ∞è', price: 70, type: 'passive' },
  { id: 'yoko_medicine',    name: '„Çà„ÅÜ„Åì„ÅÆËñ¨',       icon: 'üíä', desc: '„Çà„ÅÜ„Åì„ÅÜ„Çì„Å°ÁÑ°Âäπ(3Èù¢ÔΩû)', side: 'ÂâØ‰ΩúÁî®ÔºöÂà∂ÈôêÊôÇÈñì10%Âä†ÈÄü', price: 75, type: 'passive' },
  { id: 'tom_snack',        name: '„Éà„É†„ÅÆ„Åä„ÇÑ„Å§',     icon: 'ü¶¥', desc: '„Éà„É†5ÁßíÂÅúÊ≠¢', side: 'ÂâØ‰ΩúÁî®ÔºöÁµÇ‰∫ÜÂæå„ÅÜ„Çì„Å°1ÂÄãËøΩÂä†', price: 55, type: 'active' },
];

// Item Synergies: bonus when 2 specific items are equipped together
const SYNERGIES = [
  { items: ['overload_vacuum', 'evade_cloak'],   name: 'Ëá™ÂãïÊéÉÈô§„Éû„Çπ„Çø„Éº', icon: 'üåü', desc: 'ÊéÉÈô§Ê©ü„ÅÆÈñìÈöî„Åå0.6Áßí„Å´Áü≠Á∏Æ' },
  { items: ['eiko_awaken', 'tom_snack'],         name: 'ÂÖ®Âäõ„ÉÅ„É£„É≥„Çπ',     icon: '‚ö°', desc: 'Ë¶öÈÜíÊôÇÈñì„Åå7Áßí‚Üí10Áßí„Å´Âª∂Èï∑' },
  { items: ['tom_chip', 'yoko_medicine'],         name: 'ÂãïÁâ©Âà∂Âæ°',         icon: 'üîó', desc: '„Éà„É†ÁßªÂãïÈÄüÂ∫¶„Åå„Åï„Çâ„Å´-30%' },
  { items: ['shimasa_dignity', 'strong_deodorant'], name: 'ÊÅêÊÄñÊµÑÂåñ',      icon: 'üíÄ', desc: 'Â®ÅÂé≥„ÅÆÂâØ‰ΩúÁî®„ÅåÂÆåÂÖ®ÁÑ°ÂäπÂåñ' },
];

// Crafting Recipes: combine 2 items into 1 superior item
const CRAFT_RECIPES = [
  { ingredients: ['overload_vacuum', 'tom_chip'], cost: 40,
    result: { id: 'quantum_vacuum', name: 'ÈáèÂ≠êÊéÉÈô§Ê©ü', icon: 'üåÄ', desc: '0.7ÁßíËá™ÂãïÂõûÂèé+Áô∫ÁîüÈ†ªÂ∫¶-50%', side: 'ÂâØ‰ΩúÁî®ÔºöÁßªÂãïÈÄüÂ∫¶-15%+Ë¶ñÁïå10%Êöó', price: 170, type: 'passive' } },
  { ingredients: ['eiko_awaken', 'shimasa_dignity'], cost: 50,
    result: { id: 'eiko_final', name: '„Åà„ÅÑ„ÅìÊúÄÁµÇÂΩ¢ÊÖã', icon: 'üë∏', desc: '10ÁßíË¶öÈÜí+„Éà„É†ÂÅúÊ≠¢+„ÅÜ„Çì„Å°5ÂÄãÊ∂àÊªÖ', side: 'ÂâØ‰ΩúÁî®ÔºöÁµÇ‰∫ÜÂæå2ÁßíÈñìÊìç‰Ωú‰∏çËÉΩ', price: 165, type: 'active' } },
  { ingredients: ['strong_deodorant', 'tom_snack'], cost: 30,
    result: { id: 'total_control', name: 'ÂÆåÂÖ®Âà∂Âúß„Çª„ÉÉ„Éà', icon: 'üéØ', desc: '6ÁßíÁô∫ÁîüÂÅúÊ≠¢+„Éà„É†6ÁßíÂÅúÊ≠¢', side: 'ÂâØ‰ΩúÁî®ÔºöÁµÇ‰∫ÜÂæå4ÁßíÈñìÁô∫ÁîüÁéá+50%', price: 115, type: 'active' } },
  { ingredients: ['evade_cloak', 'yoko_medicine'], cost: 35,
    result: { id: 'full_armor', name: 'ÂÆåÂÖ®Èò≤Ë≠∑Êúç', icon: 'üõ°Ô∏è', desc: '„Çπ„É™„ÉÉ„ÉóÁÑ°Âäπ+„Çà„ÅÜ„ÅìÁÑ°Âäπ+Èö†„Åó„ÅÜ„Çì„Å°Áô∫ÂÖâ', side: 'ÂâØ‰ΩúÁî®ÔºöÁßªÂãïÈÄüÂ∫¶-10%+Âà∂ÈôêÊôÇÈñì-5%Âä†ÈÄü', price: 145, type: 'passive' } },
];

function getActiveSynergy() {
  for (const syn of SYNERGIES) {
    if (syn.items.every(id => state.equippedItems.includes(id))) return syn;
  }
  return null;
}

function getAllItems() {
  return SHOP_ITEMS.concat(CRAFT_RECIPES.map(r => r.result));
}

function findItem(id) {
  return getAllItems().find(i => i.id === id);
}

function createPoopSVG(w, h, golden) {
  const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
  svg.setAttribute('viewBox', '0 0 32 34');
  svg.setAttribute('width', w || 36);
  svg.setAttribute('height', h || 38);
  const use = document.createElementNS('http://www.w3.org/2000/svg', 'use');
  use.setAttribute('href', golden ? '#poop-golden' : '#poop-realistic');
  svg.appendChild(use);
  return svg;
}

// Golden poop sound
function playGoldenSound() {
  const ctx = getAudioCtx();
  const now = ctx.currentTime;
  [523.25, 659.25, 783.99, 1046.5].forEach((freq, i) => {
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.type = 'sine';
    o.frequency.value = freq;
    g.gain.setValueAtTime(0, now + i * 0.07);
    g.gain.linearRampToValueAtTime(0.2, now + i * 0.07 + 0.02);
    g.gain.exponentialRampToValueAtTime(0.01, now + i * 0.07 + 0.35);
    o.start(now + i * 0.07);
    o.stop(now + i * 0.07 + 0.4);
  });
}

// BGM system
let bgmOscillators = [];
let bgmGainNode = null;
let bgmPlaying = false;
let rushBgmOscillators = [];

function startBGM(stageIdx) {
  if (bgmPlaying) return;
  stageIdx = stageIdx || 0;
  const ctx = getAudioCtx();
  bgmGainNode = ctx.createGain();
  bgmGainNode.gain.value = 0.078;
  bgmGainNode.connect(ctx.destination);

  // Stage-specific melodies, voice types, and settings
  // Pattern: [freq, duration_ms, rest_ms]
  const STAGE_BGM = [
    { // Stage 0: „É™„Éì„É≥„Ç∞ ‚Äî Êòé„Çã„ÅÑ„Éë„É¨„Éº„Éâ (square+triangle)
      melody: [
        [392, 200, 50], [392, 100, 50], [440, 200, 50], [494, 200, 50],
        [523, 300, 100], [494, 150, 50], [440, 150, 50], [392, 300, 100],
        [330, 150, 50], [349, 150, 50], [392, 200, 50], [349, 150, 50],
        [330, 150, 50], [294, 300, 100], [330, 150, 50], [349, 200, 150],
        [262, 200, 50], [294, 200, 50], [330, 200, 50], [349, 200, 50],
        [392, 300, 50], [440, 150, 50], [392, 150, 50], [349, 300, 100],
        [440, 150, 50], [494, 150, 50], [523, 300, 100], [494, 200, 50],
        [440, 200, 50], [392, 200, 50], [349, 150, 50], [392, 400, 200],
      ],
      voice1: 'square', voice2: 'triangle', gain1: 0.18, gain2: 0.12, bassGain: 0.10
    },
    { // Stage 1: Âè∞ÊâÄ ‚Äî ËªΩÂø´„Çπ„Ç¶„Ç£„É≥„Ç∞ (triangle+sine)
      melody: [
        [349, 150, 30], [440, 150, 30], [523, 200, 60], [440, 100, 30],
        [349, 150, 30], [294, 200, 80], [349, 100, 30], [392, 150, 30],
        [440, 200, 60], [392, 150, 30], [349, 100, 30], [330, 200, 80],
        [294, 150, 30], [330, 150, 30], [349, 200, 60], [392, 250, 80],
        [523, 150, 30], [494, 100, 30], [440, 150, 30], [392, 200, 60],
        [349, 150, 30], [330, 100, 30], [349, 200, 60], [294, 250, 80],
        [262, 150, 30], [294, 150, 30], [330, 200, 60], [349, 150, 30],
        [392, 200, 60], [440, 150, 30], [392, 200, 60], [349, 300, 120],
      ],
      voice1: 'triangle', voice2: 'sine', gain1: 0.20, gain2: 0.10, bassGain: 0.12
    },
    { // Stage 2: „Åó„Åæ„Åï„ÅÆÈÉ®Â±ã ‚Äî ÂíåÈ¢®„Éö„É≥„Çø„Éà„Éã„ÉÉ„ÇØ (sine+triangle)
      melody: [
        [330, 300, 80], [392, 250, 60], [440, 300, 80], [523, 350, 100],
        [440, 250, 60], [392, 300, 100], [330, 350, 120],
        [294, 300, 80], [330, 250, 60], [392, 300, 80], [440, 250, 60],
        [392, 300, 80], [330, 250, 60], [294, 350, 120],
        [440, 250, 60], [523, 300, 80], [660, 350, 100], [523, 250, 60],
        [440, 300, 80], [392, 250, 60], [330, 350, 120],
        [392, 300, 80], [440, 250, 60], [392, 300, 80], [330, 250, 60],
        [294, 300, 80], [330, 350, 100], [392, 400, 150],
      ],
      voice1: 'sine', voice2: 'triangle', gain1: 0.20, gain2: 0.08, bassGain: 0.08
    },
    { // Stage 3: „Åà„ÅÑ„Åì„ÅÆÈÉ®Â±ã ‚Äî Á∑äËø´„Éù„ÉÉ„Éó (square+sawtooth)
      melody: [
        [523, 120, 30], [494, 120, 30], [440, 120, 30], [523, 180, 40],
        [587, 120, 30], [523, 120, 30], [494, 180, 40], [440, 120, 30],
        [392, 120, 30], [440, 120, 30], [494, 180, 40], [523, 120, 30],
        [587, 180, 40], [523, 120, 30], [494, 120, 30], [440, 180, 60],
        [349, 120, 30], [392, 120, 30], [440, 120, 30], [494, 180, 40],
        [523, 120, 30], [587, 120, 30], [659, 180, 40], [587, 120, 30],
        [523, 120, 30], [494, 120, 30], [440, 180, 40], [392, 120, 30],
        [440, 120, 30], [494, 120, 30], [523, 180, 40], [494, 200, 80],
      ],
      voice1: 'square', voice2: 'sawtooth', gain1: 0.16, gain2: 0.06, bassGain: 0.12
    },
  ];

  const bgmCfg = STAGE_BGM[stageIdx] || STAGE_BGM[0];
  const melody = bgmCfg.melody;

  let noteIdx = 0;
  function playNote() {
    if (!bgmPlaying) return;
    const c = getAudioCtx();
    const [freq, dur, rest] = melody[noteIdx % melody.length];
    const now = c.currentTime;
    const tempoMul = state.bgmTempoMultiplier || 1;
    const noteSec = (dur / tempoMul) / 1000;
    const detune = state.bgmDetune || 0;

    // Main melody voice
    const o1 = c.createOscillator();
    const g1 = c.createGain();
    o1.connect(g1); g1.connect(bgmGainNode);
    o1.type = bgmCfg.voice1;
    o1.frequency.value = freq;
    o1.detune.value = detune;
    g1.gain.setValueAtTime(bgmCfg.gain1, now);
    g1.gain.setValueAtTime(bgmCfg.gain1, now + noteSec * 0.7);
    g1.gain.exponentialRampToValueAtTime(0.01, now + noteSec);
    o1.start(now); o1.stop(now + noteSec + 0.05);

    // Harmony voice (octave below)
    const o2 = c.createOscillator();
    const g2 = c.createGain();
    o2.connect(g2); g2.connect(bgmGainNode);
    o2.type = bgmCfg.voice2;
    o2.frequency.value = freq / 2;
    o2.detune.value = detune;
    g2.gain.setValueAtTime(bgmCfg.gain2, now);
    g2.gain.exponentialRampToValueAtTime(0.01, now + noteSec);
    o2.start(now); o2.stop(now + noteSec + 0.05);

    // Bass on every other beat
    if (noteIdx % 2 === 0) {
      const ob = c.createOscillator();
      const gb = c.createGain();
      ob.connect(gb); gb.connect(bgmGainNode);
      ob.type = 'triangle';
      ob.frequency.value = freq / 4;
      ob.detune.value = detune;
      gb.gain.setValueAtTime(bgmCfg.bassGain, now);
      gb.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
      ob.start(now); ob.stop(now + 0.2);
    }

    noteIdx++;
    const interval = (dur + rest) / tempoMul;
    bgmOscillators.push(setTimeout(playNote, interval));
  }
  bgmPlaying = true;
  playNote();
}

function stopBGM() {
  bgmPlaying = false;
  bgmOscillators.forEach(t => clearTimeout(t));
  bgmOscillators = [];
}

// Rush BGM (faster, more intense)
let rushBgmPlaying = false;
let rushBgmTimers = [];
function startRushBGM() {
  if (rushBgmPlaying) return;
  const ctx = getAudioCtx();
  const rushGain = ctx.createGain();
  rushGain.gain.value = 0.104;
  rushGain.connect(ctx.destination);
  const notes = [392, 440, 494, 523, 494, 440, 392, 349];
  let idx = 0;
  function playRushNote() {
    if (!rushBgmPlaying) return;
    const c = getAudioCtx();
    const o = c.createOscillator();
    const g = c.createGain();
    o.connect(g); g.connect(rushGain);
    o.type = 'sawtooth';
    o.frequency.value = notes[idx % notes.length];
    const now = c.currentTime;
    g.gain.setValueAtTime(0.15, now);
    g.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
    o.start(now); o.stop(now + 0.2);
    idx++;
    rushBgmTimers.push(setTimeout(playRushNote, 180));
  }
  rushBgmPlaying = true;
  playRushNote();
}
function stopRushBGM() {
  rushBgmPlaying = false;
  rushBgmTimers.forEach(t => clearTimeout(t));
  rushBgmTimers = [];
}

// Happy end fanfare
function playFanfare() {
  const ctx = getAudioCtx();
  const now = ctx.currentTime;
  const melody = [523, 659, 784, 1047, 784, 1047];
  melody.forEach((freq, i) => {
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.type = 'sine';
    o.frequency.value = freq;
    g.gain.setValueAtTime(0, now + i * 0.15);
    g.gain.linearRampToValueAtTime(0.2, now + i * 0.15 + 0.03);
    g.gain.exponentialRampToValueAtTime(0.01, now + i * 0.15 + 0.5);
    o.start(now + i * 0.15);
    o.stop(now + i * 0.15 + 0.55);
  });
}

// Bad end sound
function playBadEndSound() {
  const ctx = getAudioCtx();
  const now = ctx.currentTime;
  [220, 196, 175, 147].forEach((freq, i) => {
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.type = 'sawtooth';
    o.frequency.value = freq;
    g.gain.setValueAtTime(0, now + i * 0.3);
    g.gain.linearRampToValueAtTime(0.15, now + i * 0.3 + 0.05);
    g.gain.exponentialRampToValueAtTime(0.01, now + i * 0.3 + 0.6);
    o.start(now + i * 0.3);
    o.stop(now + i * 0.3 + 0.65);
  });
}

// Shop BGM (relaxed, gentle loop)
let shopBgmPlaying = false;
let shopBgmTimers = [];
let shopBgmGain = null;
function startShopBGM() {
  if (shopBgmPlaying) return;
  const ctx = getAudioCtx();
  shopBgmGain = ctx.createGain();
  shopBgmGain.gain.value = 0.065;
  shopBgmGain.connect(ctx.destination);
  const melody = [
    [262, 400, 100], [330, 350, 80], [392, 400, 100], [440, 350, 80],
    [392, 400, 100], [330, 350, 80], [262, 500, 150],
    [294, 400, 100], [349, 350, 80], [392, 400, 100], [440, 350, 80],
    [392, 400, 100], [349, 350, 80], [294, 500, 200],
  ];
  let idx = 0;
  function playShopNote() {
    if (!shopBgmPlaying) return;
    const c = getAudioCtx();
    const [freq, dur, rest] = melody[idx % melody.length];
    const now = c.currentTime;
    const ns = dur / 1000;
    const o = c.createOscillator();
    const g = c.createGain();
    o.connect(g); g.connect(shopBgmGain);
    o.type = 'sine';
    o.frequency.value = freq;
    g.gain.setValueAtTime(0.15, now);
    g.gain.exponentialRampToValueAtTime(0.01, now + ns);
    o.start(now); o.stop(now + ns + 0.05);
    // Soft harmony
    const o2 = c.createOscillator();
    const g2 = c.createGain();
    o2.connect(g2); g2.connect(shopBgmGain);
    o2.type = 'triangle';
    o2.frequency.value = freq * 1.5;
    g2.gain.setValueAtTime(0.06, now);
    g2.gain.exponentialRampToValueAtTime(0.01, now + ns * 0.8);
    o2.start(now); o2.stop(now + ns);
    idx++;
    shopBgmTimers.push(setTimeout(playShopNote, dur + rest));
  }
  shopBgmPlaying = true;
  playShopNote();
}
function stopShopBGM() {
  shopBgmPlaying = false;
  shopBgmTimers.forEach(t => clearTimeout(t));
  shopBgmTimers = [];
}

// All Clear BGM (grand fanfare with extended harmony)
function playAllClearBGM() {
  const ctx = getAudioCtx();
  const now = ctx.currentTime;
  const melody = [
    [523, 0.15], [587, 0.15], [659, 0.15], [784, 0.25],
    [880, 0.15], [784, 0.15], [880, 0.20], [1047, 0.40],
    [784, 0.15], [880, 0.15], [1047, 0.20], [1319, 0.50],
  ];
  let t = 0;
  melody.forEach(([freq, dur]) => {
    // Main voice
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.type = 'sine';
    o.frequency.value = freq;
    g.gain.setValueAtTime(0, now + t);
    g.gain.linearRampToValueAtTime(0.22, now + t + 0.03);
    g.gain.exponentialRampToValueAtTime(0.01, now + t + dur + 0.3);
    o.start(now + t); o.stop(now + t + dur + 0.35);
    // Harmony (fifth above)
    const oh = ctx.createOscillator();
    const gh = ctx.createGain();
    oh.connect(gh); gh.connect(ctx.destination);
    oh.type = 'triangle';
    oh.frequency.value = freq * 1.5;
    gh.gain.setValueAtTime(0, now + t);
    gh.gain.linearRampToValueAtTime(0.08, now + t + 0.03);
    gh.gain.exponentialRampToValueAtTime(0.01, now + t + dur + 0.2);
    oh.start(now + t); oh.stop(now + t + dur + 0.25);
    // Bass (octave below)
    const ob = ctx.createOscillator();
    const gb = ctx.createGain();
    ob.connect(gb); gb.connect(ctx.destination);
    ob.type = 'triangle';
    ob.frequency.value = freq / 2;
    gb.gain.setValueAtTime(0, now + t);
    gb.gain.linearRampToValueAtTime(0.10, now + t + 0.02);
    gb.gain.exponentialRampToValueAtTime(0.01, now + t + dur + 0.15);
    ob.start(now + t); ob.stop(now + t + dur + 0.2);
    t += dur;
  });
}

// Bad End BGM (sad descending melody with drone)
function playBadEndBGM() {
  const ctx = getAudioCtx();
  const now = ctx.currentTime;
  // Sad melody (descending minor)
  const melody = [
    [440, 0.35], [415, 0.35], [392, 0.35], [349, 0.45],
    [330, 0.35], [294, 0.35], [262, 0.45], [247, 0.60],
  ];
  let t = 0;
  melody.forEach(([freq, dur]) => {
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.type = 'sawtooth';
    o.frequency.value = freq;
    g.gain.setValueAtTime(0, now + t);
    g.gain.linearRampToValueAtTime(0.12, now + t + 0.04);
    g.gain.exponentialRampToValueAtTime(0.01, now + t + dur + 0.2);
    o.start(now + t); o.stop(now + t + dur + 0.25);
    t += dur;
  });
  // Ominous low drone underneath
  const drone = ctx.createOscillator();
  const dg = ctx.createGain();
  drone.connect(dg); dg.connect(ctx.destination);
  drone.type = 'sine';
  drone.frequency.value = 73.4; // D2
  dg.gain.setValueAtTime(0, now);
  dg.gain.linearRampToValueAtTime(0.08, now + 0.5);
  dg.gain.setValueAtTime(0.08, now + t - 0.5);
  dg.gain.exponentialRampToValueAtTime(0.01, now + t + 0.5);
  drone.start(now); drone.stop(now + t + 0.55);
}

// Eiko Awakening BGM (heroic uptempo)
let awakenBgmPlaying = false;
let awakenBgmTimers = [];
let awakenBgmGain = null;
function startAwakenBGM() {
  if (awakenBgmPlaying) return;
  const ctx = getAudioCtx();
  awakenBgmGain = ctx.createGain();
  awakenBgmGain.gain.value = 0.09;
  awakenBgmGain.connect(ctx.destination);
  const melody = [
    [523, 130, 20], [587, 130, 20], [659, 130, 20], [784, 180, 30],
    [880, 130, 20], [784, 130, 20], [659, 130, 20], [784, 180, 40],
  ];
  let idx = 0;
  function playAwakenNote() {
    if (!awakenBgmPlaying) return;
    const c = getAudioCtx();
    const [freq, dur, rest] = melody[idx % melody.length];
    const now = c.currentTime;
    const ns = dur / 1000;
    const o = c.createOscillator();
    const g = c.createGain();
    o.connect(g); g.connect(awakenBgmGain);
    o.type = 'square';
    o.frequency.value = freq;
    g.gain.setValueAtTime(0.18, now);
    g.gain.exponentialRampToValueAtTime(0.01, now + ns);
    o.start(now); o.stop(now + ns + 0.03);
    // Power bass
    if (idx % 2 === 0) {
      const ob = c.createOscillator();
      const gb = c.createGain();
      ob.connect(gb); gb.connect(awakenBgmGain);
      ob.type = 'sawtooth';
      ob.frequency.value = freq / 2;
      gb.gain.setValueAtTime(0.10, now);
      gb.gain.exponentialRampToValueAtTime(0.01, now + 0.12);
      ob.start(now); ob.stop(now + 0.15);
    }
    idx++;
    awakenBgmTimers.push(setTimeout(playAwakenNote, dur + rest));
  }
  awakenBgmPlaying = true;
  playAwakenNote();
}
function stopAwakenBGM() {
  awakenBgmPlaying = false;
  awakenBgmTimers.forEach(t => clearTimeout(t));
  awakenBgmTimers = [];
}

// Shimasa scold drone (low ominous bass for 5 seconds)
function playShimasaDrone() {
  const ctx = getAudioCtx();
  const now = ctx.currentTime;
  const dur = 5;
  // Low rumble
  const o = ctx.createOscillator();
  const g = ctx.createGain();
  o.connect(g); g.connect(ctx.destination);
  o.type = 'sine';
  o.frequency.value = 80;
  g.gain.setValueAtTime(0, now);
  g.gain.linearRampToValueAtTime(0.10, now + 0.3);
  g.gain.setValueAtTime(0.10, now + dur - 0.5);
  g.gain.exponentialRampToValueAtTime(0.01, now + dur);
  o.start(now); o.stop(now + dur + 0.1);
  // Slightly detuned second drone for unease
  const o2 = ctx.createOscillator();
  const g2 = ctx.createGain();
  o2.connect(g2); g2.connect(ctx.destination);
  o2.type = 'sine';
  o2.frequency.value = 82;
  g2.gain.setValueAtTime(0, now);
  g2.gain.linearRampToValueAtTime(0.06, now + 0.3);
  g2.gain.setValueAtTime(0.06, now + dur - 0.5);
  g2.gain.exponentialRampToValueAtTime(0.01, now + dur);
  o2.start(now); o2.stop(now + dur + 0.1);
  // Temporarily reduce main BGM volume
  if (bgmGainNode) {
    bgmGainNode.gain.setValueAtTime(0.04, now);
    bgmGainNode.gain.setValueAtTime(0.078, now + dur);
  }
}

let state = {
  running: false,
  currentRoom: 'living',
  currentStage: 0,
  poops: {},       // room -> [{id, x, y, el}]
  totalPoops: 0,
  score: 0,
  totalScore: 0,
  timeLeft: 60,
  maxPoop: 20,
  tomRoom: 'living',
  tomX: 400, tomY: 300,
  yokoRoom: 'living',
  yokoX: 300, yokoY: 300,
  poopIdCounter: 0,
  rushMode: false,
  rushTimer: null,
  goldenActive: false,
  ownedItems: [],     // purchased item ids
  equippedItems: [],   // equipped item ids (max MAX_EQUIP_SLOTS)
  deodorantUsed: false,
  deodorantDebuff: false,  // post-deodorant +100% spawn rate
  timerFrozen: false,
  spawnFrozen: false,      // deodorant: stop spawning
  eikoAwakened: false,     // awakening mode (15s double range)
  eikoAwakenedStun: false, // post-awakening stun (5s)
  awakenUsed: false,
  eikoStunned: false,      // pee puddle stun (1s)
  tomFrozen: false,        // tom snack freeze (10s)
  tomSnackUsed: false,
  shimasaDignityUsed: false,
  eikoFinalUsed: false,
  totalControlUsed: false,
  shimasaScolding: false,  // shimasa scold: 2x poop/pee for 5s
  trashCount: 0,           // current trash mess count
  trashDebuff: false,      // trash debuff active (3+ trash = +50% poop rate)
  bgmTempoMultiplier: 1,   // dynamic BGM tempo (1=normal, higher=faster)
  bgmDetune: 0,            // BGM detune in cents (trash debuff: +30)
  luckyScoreMultiplier: 1, // bonus time score multiplier
  stageRanks: [],          // accumulated ranks per stage for ending
  selectedActiveItem: null,  // currently selected active item id
  comboCount: 0,           // consecutive poop cleanups
  comboTimer: null,        // reset combo after timeout
  maxCombo: 0,             // best combo in current stage
};

let timerInterval = null;
let poopInterval = null;
let yokoPoopInterval = null;
let tomMoveInterval = null;
let yokoMoveInterval = null;
let eikoX = 400, eikoY = 300;
let goldenPoopTimer = null;
let rushScheduleTimer = null;
let rushPoopInterval = null;
let vacuumInterval = null;
let sprayTimer = null;
let peePuddleInterval = null;
let awakenTimer = null;
let awakenStunTimer = null;
let tomSnackTimer = null;
let slideCorrectTimer = null;
let shimasaScoldTimer = null;
let shimasaScoldEndTimer = null;
let trashInterval = null;
let scratchInterval = null;
let waterInterval = null;
let luckyEventTimer = null;
let tomSpecialTimer = null;
let weatherTimer = null;

// Cage system
const CAGE_DURATION = 2000;   // 2 seconds in cage
const CAGE_COOLDOWN = 12000;  // 12 seconds cooldown
let tomCaged = false;
let cageCooldown = false;
let cageTimerHandle = null;
let cageCooldownHandle = null;
let cageBarInterval = null;

const container = document.getElementById('game-container');
const hud = document.getElementById('hud');
const tomEl = document.getElementById('tom');
const eikoEl = document.getElementById('eiko');
const yokoEl = document.getElementById('yoko');

// ===== Mobile Detection & Scaling =====
let gameScale = 1;
const isMobile = /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent);
const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
const rotateHint = document.getElementById('rotate-hint');

// Apply mobile class for CSS
if (isMobile || (isTouchDevice && window.innerWidth <= 820)) {
  document.documentElement.classList.add('mobile-mode');
}

function resizeGame() {
  const vw = window.innerWidth;
  const vh = window.innerHeight;
  const scaleX = vw / 800;
  const scaleY = vh / 600;
  gameScale = Math.min(scaleX, scaleY);

  if (document.documentElement.classList.contains('mobile-mode')) {
    // Mobile: position: fixed + translate for pixel-perfect centering
    container.style.position = 'fixed';
    container.style.left = '50%';
    container.style.top = '50%';
    container.style.transform = 'translate(-50%, -50%) scale(' + gameScale + ')';
    container.style.transformOrigin = 'center center';
  } else {
    // Desktop: just scale in place
    container.style.transform = gameScale < 1 ? 'scale(' + gameScale + ')' : '';
    container.style.transformOrigin = 'center center';
  }

  // Rotate hint: show in portrait on mobile
  if (rotateHint && isMobile) {
    if (vw < vh) {
      rotateHint.classList.add('visible');
    } else {
      rotateHint.classList.remove('visible');
    }
  }
}
resizeGame();
window.addEventListener('resize', resizeGame);
window.addEventListener('orientationchange', function() {
  setTimeout(resizeGame, 100);
  setTimeout(resizeGame, 300);
});

// Convert touch/mouse event coordinates to game container coordinates (accounting for scale)
function getGameCoords(e) {
  const rect = container.getBoundingClientRect();
  const clientX = e.touches ? e.touches[0].clientX : e.clientX;
  const clientY = e.touches ? e.touches[0].clientY : e.clientY;
  return {
    x: (clientX - rect.left) / gameScale,
    y: (clientY - rect.top) / gameScale
  };
}

// ===== Touch Event Support =====
if (isTouchDevice) {
  // Prevent unwanted scrolling/zooming on the game container (allow shop scrolling)
  container.addEventListener('touchmove', function(e) {
    if (e.target.closest('#shop-screen')) return;
    e.preventDefault();
  }, { passive: false });
  document.body.addEventListener('touchmove', function(e) {
    if (e.target.closest('#shop-screen')) return;
    if (e.target.closest('#game-container')) e.preventDefault();
  }, { passive: false });

  // Synthesize click from touch for faster response (eliminates ~300ms delay)
  container.addEventListener('touchstart', function(e) {
    if (e.target.closest('#shop-screen')) return;
    if (e.target.closest('.screen-overlay button')) return;
    if (e.target.closest('[onclick]')) return;
    this._touchStartX = e.touches[0].clientX;
    this._touchStartY = e.touches[0].clientY;
  }, { passive: true });

  container.addEventListener('touchend', function(e) {
    if (e.target.closest('#shop-screen')) return;
    if (e.target.closest('.screen-overlay button')) return;
    if (e.target.closest('[onclick]')) return;
    var touch = e.changedTouches[0];
    var dx = Math.abs(touch.clientX - (this._touchStartX || 0));
    var dy = Math.abs(touch.clientY - (this._touchStartY || 0));
    if (dx > 15 || dy > 15) return;
    e.preventDefault();
    var clickEvt = new MouseEvent('click', {
      bubbles: true, cancelable: true,
      clientX: touch.clientX, clientY: touch.clientY
    });
    e.target.dispatchEvent(clickEvt);
  }, { passive: false });

  // Update UI text: „ÇØ„É™„ÉÉ„ÇØ ‚Üí „Çø„ÉÉ„Éó
  var subtitle = document.querySelector('#title-screen .subtitle');
  if (subtitle) subtitle.innerHTML = subtitle.innerHTML.replace(/„ÇØ„É™„ÉÉ„ÇØ/g, '„Çø„ÉÉ„Éó');
  var cageHint = document.getElementById('cage-hint');
  if (cageHint) cageHint.innerHTML = cageHint.innerHTML.replace(/„ÇØ„É™„ÉÉ„ÇØ/g, '„Çø„ÉÉ„Éó');
}

const clickWord = isTouchDevice ? '„Çø„ÉÉ„Éó' : '„ÇØ„É™„ÉÉ„ÇØ';
const misclickWord = isTouchDevice ? '„Éü„Çπ„Çø„ÉÉ„Éó' : '„Éü„Çπ„ÇØ„É™„ÉÉ„ÇØ';

// Initialize poop arrays
ROOMS.forEach(r => state.poops[r] = []);

function showTitle() {
  document.getElementById('title-screen').style.display = '';
  document.getElementById('gameover-screen').style.display = 'none';
  document.getElementById('gameover-screen').innerHTML = '';
  document.getElementById('clear-screen').style.display = 'none';
  document.getElementById('clear-screen').innerHTML = '';
  document.getElementById('shop-screen').style.display = 'none';
  document.getElementById('shop-screen').innerHTML = '';
  hud.style.display = 'none';
  tomEl.style.display = 'none';
  eikoEl.style.display = 'none';
  yokoEl.style.display = 'none';
  document.getElementById('rush-banner').style.display = 'none';
  document.getElementById('spray-btn').style.display = 'none';
  document.getElementById('active-items').style.display = 'none';
  container.classList.remove('rush-active');
  stopGame();
  stopBGM();
  stopRushBGM();
  stopShopBGM();
  stopAwakenBGM();
  clearFlood();
  clearAllPoopElements();
  resetCage();
  clearTimeout(goldenPoopTimer);
  clearTimeout(rushScheduleTimer);
  clearTimeout(rushPoopInterval);
  clearInterval(vacuumInterval);
  clearTimeout(sprayTimer);
  clearTimeout(peePuddleInterval);
  clearTimeout(awakenTimer);
  clearTimeout(awakenStunTimer);
  clearTimeout(tomSnackTimer);
  clearTimeout(slideCorrectTimer);
  document.querySelectorAll('.happy-confetti').forEach(e => e.remove());
  document.querySelectorAll('.stage-banner').forEach(e => e.remove());
  document.querySelectorAll('.pee-puddle').forEach(e => e.remove());
  document.querySelectorAll('.misclick-flash').forEach(e => e.remove());
  document.getElementById('cage-hint').style.display = 'none';
  // Reset state
  state.currentStage = 0;
  state.totalScore = 0;
  state.ownedItems = [];
  state.equippedItems = [];
  state.deodorantUsed = false;
  state.deodorantDebuff = false;
  state.timerFrozen = false;
  state.spawnFrozen = false;
  state.eikoAwakened = false;
  state.eikoAwakenedStun = false;
  state.awakenUsed = false;
  state.eikoStunned = false;
  state.tomFrozen = false;
  state.tomHiding = false;
  state.tomSnackUsed = false;
  state.shimasaDignityUsed = false;
  state.eikoFinalUsed = false;
  state.totalControlUsed = false;
  state.shimasaScolding = false;
  state.trashCount = 0;
  state.trashDebuff = false;
  state.bgmTempoMultiplier = 1;
  state.bgmDetune = 0;
  state.luckyScoreMultiplier = 1;
  state.stageRanks = [];
  state.selectedActiveItem = null;
  container.style.filter = '';
  container.classList.remove('item-selected');
  eikoEl.classList.remove('awakened', 'stunned');
  tomEl.classList.remove('frozen', 'slippery-stage', 'scolded');
  document.querySelectorAll('.pee-puddle').forEach(e => e.remove());
  document.querySelectorAll('.misclick-flash').forEach(e => e.remove());
  document.querySelectorAll('.mess-trash, .mess-scratch, .mess-water, .lucky-event-flash').forEach(e => e.remove());
  // Hide all rooms
  ROOMS.forEach(r => {
    document.getElementById('room-' + r).classList.remove('active');
  });
}

function clearAllPoopElements() {
  document.querySelectorAll('.poop').forEach(el => el.remove());
  ROOMS.forEach(r => state.poops[r] = []);
  state.totalPoops = 0;
}

function clearFlood() {
  document.querySelectorAll('.flood-poop').forEach(el => el.remove());
}

function startStageGame() {
  state.currentStage = 0;
  state.totalScore = 0;
  state.ownedItems = [];
  state.equippedItems = [];
  startStage(0);
}

function startStage(stageIdx) {
  const cfg = STAGES[stageIdx];
  state.currentStage = stageIdx;
  state.running = true;
  state.score = 0;
  state.timeLeft = cfg.time;
  state.maxPoop = cfg.maxPoop;
  state.clearCount = cfg.clearCount;
  state.cleanedCount = 0;
  state.comboCount = 0;
  state.maxCombo = 0;
  clearTimeout(state.comboTimer);
  state.totalPoops = 0;
  state.poopIdCounter = 0;
  state.currentRoom = cfg.room;
  state.tomRoom = cfg.room;
  state.yokoRoom = cfg.room;
  state.deodorantUsed = false;
  state.deodorantDebuff = false;
  state.timerFrozen = false;
  state.spawnFrozen = false;
  state.eikoAwakened = false;
  state.eikoAwakenedStun = false;
  state.awakenUsed = false;
  state.eikoStunned = false;
  state.tomFrozen = false;
  state.tomHiding = false;
  state.tomSnackUsed = false;
  state.shimasaDignityUsed = false;
  state.eikoFinalUsed = false;
  state.totalControlUsed = false;
  state.shimasaScolding = false;
  state.selectedActiveItem = null;
  container.classList.remove('item-selected');

  clearAllPoopElements();
  clearFlood();
  resetCage();

  document.getElementById('title-screen').style.display = 'none';
  document.getElementById('gameover-screen').style.display = 'none';
  document.getElementById('clear-screen').style.display = 'none';
  document.getElementById('shop-screen').style.display = 'none';
  document.getElementById('shop-screen').innerHTML = '';
  hud.style.display = '';
  tomEl.style.display = '';
  eikoEl.style.display = '';

  // Show Yoko only on stages where she's active
  yokoEl.style.display = cfg.yokoActive ? '' : 'none';

  document.getElementById('spray-btn').style.display = 'none';

  // Show active items
  updateActiveItemsDisplay();

  // Switch to stage room
  ROOMS.forEach(r => {
    document.getElementById('room-' + r).classList.toggle('active', r === cfg.room);
  });
  updateHUD();

  // Place Tom
  state.tomX = 40 + Math.random() * 700;
  state.tomY = 80 + Math.random() * 420;
  tomEl.style.left = state.tomX + 'px';
  tomEl.style.top = state.tomY + 'px';

  // Slippery stage: Tom slides
  eikoEl.classList.remove('awakened', 'stunned');
  tomEl.classList.remove('frozen');
  if (cfg.mechanic === 'slippery') {
    tomEl.classList.add('slippery-stage');
  } else {
    tomEl.classList.remove('slippery-stage');
  }

  // Place Eiko
  eikoX = 400; eikoY = 350;
  updateEikoPosition();

  // Place Yoko
  if (cfg.yokoActive) {
    state.yokoX = 200 + Math.random() * 400;
    state.yokoY = 100 + Math.random() * 350;
    yokoEl.style.left = state.yokoX + 'px';
    yokoEl.style.top = state.yokoY + 'px';
  }

  // Start timers (yoko_medicine side effect: 10% faster, full_armor: 5% faster)
  let timerSpeed = 1000;
  if (state.equippedItems.includes('yoko_medicine')) timerSpeed = 909;
  else if (state.equippedItems.includes('full_armor')) timerSpeed = 952;
  timerInterval = setInterval(() => {
    if (!state.running) return;
    if (state.timerFrozen) return;
    state.timeLeft--;
    updateHUD();
    if (state.timeLeft <= 0) {
      if (state.cleanedCount >= state.clearCount) {
        stageClear();
      } else {
        gameOver();
      }
    }
  }, timerSpeed);

  // Poop interval (apply tom_chip: -70% frequency = intervals * 3.33, quantum_vacuum: -50%)
  let [minI, maxI] = cfg.poopInterval;
  const hasChip = state.equippedItems.includes('tom_chip');
  const hasQuantumVac = state.equippedItems.includes('quantum_vacuum');
  if (hasChip) {
    minI = Math.floor(minI * 3.33);
    maxI = Math.floor(maxI * 3.33);
  }
  if (hasQuantumVac) {
    minI = Math.floor(minI * 2);
    maxI = Math.floor(maxI * 2);
  }

  // Vacuum / quantum vacuum side effect: darken screen
  if (state.equippedItems.includes('overload_vacuum') || hasQuantumVac) {
    container.style.filter = hasQuantumVac ? 'brightness(0.9)' : 'brightness(0.8)';
  } else {
    container.style.filter = '';
  }

  // Full armor: hidden poop glow effect
  if (state.equippedItems.includes('full_armor')) {
    container.classList.add('full-armor-active');
  }

  // Eiko movement speed (tom_chip: -10%, quantum_vacuum: -15%, full_armor: -10%)
  let eikoTransTime = 0.15;
  if (hasChip) eikoTransTime = 0.165;
  if (hasQuantumVac) eikoTransTime *= 1.15;
  if (state.equippedItems.includes('full_armor')) eikoTransTime *= 1.1;
  state.eikoBaseTransTime = eikoTransTime;
  eikoEl.style.transition = 'left ' + eikoTransTime.toFixed(3) + 's, top ' + eikoTransTime.toFixed(3) + 's';
  function scheduleNextPoop() {
    if (!state.running) return;
    let delay = minI + Math.random() * (maxI - minI);
    if (state.deodorantDebuff) delay *= 0.67; // +50% spawn rate
    if (state.shimasaScolding) delay *= 0.5; // shimasa scold: 2x spawn rate
    if (state.trashDebuff) delay *= 0.67; // trash debuff: +50% spawn rate
    poopInterval = setTimeout(() => {
      if (!state.running) return;
      spawnPoop();
      scheduleNextPoop();
    }, delay);
  }
  scheduleNextPoop();

  // Tom movement (stays in same room, just moves position)
  // Synergy: ÂãïÁâ©Âà∂Âæ° slows Tom by 30% more
  let tomSpd = cfg.tomSpeed;
  const synActive = getActiveSynergy();
  if (synActive && synActive.name === 'ÂãïÁâ©Âà∂Âæ°') tomSpd = Math.floor(tomSpd * 1.3);
  tomMoveInterval = setInterval(() => {
    if (!state.running || tomCaged || state.tomFrozen || state.tomHiding) return;
    state.tomX = 40 + Math.random() * 700;
    state.tomY = 80 + Math.random() * 420;
    tomEl.style.left = state.tomX + 'px';
    tomEl.style.top = state.tomY + 'px';
  }, tomSpd);

  // Yoko setup (only on stages 3+)
  if (cfg.yokoActive) {
    yokoMoveInterval = setInterval(() => {
      if (!state.running) return;
      state.yokoX = 40 + Math.random() * 700;
      state.yokoY = 80 + Math.random() * 400;
      yokoEl.style.left = state.yokoX + 'px';
      yokoEl.style.top = state.yokoY + 'px';
      // Yoko interacts with nearby poop after moving
      setTimeout(() => yokoInteractWithPoop(), 300);
    }, cfg.tomSpeed * 1.5);

    // Yoko poop (skip if yoko_medicine equipped)
    if (!state.equippedItems.includes('yoko_medicine') && !state.equippedItems.includes('full_armor')) {
      const yokoMinI = minI * 1.5;
      const yokoMaxI = maxI * 1.5;
      function scheduleNextYokoPoop() {
        if (!state.running) return;
        const delay = yokoMinI + Math.random() * (yokoMaxI - yokoMinI);
        yokoPoopInterval = setTimeout(() => {
          if (!state.running) return;
          spawnYokoPoop();
          scheduleNextYokoPoop();
        }, delay);
      }
      setTimeout(() => {
        if (state.running) scheduleNextYokoPoop();
      }, 5000);
    }
  }

  // Overload vacuum: auto-clean (synergy with cloak = 0.6s, default 1s)
  if (state.equippedItems.includes('overload_vacuum') || state.equippedItems.includes('quantum_vacuum')) {
    const syn = getActiveSynergy();
    const vacInterval = (syn && syn.name === 'Ëá™ÂãïÊéÉÈô§„Éû„Çπ„Çø„Éº') ? 600 : state.equippedItems.includes('quantum_vacuum') ? 700 : 1000;
    vacuumInterval = setInterval(() => {
      if (!state.running) return;
      autoCleanOnePoop();
    }, vacInterval);
  }

  // Pee puddle mechanic (kitchen)
  if (cfg.mechanic === 'pee_puddle' && cfg.peeInterval) {
    const [peeMin, peeMax] = cfg.peeInterval;
    function schedulePeePuddle() {
      if (!state.running) return;
      let peeDelay = peeMin + Math.random() * (peeMax - peeMin);
      if (state.shimasaScolding) peeDelay *= 0.5; // shimasa scold: 2x pee rate
      peePuddleInterval = setTimeout(() => {
        if (!state.running) return;
        spawnPeePuddle();
        schedulePeePuddle();
      }, peeDelay);
    }
    // First puddle after 2 seconds
    setTimeout(() => { if (state.running) schedulePeePuddle(); }, 2000);
  }

  // Start BGM (stage-specific)
  startBGM(stageIdx);

  // Schedule golden poop
  function scheduleGoldenPoop() {
    if (!state.running) return;
    const delay = 10000 + Math.random() * 10000;
    goldenPoopTimer = setTimeout(() => {
      if (!state.running) return;
      spawnGoldenPoop();
      scheduleGoldenPoop();
    }, delay);
  }
  scheduleGoldenPoop();

  // Schedule rush mode
  function scheduleRushMode() {
    if (!state.running) return;
    const delay = 20000 + Math.random() * 15000;
    rushScheduleTimer = setTimeout(() => {
      if (!state.running) return;
      startRushMode();
      setTimeout(() => scheduleRushMode(), 10000);
    }, delay);
  }
  scheduleRushMode();

  state.rushMode = false;
  state.goldenActive = false;

  // Schedule shimasa scold event (33% chance per stage)
  scheduleShimasaScold();

  // Schedule lucky events
  scheduleLuckyEvent();

  // Schedule Tom special behaviors (stage 2+)
  if (stageIdx >= 1) {
    scheduleTomSpecial();
  }

  // Schedule weather events (stage 3+)
  if (stageIdx >= 2) {
    scheduleWeather();
  }

  // Schedule mess events (start after 5s delay)
  trashInterval = setTimeout(function loopTrash() {
    if (!state.running) return;
    spawnTrash();
    trashInterval = setTimeout(loopTrash, 8000 + Math.random() * 7000); // 8-15s interval
  }, 5000 + Math.random() * 3000);

  scratchInterval = setTimeout(function loopScratch() {
    if (!state.running) return;
    spawnScratch();
    scratchInterval = setTimeout(loopScratch, 12000 + Math.random() * 8000); // 12-20s interval
  }, 5000 + Math.random() * 5000);

  if (cfg.yokoActive) {
    waterInterval = setTimeout(function loopWater() {
      if (!state.running) return;
      spawnWater();
      waterInterval = setTimeout(loopWater, 10000 + Math.random() * 8000); // 10-18s interval
    }, 5000 + Math.random() * 4000);
  }

  // Show stage banner
  showStageBanner(stageIdx);
  updateCageHint();

  // Show active item hints
  const activeHints = [];
  if (state.equippedItems.includes('strong_deodorant') && !state.deodorantUsed) activeHints.push('üß¥Ê∂àËá≠Ââ§');
  if (state.equippedItems.includes('eiko_awaken') && !state.awakenUsed) activeHints.push('üî•Ë¶öÈÜí');
  if (state.equippedItems.includes('tom_snack') && !state.tomSnackUsed) activeHints.push('ü¶¥„Åä„ÇÑ„Å§');
  if (state.equippedItems.includes('shimasa_dignity') && !state.shimasaDignityUsed) activeHints.push('üë¥Â®ÅÂé≥');
  if (state.equippedItems.includes('eiko_final') && !state.eikoFinalUsed) activeHints.push('üë∏ÊúÄÁµÇÂΩ¢ÊÖã');
  if (state.equippedItems.includes('total_control') && !state.totalControlUsed) activeHints.push('üéØÂà∂Âúß');
  if (activeHints.length > 0) {
    setTimeout(() => {
      if (state.running) showStageIndicator('„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„Ç¢„Ç§„ÉÜ„É†: ' + activeHints.join(' ') + ' (ÈÅ∏Êäû‚Üí' + clickWord + '„ÅßÁô∫Âãï)');
    }, 3000);
  }
}

function stopGame() {
  state.running = false;
  state.spawnFrozen = false;
  state.deodorantDebuff = false;
  state.eikoAwakened = false;
  state.eikoAwakenedStun = false;
  state.eikoStunned = false;
  state.tomFrozen = false;
  state.selectedActiveItem = null;
  container.classList.remove('item-selected', 'full-armor-active', 'cage-slam');
  clearInterval(timerInterval);
  clearTimeout(poopInterval);
  clearTimeout(yokoPoopInterval);
  clearInterval(tomMoveInterval);
  clearInterval(yokoMoveInterval);
  clearTimeout(goldenPoopTimer);
  clearTimeout(rushScheduleTimer);
  clearTimeout(rushPoopInterval);
  clearInterval(vacuumInterval);
  clearTimeout(sprayTimer);
  clearTimeout(peePuddleInterval);
  clearTimeout(awakenTimer);
  clearTimeout(awakenStunTimer);
  clearTimeout(tomSnackTimer);
  clearTimeout(slideCorrectTimer);
  clearTimeout(shimasaScoldTimer);
  clearTimeout(shimasaScoldEndTimer);
  clearTimeout(trashInterval);
  clearTimeout(scratchInterval);
  clearTimeout(waterInterval);
  clearTimeout(luckyEventTimer);
  clearTimeout(tomSpecialTimer);
  clearTimeout(weatherTimer);
  state.trashCount = 0;
  state.trashDebuff = false;
  state.luckyScoreMultiplier = 1;
  state.tomHiding = false;
  state.comboCount = 0;
  clearTimeout(state.comboTimer);
  state.bgmTempoMultiplier = 1;
  state.bgmDetune = 0;
  container.style.filter = '';
  eikoEl.classList.remove('awakened', 'stunned');
  tomEl.classList.remove('frozen', 'slippery-stage', 'scolded', 'dashing', 'hiding', 'squatting', 'pooping');
  document.querySelectorAll('.pee-puddle').forEach(e => e.remove());
  document.querySelectorAll('.misclick-flash').forEach(e => e.remove());
  document.querySelectorAll('.mess-trash, .mess-scratch, .mess-water, .lucky-event-flash, .weather-rain, .weather-thunder-flash').forEach(e => e.remove());
  const comboEl = document.getElementById('combo-display');
  if (comboEl) comboEl.classList.remove('active', 'hot', 'fire');
  stopRushMode();
  stopBGM();
  stopRushBGM();
  stopAwakenBGM();
}

function showStageBanner(stageIdx) {
  const cfg = STAGES[stageIdx];
  document.querySelectorAll('.stage-banner').forEach(e => e.remove());
  const banner = document.createElement('div');
  banner.className = 'stage-banner';
  let mechanicText = '';
  if (cfg.mechanic === 'slippery') mechanicText = '<br><span style="font-size:18px;color:#aadaff;">‚ö† Â∫ä„ÅåÊªë„ÇãÔºÅ</span>';
  if (cfg.mechanic === 'pee_puddle') mechanicText = '<br><span style="font-size:18px;color:#ffdd66;">‚ö† „Åä„Åó„Å£„ÅìÊ∞¥„Åü„Åæ„Çä„Å´Ê≥®ÊÑèÔºÅ</span>';
  if (cfg.mechanic === 'hidden_poop') mechanicText = '<br><span style="font-size:18px;color:#c0a0ff;">‚ö† „ÅÜ„Çì„Å°„ÅåÈö†„Çå„Å¶„ÅÑ„ÇãÔºÅ</span>';
  if (cfg.mechanic === 'misclick_penalty') mechanicText = '<br><span style="font-size:18px;color:#ff8888;">‚ö† ' + misclickWord + 'Âé≥Á¶ÅÔºã„Éà„É©„ÉÉ„ÉóÊ≥®ÊÑèÔºÅ</span>';
  banner.innerHTML = '<span class="stage-num">Stage ' + (stageIdx + 1) + '</span><br>' + cfg.name + mechanicText;
  container.appendChild(banner);
  setTimeout(() => banner.remove(), 3500);
}

function updateActiveItemsDisplay() {
  const el = document.getElementById('active-items');
  el.innerHTML = '';
  if (state.equippedItems.length === 0) { el.style.display = 'none'; return; }
  el.style.display = '';

  state.equippedItems.forEach((id, slotIdx) => {
    const item = findItem(id);
    if (!item) return;

    if (item.type === 'active') {
      let used = false;
      if (id === 'strong_deodorant') used = state.deodorantUsed;
      if (id === 'eiko_awaken') used = state.awakenUsed;
      if (id === 'tom_snack') used = state.tomSnackUsed;
      if (id === 'shimasa_dignity') used = state.shimasaDignityUsed;
      if (id === 'eiko_final') used = state.eikoFinalUsed;
      if (id === 'total_control') used = state.totalControlUsed;

      const isSelected = (state.selectedActiveItem === id);
      const btn = document.createElement('button');
      btn.className = 'active-item-btn' + (used ? ' cooldown' : '') + (isSelected ? ' selected' : '');
      btn.disabled = used;
      btn.textContent = item.icon + ' [' + (slotIdx + 1) + ']';
      btn.title = item.name + (used ? ' (‰ΩøÁî®Ê∏à)' : isSelected ? ' (ÈÅ∏Êäû‰∏≠ - ' + clickWord + '„ÅßÁô∫Âãï)' : ' (ÈÅ∏Êäû„Åó„Å¶„Åã„Çâ' + clickWord + ')');
      btn.addEventListener('click', (ev) => {
        ev.stopPropagation();
        if (used) return;
        toggleActiveItem(id);
      });
      el.appendChild(btn);
    } else {
      const span = document.createElement('span');
      span.className = 'active-item-icon';
      span.title = item.name;
      span.textContent = item.icon;
      el.appendChild(span);
    }
  });
}

function toggleActiveItem(itemId) {
  if (state.selectedActiveItem === itemId) {
    // Deselect
    state.selectedActiveItem = null;
    container.classList.remove('item-selected');
  } else {
    // Select
    state.selectedActiveItem = itemId;
    container.classList.add('item-selected');
    const item = findItem(itemId);
    if (item) showStageIndicator(item.icon + ' ' + item.name + ' ÈÅ∏Êäû‰∏≠ ‚Äî ' + clickWord + '„ÅßÁô∫ÂãïÔºÅ');
  }
  updateActiveItemsDisplay();
}

function activateSelectedItem() {
  const id = state.selectedActiveItem;
  if (!id) return false;
  state.selectedActiveItem = null;
  container.classList.remove('item-selected');
  if (id === 'strong_deodorant') useDeodorant();
  if (id === 'eiko_awaken') useEikoAwaken();
  if (id === 'tom_snack') useTomSnack();
  if (id === 'shimasa_dignity') useShimasaDignity();
  if (id === 'eiko_final') useEikoFinal();
  if (id === 'total_control') useTotalControl();
  updateActiveItemsDisplay();
  return true;
}

function autoCleanOnePoop() {
  // Find a random poop in current room to auto-clean
  const room = state.currentRoom;
  const poopsInRoom = state.poops[room];
  if (poopsInRoom.length === 0) return;
  const idx = Math.floor(Math.random() * poopsInRoom.length);
  const p = poopsInRoom[idx];
  playPikonSound();
  const sparkle = document.createElement('div');
  sparkle.className = 'sparkle';
  sparkle.textContent = 'üßπ';
  sparkle.style.left = p.el.style.left;
  sparkle.style.top = p.el.style.top;
  container.appendChild(sparkle);
  setTimeout(() => sparkle.remove(), 500);
  p.el.classList.add('cleaned');
  setTimeout(() => p.el.remove(), 300);
  poopsInRoom.splice(idx, 1);
  state.totalPoops--;
  state.score += 1;
  state.cleanedCount++;
  updateHUD();
  if (state.cleanedCount >= state.clearCount) {
    stageClear();
  }
}

// Spawn poop at specific position (used by misclick penalty and tom snack)
function spawnPoopAt(x, y) {
  const room = state.currentRoom;
  x = Math.max(10, Math.min(750, x));
  y = Math.max(50, Math.min(520, y));

  const el = document.createElement('div');
  el.className = 'poop';
  let scaleVar = 0.8 + Math.random() * 0.5;
  if (state.equippedItems.includes('evade_cloak')) scaleVar *= 0.9;
  const rotVar = -15 + Math.random() * 30;
  el.style.width = (36 * scaleVar) + 'px';
  el.style.height = (38 * scaleVar) + 'px';
  el.style.transform = 'rotate(' + rotVar + 'deg)';
  el.appendChild(createPoopSVG(36 * scaleVar, 38 * scaleVar));
  el.style.left = x + 'px';
  el.style.top = y + 'px';

  const id = ++state.poopIdCounter;
  el.dataset.id = id;
  el.dataset.room = room;
  el.addEventListener('click', (ev) => { ev.stopPropagation(); cleanPoop(room, id, el); });

  container.appendChild(el);
  state.poops[room].push({ id, x, y, el });
  state.totalPoops++;
  updateHUD();

  if (state.totalPoops >= state.maxPoop) gameOver();
}

// Pee puddle spawning (kitchen mechanic)
function spawnPeePuddle() {
  if (!state.running) return;
  const x = 60 + Math.random() * 660;
  const y = 100 + Math.random() * 380;
  const size = 50 + Math.random() * 40;

  const el = document.createElement('div');
  el.className = 'pee-puddle';
  el.style.left = x + 'px';
  el.style.top = y + 'px';
  el.style.width = size + 'px';
  el.style.height = (size * 0.6) + 'px';
  el.dataset.cx = String(x + size / 2);
  el.dataset.cy = String(y + size * 0.3);
  el.dataset.radius = String(size / 2);
  container.appendChild(el);

  // Tom pee animation
  tomEl.classList.add('pooping');
  setTimeout(() => tomEl.classList.remove('pooping'), 600);
  showStageIndicator('üí¶ „Éà„É†„Å°„ÇÉ„Çì„Åå„Åä„Åó„Å£„Åì„Åó„ÅüÔºÅ');

  // Puddle fades after 15-20 seconds
  setTimeout(() => {
    el.style.transition = 'opacity 1s';
    el.style.opacity = '0';
    setTimeout(() => el.remove(), 1000);
  }, 15000 + Math.random() * 5000);
}

// Eiko Awakening Mode (active item)
function useEikoAwaken() {
  if (!state.running || state.awakenUsed || !state.equippedItems.includes('eiko_awaken')) return;
  if (state.eikoStunned || state.eikoAwakenedStun) return;

  state.awakenUsed = true;
  state.eikoAwakened = true;
  eikoEl.classList.add('awakened');
  // Double movement speed (halve transition time)
  const fastTime = (state.eikoBaseTransTime / 2).toFixed(3);
  eikoEl.style.transition = 'left ' + fastTime + 's, top ' + fastTime + 's';
  // Switch to awakening BGM
  stopBGM();
  startAwakenBGM();
  // Synergy: ÂÖ®Âäõ„ÉÅ„É£„É≥„Çπ extends awakening to 10s
  const syn = getActiveSynergy();
  const awakenDuration = (syn && syn.name === 'ÂÖ®Âäõ„ÉÅ„É£„É≥„Çπ') ? 10000 : 7000;
  showStageIndicator('üî• „Åà„ÅÑ„ÅìË¶öÈÜíÔºÅ' + (awakenDuration / 1000) + 'ÁßíÈñìÂõûÂèéÁØÑÂõ≤2ÂÄç+ÁßªÂãïÈÄüÂ∫¶2ÂÄçÔºÅ');
  updateActiveItemsDisplay();

  awakenTimer = setTimeout(() => {
    state.eikoAwakened = false;
    eikoEl.classList.remove('awakened');
    // Restore normal movement speed
    const baseTime = state.eikoBaseTransTime.toFixed(3);
    eikoEl.style.transition = 'left ' + baseTime + 's, top ' + baseTime + 's';
    // Restore normal BGM
    stopAwakenBGM();
    if (state.running) startBGM(state.currentStage);

    // 1.5 second stun (no control)
    state.eikoAwakenedStun = true;
    eikoEl.classList.add('stunned');
    showStageIndicator('üòµ Ë¶öÈÜí„ÅÆÂèçÂãïÔºÅ1.5ÁßíÈñìÊìç‰Ωú‰∏çËÉΩÔºÅ');

    awakenStunTimer = setTimeout(() => {
      state.eikoAwakenedStun = false;
      eikoEl.classList.remove('stunned');
      if (state.running) showStageIndicator('Êìç‰ΩúÂõûÂæ©ÔºÅ');
    }, 1500);
  }, awakenDuration);
}

// Tom Snack (active item)
function useTomSnack() {
  if (!state.running || state.tomSnackUsed || !state.equippedItems.includes('tom_snack')) return;
  if (tomCaged) return;

  state.tomSnackUsed = true;
  state.tomFrozen = true;
  tomEl.classList.add('frozen');
  showStageIndicator('ü¶¥ „Åä„ÇÑ„Å§„Åß„Éà„É†5ÁßíÂÅúÊ≠¢ÔºÅ');
  updateActiveItemsDisplay();

  tomSnackTimer = setTimeout(() => {
    state.tomFrozen = false;
    tomEl.classList.remove('frozen');
    showStageIndicator('‚ö† „Éà„É†Âæ©Ê¥ªÔºÅ„ÅÜ„Çì„Å°1„Å§ËøΩÂä†ÔºÅ');

    // Spawn 1 poop at random position
    spawnPoopAt(40 + Math.random() * 700, 80 + Math.random() * 420);
  }, 5000);
}

function useShimasaDignity() {
  if (!state.running || state.shimasaDignityUsed || !state.equippedItems.includes('shimasa_dignity')) return;

  state.shimasaDignityUsed = true;
  updateActiveItemsDisplay();

  // Summon shimasa: Tom freezes 5 seconds + remove up to 3 poops
  state.tomFrozen = true;
  state.spawnFrozen = true;
  tomEl.classList.add('frozen', 'scolded');
  playShimasaDrone();
  showStageIndicator('üë¥ „Åó„Åæ„Åï„ÅÆÂ®ÅÂé≥Áô∫ÂãïÔºÅ„Éà„É†5ÁßíÂÅúÊ≠¢+„ÅÜ„Çì„Å°Ê∂àÊªÖÔºÅ');

  // Remove up to 3 poops from current room
  const room = state.currentRoom;
  let removed = 0;
  while (state.poops[room].length > 0 && removed < 3) {
    const p = state.poops[room].pop();
    if (p.el && p.el.parentNode) p.el.remove();
    state.totalPoops = Math.max(0, state.totalPoops - 1);
    removed++;
  }
  updateHUD();

  setTimeout(() => {
    state.tomFrozen = false;
    state.spawnFrozen = false;
    tomEl.classList.remove('frozen', 'scolded');

    // Side effect: Tom panics (synergy ÊÅêÊÄñÊµÑÂåñ nullifies)
    const dSyn = getActiveSynergy();
    const panicCount = (dSyn && dSyn.name === 'ÊÅêÊÄñÊµÑÂåñ') ? 0 : 2;
    if (panicCount > 0) {
      showStageIndicator('‚ö† „Éà„É†„Åå„Éë„Éã„ÉÉ„ÇØÔºÅ„ÅÜ„Çì„Å°' + panicCount + 'ÂÄãÔºÅ');
      for (let i = 0; i < panicCount; i++) {
        setTimeout(() => {
          if (state.running) spawnPoopAt(40 + Math.random() * 700, 80 + Math.random() * 420);
        }, i * 300);
      }
    } else {
      showStageIndicator('üíÄ ÊÅêÊÄñÊµÑÂåñÔºÅÂâØ‰ΩúÁî®„Å™„ÅóÔºÅ');
    }
  }, 5000);
}

// Crafted active: „Åà„ÅÑ„ÅìÊúÄÁµÇÂΩ¢ÊÖã (10s awakening + tom freeze + remove 5 poops)
function useEikoFinal() {
  if (!state.running || state.eikoFinalUsed || !state.equippedItems.includes('eiko_final')) return;
  if (state.eikoStunned || state.eikoAwakenedStun) return;

  state.eikoFinalUsed = true;
  state.awakenUsed = true;
  state.eikoAwakened = true;
  eikoEl.classList.add('awakened');
  const fastTime = (state.eikoBaseTransTime / 2).toFixed(3);
  eikoEl.style.transition = 'left ' + fastTime + 's, top ' + fastTime + 's';
  stopBGM();
  startAwakenBGM();

  // Also freeze Tom
  state.tomFrozen = true;
  state.spawnFrozen = true;
  tomEl.classList.add('frozen');
  playShimasaDrone();
  showStageIndicator('üë∏ „Åà„ÅÑ„ÅìÊúÄÁµÇÂΩ¢ÊÖãÔºÅ10ÁßíË¶öÈÜí+„Éà„É†ÂÅúÊ≠¢+„ÅÜ„Çì„Å°5ÂÄãÊ∂àÊªÖÔºÅ');
  updateActiveItemsDisplay();

  // Remove up to 5 poops
  const room = state.currentRoom;
  let removed = 0;
  while (state.poops[room].length > 0 && removed < 5) {
    const p = state.poops[room].pop();
    if (p.el && p.el.parentNode) p.el.remove();
    state.totalPoops = Math.max(0, state.totalPoops - 1);
    removed++;
  }
  updateHUD();

  awakenTimer = setTimeout(() => {
    state.eikoAwakened = false;
    state.tomFrozen = false;
    state.spawnFrozen = false;
    eikoEl.classList.remove('awakened');
    tomEl.classList.remove('frozen');
    const baseTime = state.eikoBaseTransTime.toFixed(3);
    eikoEl.style.transition = 'left ' + baseTime + 's, top ' + baseTime + 's';
    stopAwakenBGM();
    if (state.running) startBGM(state.currentStage);

    // 2 second stun
    state.eikoAwakenedStun = true;
    eikoEl.classList.add('stunned');
    showStageIndicator('üòµ ÊúÄÁµÇÂΩ¢ÊÖã„ÅÆÂèçÂãïÔºÅ2ÁßíÈñìÊìç‰Ωú‰∏çËÉΩÔºÅ');
    awakenStunTimer = setTimeout(() => {
      state.eikoAwakenedStun = false;
      eikoEl.classList.remove('stunned');
      if (state.running) showStageIndicator('Êìç‰ΩúÂõûÂæ©ÔºÅ');
    }, 2000);
  }, 10000);
}

// Crafted active: ÂÆåÂÖ®Âà∂Âúß„Çª„ÉÉ„Éà (6s spawn stop + 6s tom freeze)
function useTotalControl() {
  if (!state.running || state.totalControlUsed || !state.equippedItems.includes('total_control')) return;

  state.totalControlUsed = true;
  state.spawnFrozen = true;
  state.tomFrozen = true;
  tomEl.classList.add('frozen');
  showStageIndicator('üéØ ÂÆåÂÖ®Âà∂ÂúßÔºÅ6ÁßíÈñìÁô∫ÁîüÂÅúÊ≠¢+„Éà„É†ÂáçÁµêÔºÅ');
  updateActiveItemsDisplay();

  setTimeout(() => {
    state.spawnFrozen = false;
    state.tomFrozen = false;
    tomEl.classList.remove('frozen');
    if (!state.running) return;

    // Side effect: 4s +50% spawn rate
    state.deodorantDebuff = true;
    showStageIndicator('‚ö† Âà∂Âúß„ÅÆÂèçÂãïÔºÅ4ÁßíÈñìÁô∫ÁîüÁéá1.5ÂÄçÔºÅ');
    setTimeout(() => {
      state.deodorantDebuff = false;
      if (state.running) showStageIndicator('Áô∫ÁîüÁéá„ÅåÈÄöÂ∏∏„Å´Êàª„Å£„Åü');
    }, 4000);
  }, 6000);
}

// Shimasa scold event: 1 in 3 chance per stage, random timing
function scheduleShimasaScold() {
  if (!state.running) return;
  if (Math.random() > (1 / 3)) return;
  // Appear at random time during the stage (3s ~ 22s in)
  const delay = 3000 + Math.random() * 19000;
  shimasaScoldTimer = setTimeout(() => {
    if (!state.running) return;
    triggerShimasaScold();
  }, delay);
}

function triggerShimasaScold() {
  playShimasaDrone();
  // Show shimasa scold banner with face SVG
  const warn = document.createElement('div');
  warn.className = 'shimasa-scold';
  warn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 80 80">' +
    '<!-- Head (round, slightly soft 50s man) -->' +
    '<ellipse cx="40" cy="40" rx="27" ry="30" fill="#E0B88A"/>' +
    '<ellipse cx="40" cy="43" rx="23" ry="25" fill="#E8C49A"/>' +
    '<!-- Jaw (rounded, mild jowls) -->' +
    '<path d="M17 44 Q20 66 40 70 Q60 66 63 44" fill="#E0B88A"/>' +
    '<path d="M21 46 Q24 62 40 66 Q56 62 59 46" fill="#E8C49A"/>' +
    '<!-- Hair (short, neat, graying black, receding a bit) -->' +
    '<path d="M16 30 Q17 12 26 11 Q32 8 40 10 Q48 8 54 11 Q63 12 64 30" fill="#3a3a3a"/>' +
    '<path d="M16 30 Q17 14 26 13 Q32 10 40 12 Q48 10 54 13 Q63 14 64 30" fill="#4a4a4a"/>' +
    '<!-- Gray streaks -->' +
    '<path d="M22 16 Q26 12 30 15" stroke="#999" stroke-width="0.8" fill="none"/>' +
    '<path d="M50 14 Q54 11 58 16" stroke="#999" stroke-width="0.8" fill="none"/>' +
    '<path d="M35 11 Q40 9 45 11" stroke="#888" stroke-width="0.6" fill="none"/>' +
    '<!-- Forehead wrinkles -->' +
    '<path d="M25 24 Q33 22 40 24 Q47 22 55 24" stroke="#C8A070" stroke-width="0.7" fill="none"/>' +
    '<path d="M28 27 Q34 25.5 40 27 Q46 25.5 52 27" stroke="#C8A070" stroke-width="0.6" fill="none"/>' +
    '<!-- Eyebrows (thick, slightly bushy, angry angle) -->' +
    '<path d="M23 30 Q28 27 35 29" stroke="#3a3a3a" stroke-width="2.5" stroke-linecap="round" fill="none"/>' +
    '<path d="M45 29 Q52 27 57 30" stroke="#3a3a3a" stroke-width="2.5" stroke-linecap="round" fill="none"/>' +
    '<!-- Eyes (normal round, stern look) -->' +
    '<ellipse cx="29" cy="34" rx="6" ry="4.5" fill="#fff"/>' +
    '<circle cx="30" cy="34" r="3" fill="#2c1a0a"/>' +
    '<circle cx="30.5" cy="33.5" r="1" fill="#fff"/>' +
    '<ellipse cx="51" cy="34" rx="6" ry="4.5" fill="#fff"/>' +
    '<circle cx="50" cy="34" r="3" fill="#2c1a0a"/>' +
    '<circle cx="50.5" cy="33.5" r="1" fill="#fff"/>' +
    '<!-- Eyelids (slight droop, age) -->' +
    '<path d="M23 32 Q29 29 35 32" stroke="#C8A070" stroke-width="0.8" fill="none"/>' +
    '<path d="M45 32 Q51 29 57 32" stroke="#C8A070" stroke-width="0.8" fill="none"/>' +
    '<!-- Under-eye bags -->' +
    '<path d="M24 37 Q29 39 34 37" stroke="#D0A878" stroke-width="0.6" fill="none"/>' +
    '<path d="M46 37 Q51 39 56 37" stroke="#D0A878" stroke-width="0.6" fill="none"/>' +
    '<!-- Nose (normal, slightly wide) -->' +
    '<path d="M38 35 L37 45 Q40 48 43 45 L42 35" fill="#D4A87A" opacity="0.5"/>' +
    '<ellipse cx="37.5" cy="45.5" rx="2.5" ry="1.8" fill="#D4A87A" opacity="0.4"/>' +
    '<ellipse cx="42.5" cy="45.5" rx="2.5" ry="1.8" fill="#D4A87A" opacity="0.4"/>' +
    '<!-- Nasolabial folds -->' +
    '<path d="M33 43 Q31 52 33 58" stroke="#C8A070" stroke-width="0.7" fill="none"/>' +
    '<path d="M47 43 Q49 52 47 58" stroke="#C8A070" stroke-width="0.7" fill="none"/>' +
    '<!-- Mouth (open, yelling) -->' +
    '<path d="M31 56 Q36 53 40 54 Q44 53 49 56 Q44 61 40 62 Q36 61 31 56Z" fill="#c44"/>' +
    '<path d="M33 56 Q37 54.5 40 55 Q43 54.5 47 56" fill="#fff" opacity="0.85"/>' +
    '<path d="M34 59 Q37 61 40 61.5 Q43 61 46 59" fill="#922" opacity="0.4"/>' +
    '<!-- Ears -->' +
    '<ellipse cx="13" cy="37" rx="5" ry="7" fill="#E0B88A"/>' +
    '<ellipse cx="14" cy="37" rx="3" ry="5" fill="#D4A87A" opacity="0.4"/>' +
    '<ellipse cx="67" cy="37" rx="5" ry="7" fill="#E0B88A"/>' +
    '<ellipse cx="66" cy="37" rx="3" ry="5" fill="#D4A87A" opacity="0.4"/>' +
    '<!-- Angry vein -->' +
    '<path d="M52 20 L54 17 L52.5 20 L55.5 18.5" stroke="#e55" stroke-width="1" fill="none"/>' +
    '</svg>' +
    '<span class="scold-text">„Åó„Åæ„Åï„Äå„Åì„ÇâÔºÅ„Éà„É†ÔºÅ„Äç</span>';
  container.appendChild(warn);
  setTimeout(() => warn.remove(), 2500);

  // Tom shakes in fear
  tomEl.classList.add('scolded');
  setTimeout(() => tomEl.classList.remove('scolded'), 1200);

  // Activate 2x poop/pee for 5 seconds
  state.shimasaScolding = true;
  showStageIndicator('üò± „Éà„É†„Åå„Éì„Éì„Å£„Å¶„ÅÜ„Çì„Å°„Éª„Åä„Åó„Å£„Åì2ÂÄçÔºÅ5ÁßíÈñì');

  shimasaScoldEndTimer = setTimeout(() => {
    state.shimasaScolding = false;
    if (state.running) showStageIndicator('„Éà„É†„ÅåËêΩ„Å°ÁùÄ„ÅÑ„Åü...');
  }, 5000);
}

function useDeodorant() {
  if (!state.running || state.deodorantUsed || !state.equippedItems.includes('strong_deodorant')) return;
  state.deodorantUsed = true;
  state.spawnFrozen = true;
  showStageIndicator('üß¥ Ê∂àËá≠Ââ§Áô∫ÂãïÔºÅ4ÁßíÈñì„ÅÜ„Çì„Å°Áô∫ÁîüÂÅúÊ≠¢ÔºÅ');
  updateActiveItemsDisplay();

  // After 4 seconds: end freeze, start debuff (+50% spawn rate for 4s)
  sprayTimer = setTimeout(() => {
    state.spawnFrozen = false;
    state.deodorantDebuff = true;
    showStageIndicator('‚ö† Ê∂àËá≠Ââ§„ÅÆÂâØ‰ΩúÁî®ÔºÅÁô∫ÁîüÁéá1.5ÂÄçÔºÅ4ÁßíÈñì');
    // After 4 seconds: debuff ends
    setTimeout(() => {
      state.deodorantDebuff = false;
      if (state.running) showStageIndicator('Ê∂àËá≠Ââ§„ÅÆÂâØ‰ΩúÁî®„ÅåÁµÇ‰∫Ü');
    }, 4000);
  }, 4000);
}

// Container click handler: selected item activation, awakened area clean, misclick penalty
container.addEventListener('click', (e) => {
  if (!state.running) return;
  // Skip UI / entity clicks
  if (e.target.closest('button') || e.target.closest('.active-item-btn') || e.target.closest('#hud')) return;
  if (e.target.closest('#tom')) return;
  const clickedPoop = e.target.closest('.poop');

  // Stun check
  if (state.eikoStunned || state.eikoAwakenedStun) return;

  // If an active item is selected, activate it on click (anywhere)
  if (state.selectedActiveItem && !clickedPoop) {
    activateSelectedItem();
    return;
  }

  // Awakened mode: area-of-effect poop collection on any click
  if (state.eikoAwakened && !clickedPoop) {
    const coords = getGameCoords(e);
    const clickX = coords.x;
    const clickY = coords.y;
    const range = 70;
    const room = state.currentRoom;
    const toClean = [];
    state.poops[room].forEach(p => {
      const poopCX = parseFloat(p.el.style.left) + 18;
      const poopCY = parseFloat(p.el.style.top) + 19;
      const dist = Math.sqrt(Math.pow(clickX - poopCX, 2) + Math.pow(clickY - poopCY, 2));
      if (dist < range) toClean.push(p);
    });
    if (toClean.length > 0) {
      toClean.forEach(p => cleanPoop(room, p.id, p.el));
      return;
    }
  }

  if (clickedPoop) return; // Normal poop click handled by its own listener

  // Misclick penalty (eiko room mechanic) - spawns 2 poops
  const currentCfg = STAGES[state.currentStage];
  if (currentCfg.mechanic === 'misclick_penalty') {
    const coords = getGameCoords(e);
    const mx = coords.x;
    const my = coords.y;
    const flash = document.createElement('div');
    flash.className = 'misclick-flash';
    container.appendChild(flash);
    setTimeout(() => flash.remove(), 350);
    spawnPoopAt(mx, my);
    spawnPoopAt(mx + (-30 + Math.random() * 60), my + (-30 + Math.random() * 60));
    showStageIndicator(misclickWord + 'ÔºÅ„ÅÜ„Çì„Å°2ÂÄãËøΩÂä†ÔºÅ');
  }
});

// Keyboard shortcuts for active items (1/2 keys toggle selection)
document.addEventListener('keydown', (e) => {
  if (!state.running) return;
  if (e.key === '1' || e.key === '2') {
    const slotIdx = parseInt(e.key) - 1;
    const itemId = state.equippedItems[slotIdx];
    if (!itemId) return;
    const item = findItem(itemId);
    if (!item || item.type !== 'active') return;
    let used = false;
    if (itemId === 'strong_deodorant') used = state.deodorantUsed;
    if (itemId === 'eiko_awaken') used = state.awakenUsed;
    if (itemId === 'tom_snack') used = state.tomSnackUsed;
    if (itemId === 'shimasa_dignity') used = state.shimasaDignityUsed;
    if (itemId === 'eiko_final') used = state.eikoFinalUsed;
    if (itemId === 'total_control') used = state.totalControlUsed;
    if (used) return;
    toggleActiveItem(itemId);
  }
  // Escape to deselect
  if (e.key === 'Escape' && state.selectedActiveItem) {
    state.selectedActiveItem = null;
    container.classList.remove('item-selected');
    updateActiveItemsDisplay();
  }
});

// Mess events: trash, scratch, water
function spawnTrash() {
  if (!state.running) return;
  // Find trash can in the active room
  const activeRoom = document.querySelector('.room.active');
  const trashCan = activeRoom ? activeRoom.querySelector('.trash-can') : null;
  let canRect = null;
  let canX = 750, canY = 530; // fallback position (bottom-right)
  if (trashCan) {
    canRect = trashCan.getBoundingClientRect();
    const containerRect = container.getBoundingClientRect();
    canX = (canRect.left - containerRect.left) / gameScale + canRect.width / (2 * gameScale);
    canY = (canRect.top - containerRect.top) / gameScale + canRect.height / (2 * gameScale);
    // Shake the trash can
    trashCan.classList.remove('shaking');
    void trashCan.offsetWidth;
    trashCan.classList.add('shaking');
    setTimeout(() => trashCan.classList.remove('shaking'), 400);
  }
  // Final landing position: scatter around the trash can
  const angle = Math.random() * Math.PI * 2;
  const dist = 60 + Math.random() * 120;
  const finalX = Math.max(10, Math.min(760, canX + Math.cos(angle) * dist));
  const finalY = Math.max(50, Math.min(540, canY + Math.sin(angle) * dist));

  const el = document.createElement('div');
  el.className = 'mess mess-trash';
  el.textContent = 'üì∞';
  // Start at trash can position
  el.style.left = canX + 'px';
  el.style.top = canY + 'px';
  el.style.opacity = '0.5';
  el.style.transform = 'scale(0.3)';
  el.style.transition = 'left 0.4s ease-out, top 0.4s ease-out, opacity 0.3s, transform 0.3s';
  el.addEventListener('click', (ev) => { ev.stopPropagation(); cleanMess('trash', el); });
  container.appendChild(el);
  // Animate: fly out from trash can to landing position
  requestAnimationFrame(() => {
    requestAnimationFrame(() => {
      el.style.left = finalX + 'px';
      el.style.top = finalY + 'px';
      el.style.opacity = '1';
      el.style.transform = 'scale(1)';
    });
  });
  // After fly-out animation, switch to float animation
  setTimeout(() => {
    if (el.parentNode && !el.classList.contains('cleaned')) {
      el.style.transition = 'transform 0.2s, opacity 0.3s';
    }
  }, 450);

  state.trashCount++;
  // Debuff: 3+ trash = +50% poop rate for 5s
  if (state.trashCount >= 3 && !state.trashDebuff) {
    state.trashDebuff = true;
    state.bgmDetune = 30; // Dissonance during trash debuff
    showStageIndicator('‚ö† „Ç¥„Éü„ÅåÊ∫ú„Åæ„Å£„ÅüÔºÅ„ÅÜ„Çì„Å°Áô∫ÁîüÁéá+50%ÔºÅ');
    setTimeout(() => {
      state.trashDebuff = false;
      state.bgmDetune = 0;
      if (state.running && state.trashCount < 3) showStageIndicator('„Ç¥„Éü„Éá„Éê„ÉïËß£Èô§');
    }, 5000);
  }
  showStageIndicator('üóëÔ∏è „Éà„É†„Åå„Ç¥„ÉüÁÆ±„ÇíËçí„Çâ„Åó„ÅüÔºÅ');
}

function spawnScratch() {
  if (!state.running) return;
  const x = 60 + Math.random() * 680;
  const y = 80 + Math.random() * 420;
  const el = document.createElement('div');
  el.className = 'mess mess-scratch';
  el.textContent = 'üêæ';
  el.style.left = x + 'px';
  el.style.top = y + 'px';
  el.addEventListener('click', (ev) => { ev.stopPropagation(); cleanMess('scratch', el); });
  container.appendChild(el);
  showStageIndicator('üêæ „Éà„É†„ÅåÂºï„Å£Êéª„ÅÑ„ÅüÔºÅ');
  // Auto-disappear after 4s with -5 point penalty
  const scratchTimer = setTimeout(() => {
    if (!el.parentNode || el.classList.contains('cleaned')) return;
    el.classList.add('cleaned');
    setTimeout(() => el.remove(), 300);
    state.score = Math.max(0, state.score - 5);
    showStageIndicator('üí¢ „Å≤„Å£„Åã„ÅçÂÇ∑ÊîæÁΩÆÔºÅ-5ÁÇπ');
    updateHUD();
  }, 4000);
  el.dataset.scratchTimer = scratchTimer;
}

function spawnWater() {
  if (!state.running) return;
  const x = state.yokoX + (-20 + Math.random() * 40);
  const y = state.yokoY + (40 + Math.random() * 30);
  const el = document.createElement('div');
  el.className = 'mess mess-water';
  el.textContent = 'üíß';
  el.style.left = Math.max(10, Math.min(760, x)) + 'px';
  el.style.top = Math.max(50, Math.min(540, y)) + 'px';
  el.addEventListener('click', (ev) => { ev.stopPropagation(); cleanMess('water', el); });
  container.appendChild(el);
  showStageIndicator('üíß „Çà„ÅÜ„Åì„ÅåÊ∞¥„Çí„Åì„Åº„Åó„ÅüÔºÅ');
  // After 8s, becomes a pee puddle if not cleaned
  const waterTimer = setTimeout(() => {
    if (!el.parentNode || el.classList.contains('cleaned')) return;
    el.remove();
    // Convert to actual pee puddle
    if (typeof spawnPeePuddle === 'function') {
      spawnPeePuddle();
      showStageIndicator('üí¶ Ê∞¥„Åì„Åº„Åó„ÅåÊ∞¥„Åü„Åæ„Çä„Å´ÔºÅ');
    }
  }, 8000);
  el.dataset.waterTimer = waterTimer;
}

function cleanMess(type, el) {
  if (!state.running) return;
  if (el.classList.contains('cleaned')) return;
  el.classList.add('cleaned');
  // Cancel pending timers
  if (el.dataset.scratchTimer) clearTimeout(parseInt(el.dataset.scratchTimer));
  if (el.dataset.waterTimer) clearTimeout(parseInt(el.dataset.waterTimer));
  setTimeout(() => el.remove(), 300);
  state.score += 2;
  if (type === 'trash') {
    state.trashCount = Math.max(0, state.trashCount - 1);
  }
  // Score popup
  const px = parseFloat(el.style.left);
  const py = parseFloat(el.style.top);
  const popup = document.createElement('div');
  popup.className = 'score-popup normal';
  popup.textContent = '+2';
  popup.style.left = px + 'px';
  popup.style.top = (py - 10) + 'px';
  container.appendChild(popup);
  setTimeout(() => popup.remove(), 700);
  playPikonSound();
  updateHUD();
}

function switchRoom(room) {
  state.currentRoom = room;
  ROOMS.forEach(r => {
    document.getElementById('room-' + r).classList.toggle('active', r === room);
  });
}

function spawnPoop() {
  if (tomCaged) return;
  if (state.spawnFrozen) return;
  if (state.tomFrozen) return;

  const room = state.currentRoom;
  const x = 40 + Math.random() * 700;
  const y = 80 + Math.random() * 420;

  const el = document.createElement('div');
  el.className = 'poop';
  let scaleVar = 0.8 + Math.random() * 0.5;
  if (state.equippedItems.includes('evade_cloak')) scaleVar *= 0.9;
  const rotVar = -15 + Math.random() * 30;
  el.style.width = (36 * scaleVar) + 'px';
  el.style.height = (38 * scaleVar) + 'px';
  el.style.transform = 'rotate(' + rotVar + 'deg)';
  el.appendChild(createPoopSVG(36 * scaleVar, 38 * scaleVar));
  el.style.left = x + 'px';
  el.style.top = y + 'px';

  const id = ++state.poopIdCounter;
  el.dataset.id = id;
  el.dataset.room = room;

  // Stage mechanics: hidden poop (shimasa) or trap poop (eiko room)
  const spawnCfg = STAGES[state.currentStage];
  if (spawnCfg.mechanic === 'hidden_poop' && Math.random() < 0.35) {
    el.classList.add('hidden-poop');
  }
  if (spawnCfg.mechanic === 'misclick_penalty' && Math.random() < 0.2) {
    el.classList.add('trap-poop');
    el.dataset.trap = 'true';
  }

  el.addEventListener('click', (ev) => {
    ev.stopPropagation();
    // Trap poop: clicking spawns 2 extra poops then cleans
    if (el.dataset.trap === 'true') {
      el.dataset.trap = 'done';
      showStageIndicator('üíÄ „Éà„É©„ÉÉ„Éó„ÅÜ„Çì„Å°ÔºÅ2ÂÄãËøΩÂä†ÔºÅ');
      for (let ti = 0; ti < 2; ti++) {
        spawnPoopAt(40 + Math.random() * 700, 80 + Math.random() * 420);
      }
    }
    cleanPoop(room, id, el);
  });

  el.classList.add('dropping');
  container.appendChild(el);
  setTimeout(() => el.classList.remove('dropping'), 400);
  state.poops[room].push({ id, x, y, el });
  state.totalPoops++;

  tomEl.classList.add('pooping');
  tomEl.classList.add('squatting');
  setTimeout(() => { tomEl.classList.remove('pooping'); tomEl.classList.remove('squatting'); }, 600);

  updateHUD();

  if (state.totalPoops >= state.maxPoop) {
    gameOver();
  }
}

function cleanPoop(room, id, el) {
  if (!state.running) return;
  // Stun check: can't clean when stunned
  if (state.eikoStunned || state.eikoAwakenedStun) return;
  const idx = state.poops[room].findIndex(p => p.id === id);
  if (idx === -1) return;

  // Play pikon sound
  playPikonSound();

  // Move Eiko toward poop
  const px = parseFloat(el.style.left);
  const py = parseFloat(el.style.top);
  eikoX = px;
  eikoY = py - 10;
  updateEikoPosition();

  // Slippery mechanic: Eiko slides past target
  const currentCfg = STAGES[state.currentStage];
  if (currentCfg.mechanic === 'slippery' && currentCfg.slideDist > 0) {
    const sd = currentCfg.slideDist;
    const slideX = Math.max(10, Math.min(740, eikoX + (Math.random() > 0.5 ? 1 : -1) * (sd * 0.6 + Math.random() * sd * 0.4)));
    const slideY = Math.max(50, Math.min(510, eikoY + (Math.random() > 0.5 ? 1 : -1) * (sd * 0.6 + Math.random() * sd * 0.4)));
    eikoX = slideX;
    eikoY = slideY;
    updateEikoPosition();
    const correctX = px;
    const correctY = py - 10;
    slideCorrectTimer = setTimeout(() => {
      eikoX = correctX;
      eikoY = correctY;
      updateEikoPosition();
    }, 350);
  }

  // Pee puddle mechanic: check if Eiko lands near a puddle
  if (currentCfg.mechanic === 'pee_puddle' && !state.equippedItems.includes('evade_cloak') && !state.equippedItems.includes('full_armor') && !state.eikoStunned) {
    const puddles = document.querySelectorAll('.pee-puddle');
    puddles.forEach(puddle => {
      const pcx = parseFloat(puddle.dataset.cx);
      const pcy = parseFloat(puddle.dataset.cy);
      const pr = parseFloat(puddle.dataset.radius);
      const dist = Math.sqrt(Math.pow(px - pcx, 2) + Math.pow((py - 10) - pcy, 2));
      if (dist < pr + 30) {
        state.eikoStunned = true;
        eikoEl.classList.add('stunned');
        showStageIndicator('üí¶ „Åä„Åó„Å£„Åì„ÅßÊªë„Å£„ÅüÔºÅ1.5ÁßíÈñìÊìç‰Ωú‰∏çËÉΩÔºÅ');
        setTimeout(() => {
          state.eikoStunned = false;
          eikoEl.classList.remove('stunned');
        }, 1500);
      }
    });
  }

  // Sparkle effect
  const sparkle = document.createElement('div');
  sparkle.className = 'sparkle';
  sparkle.textContent = 'üßπ';
  sparkle.style.left = px + 'px';
  sparkle.style.top = py + 'px';
  container.appendChild(sparkle);
  setTimeout(() => sparkle.remove(), 500);

  // Remove poop
  el.classList.add('cleaned');
  setTimeout(() => el.remove(), 300);

  state.poops[room].splice(idx, 1);
  state.totalPoops--;
  state.cleanedCount++;

  // Combo system
  clearTimeout(state.comboTimer);
  state.comboCount++;
  if (state.comboCount > state.maxCombo) state.maxCombo = state.comboCount;

  // Combo bonus: base 3 + combo bonus
  const comboBonus = state.comboCount >= 3 ? Math.min(state.comboCount - 2, 5) : 0;
  const baseScore = 3 + comboBonus;
  state.score += baseScore * (state.luckyScoreMultiplier || 1);

  // Score popup (simple)
  const scorePopup = document.createElement('div');
  scorePopup.className = 'score-popup';
  scorePopup.textContent = '+' + baseScore;
  scorePopup.style.left = px + 'px';
  scorePopup.style.top = (py - 10) + 'px';
  container.appendChild(scorePopup);
  setTimeout(() => scorePopup.remove(), 700);

  // Combo display update + sound at milestones
  updateComboDisplay();
  if (state.comboCount === 3 || state.comboCount === 5 || state.comboCount === 10 || state.comboCount === 15) {
    playComboSound(state.comboCount);
  }

  // Reset combo after 1.5s of no cleanup
  state.comboTimer = setTimeout(() => {
    state.comboCount = 0;
    updateComboDisplay();
  }, 1500);

  updateHUD();

  // Clear check: reached required clean count
  if (state.cleanedCount >= state.clearCount) {
    stageClear();
  }
}

function updateComboDisplay() {
  const el = document.getElementById('combo-display');
  if (state.comboCount >= 3) {
    el.textContent = state.comboCount + ' COMBO!';
    el.classList.add('active');
    el.classList.remove('hot', 'fire');
    if (state.comboCount >= 10) el.classList.add('fire');
    else if (state.comboCount >= 5) el.classList.add('hot');
  } else {
    el.classList.remove('active', 'hot', 'fire');
  }
}

function playComboSound(combo) {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const now = ctx.currentTime;
    // Higher combo = higher pitch ascending notes
    const baseFreq = 400 + combo * 30;
    const notes = combo >= 10 ? [0, 4, 7, 12] : combo >= 5 ? [0, 4, 7] : [0, 4];
    notes.forEach((semi, i) => {
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.type = 'triangle';
      osc.frequency.value = baseFreq * Math.pow(2, semi / 12);
      gain.gain.setValueAtTime(0.12, now + i * 0.08);
      gain.gain.exponentialRampToValueAtTime(0.01, now + i * 0.08 + 0.3);
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start(now + i * 0.08);
      osc.stop(now + i * 0.08 + 0.35);
    });
  } catch (e) {}
}

// === Juice / Polish helper functions ===

function triggerShake(cls) {
  container.classList.remove('shake', 'shake-hard', 'cage-slam');
  void container.offsetWidth; // force reflow to restart animation
  container.classList.add(cls);
  setTimeout(() => container.classList.remove(cls), 250);
}

function cageTom() {
  if (!state.running || tomCaged || cageCooldown) return;
  if (state.tomRoom !== state.currentRoom) return;
  if (state.tomHiding) return;

  tomCaged = true;
  tomEl.classList.add('caged');
  playKyainSound();
  triggerShake('cage-slam');
  showStageIndicator('üîí „Éà„É†„Å°„ÇÉ„Çì„Çí„Ç±„Éº„Ç∏„Å´ÂÖ•„Çå„ÅüÔºÅ');

  // Show cage timer bar
  const barContainer = document.getElementById('cage-timer-bar');
  const barFill = barContainer.querySelector('.bar-fill');
  barContainer.style.display = '';
  barFill.style.width = '100%';
  const cageStart = Date.now();
  cageBarInterval = setInterval(() => {
    const elapsed = Date.now() - cageStart;
    const pct = Math.max(0, 100 - (elapsed / CAGE_DURATION) * 100);
    barFill.style.width = pct + '%';
  }, 50);

  state.score += 5;
  updateHUD();

  cageTimerHandle = setTimeout(() => {
    releaseTom();
  }, CAGE_DURATION);
}

function releaseTom() {
  tomCaged = false;
  tomEl.classList.remove('caged');
  document.getElementById('cage-timer-bar').style.display = 'none';
  clearInterval(cageBarInterval);

  showStageIndicator('üîì „Éà„É†„Å°„ÇÉ„Çì„Åå„Ç±„Éº„Ç∏„Åã„ÇâËÑ±Âá∫ÔºÅ');

  // Start cooldown
  cageCooldown = true;
  updateCageHint();
  const cdStart = Date.now();
  const cdInterval = setInterval(() => {
    const remaining = Math.ceil((CAGE_COOLDOWN - (Date.now() - cdStart)) / 1000);
    const cdText = document.getElementById('cage-cooldown-text');
    if (remaining > 0) {
      cdText.textContent = '(ÂÜç‰ΩøÁî®: ' + remaining + 'Áßí)';
    }
  }, 200);

  cageCooldownHandle = setTimeout(() => {
    cageCooldown = false;
    clearInterval(cdInterval);
    document.getElementById('cage-cooldown-text').textContent = '';
    updateCageHint();
  }, CAGE_COOLDOWN);
}

function resetCage() {
  tomCaged = false;
  cageCooldown = false;
  tomEl.classList.remove('caged');
  document.getElementById('cage-timer-bar').style.display = 'none';
  document.getElementById('cage-cooldown-text').textContent = '';
  clearTimeout(cageTimerHandle);
  clearTimeout(cageCooldownHandle);
  clearInterval(cageBarInterval);
}

function updateCageHint() {
  const hint = document.getElementById('cage-hint');
  if (!state.running) { hint.style.display = 'none'; return; }
  hint.style.display = '';
}

function moveTom() {
  if (tomCaged) return;
  state.tomX = 40 + Math.random() * 700;
  state.tomY = 80 + Math.random() * 420;
  tomEl.style.left = state.tomX + 'px';
  tomEl.style.top = state.tomY + 'px';
}

function moveYoko() {
  state.yokoX = 40 + Math.random() * 700;
  state.yokoY = 80 + Math.random() * 400;
  yokoEl.style.left = state.yokoX + 'px';
  yokoEl.style.top = state.yokoY + 'px';
}

// Lucky event system
function scheduleLuckyEvent() {
  if (!state.running) return;
  const delay = 10000 + Math.random() * 10000; // 10-20s
  luckyEventTimer = setTimeout(() => {
    if (!state.running) return;
    triggerLuckyEvent();
    scheduleLuckyEvent();
  }, delay);
}

function triggerLuckyEvent() {
  if (!state.running) return;
  const roll = Math.random();
  let type, msg, duration;

  if (roll < 1 / 3) {
    // Mini awakening (no side effects)
    type = 'awaken';
    msg = '‚≠ê „É©„ÉÉ„Ç≠„ÉºÔºÅ„Åà„ÅÑ„Åì„Éü„ÉãË¶öÈÜíÔºà3ÁßíÔºâÔºÅ';
    duration = 3000;
    if (!state.eikoAwakened) {
      state.eikoAwakened = true;
      eikoEl.classList.add('awakened');
      setTimeout(() => {
        if (state.running && !state.awakenUsed) {
          state.eikoAwakened = false;
          eikoEl.classList.remove('awakened');
        }
      }, duration);
    }
  } else if (roll < 2 / 3) {
    // Tom nap
    type = 'nap';
    msg = '‚≠ê „É©„ÉÉ„Ç≠„ÉºÔºÅ„Éà„É†ÊòºÂØùÔºà3ÁßíÔºâÔºÅ';
    duration = 3000;
    state.tomFrozen = true;
    state.spawnFrozen = true;
    tomEl.classList.add('frozen');
    setTimeout(() => {
      if (state.running) {
        state.tomFrozen = false;
        state.spawnFrozen = false;
        tomEl.classList.remove('frozen');
      }
    }, duration);
  } else {
    // Bonus time
    type = 'bonus';
    msg = '‚≠ê „É©„ÉÉ„Ç≠„ÉºÔºÅ„Éú„Éº„Éä„Çπ„Çø„Ç§„É†Ôºà5ÁßíÈñì„Çπ„Ç≥„Ç¢2ÂÄçÔºâÔºÅ';
    duration = 5000;
    state.luckyScoreMultiplier = 2;
    setTimeout(() => {
      state.luckyScoreMultiplier = 1;
      if (state.running) showStageIndicator('„Éú„Éº„Éä„Çπ„Çø„Ç§„É†ÁµÇ‰∫Ü');
    }, duration);
  }

  // Show flash banner
  const flash = document.createElement('div');
  flash.className = 'lucky-event-flash';
  flash.textContent = msg;
  container.appendChild(flash);
  setTimeout(() => flash.remove(), 1500);

  showStageIndicator(msg);
}

// === Tom Special Behaviors ===
function scheduleTomSpecial() {
  if (!state.running) return;
  const delay = 12000 + Math.random() * 13000; // 12-25s
  tomSpecialTimer = setTimeout(() => {
    triggerTomSpecial();
    scheduleTomSpecial();
  }, delay);
}

function triggerTomSpecial() {
  if (!state.running || tomCaged || state.tomFrozen || state.tomHiding) return;

  if (Math.random() < 0.5) {
    // Dash poop: run across screen dropping 3 poops
    showStageIndicator('üí® „Éà„É†„Åå„ÉÄ„ÉÉ„Ç∑„É•ÔºÅ');
    tomEl.classList.add('dashing');
    const startX = state.tomX < 400 ? 40 : 700;
    const endX = startX === 40 ? 700 : 40;
    const y = 80 + Math.random() * 420;
    tomEl.style.left = endX + 'px';
    tomEl.style.top = y + 'px';
    state.tomX = endX;
    state.tomY = y;

    // Spawn 3 poops along the path
    for (let i = 0; i < 3; i++) {
      setTimeout(() => {
        if (!state.running) return;
        const px = startX + (endX - startX) * ((i + 1) / 4);
        spawnPoopAt(px, y + (-20 + Math.random() * 40));
      }, i * 100);
    }

    setTimeout(() => {
      tomEl.classList.remove('dashing');
    }, 400);
  } else {
    // Hiding Tom: semi-transparent at screen edge, spawns poop
    showStageIndicator('ü´• „Éà„É†„ÅåÈö†„Çå„ÅüÔºÅ');
    state.tomHiding = true;
    tomEl.classList.add('hiding');
    tomEl.style.left = '10px';
    tomEl.style.top = (80 + Math.random() * 420) + 'px';
    state.tomX = 10;

    // Spawn poops while hiding
    let hidePoopCount = 0;
    const hidePoop = setInterval(() => {
      if (!state.running || !state.tomHiding || hidePoopCount >= 2) {
        clearInterval(hidePoop);
        return;
      }
      spawnPoop();
      hidePoopCount++;
    }, 2000);

    setTimeout(() => {
      state.tomHiding = false;
      tomEl.classList.remove('hiding');
      if (state.running) showStageIndicator('„Éà„É†„ÅåÂá∫„Å¶„Åç„ÅüÔºÅ');
    }, 5000);
  }
}

// === Weather Events ===
function scheduleWeather() {
  if (!state.running) return;
  const delay = 15000 + Math.random() * 15000; // 15-30s
  weatherTimer = setTimeout(() => {
    triggerWeather();
    scheduleWeather();
  }, delay);
}

function triggerWeather() {
  if (!state.running) return;

  if (Math.random() < 0.5) {
    // Rain: dark visibility for 8 seconds
    showStageIndicator('üåßÔ∏è Èõ®„ÅåÈôç„Å£„Å¶„Åç„ÅüÔºÅË¶ñÁïå„ÅåÊÇ™„ÅÑÔºÅ');
    const rain = document.createElement('div');
    rain.className = 'weather-rain';
    container.appendChild(rain);
    container.style.filter = 'brightness(0.6)';

    setTimeout(() => {
      rain.remove();
      if (state.running) {
        container.style.filter = '';
        showStageIndicator('Èõ®„Åå„ÇÑ„Çì„Å†ÔºÅ');
      }
    }, 8000);
  } else {
    // Thunder: flash + Tom freezes 3 seconds
    showStageIndicator('‚ö° Èõ∑„Å†ÔºÅ„Éà„É†„Åå„Éì„Éì„Å£„ÅüÔºÅ');
    const flash = document.createElement('div');
    flash.className = 'weather-thunder-flash';
    container.appendChild(flash);
    setTimeout(() => flash.remove(), 300);

    playThunderSound();

    state.tomFrozen = true;
    state.spawnFrozen = true;
    tomEl.classList.add('frozen');
    setTimeout(() => {
      if (state.running) {
        state.tomFrozen = false;
        state.spawnFrozen = false;
        tomEl.classList.remove('frozen');
        showStageIndicator('„Éà„É†„ÅåËêΩ„Å°ÁùÄ„ÅÑ„Åü...');
      }
    }, 3000);
  }
}

function playThunderSound() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.type = 'sawtooth';
    osc.frequency.setValueAtTime(100, ctx.currentTime);
    osc.frequency.linearRampToValueAtTime(50, ctx.currentTime + 0.3);
    gain.gain.setValueAtTime(0.15, ctx.currentTime);
    gain.gain.linearRampToValueAtTime(0, ctx.currentTime + 0.3);
    osc.connect(gain);
    gain.connect(ctx.destination);
    osc.start();
    osc.stop(ctx.currentTime + 0.3);
  } catch (e) {}
}

function yokoInteractWithPoop() {
  if (!state.running) return;
  const room = state.currentRoom;
  const poops = state.poops[room];
  if (!poops || poops.length === 0) return;

  // Find a poop near Yoko (within 60px)
  let nearPoop = null;
  for (const p of poops) {
    const dx = state.yokoX - parseFloat(p.el.style.left);
    const dy = state.yokoY - parseFloat(p.el.style.top);
    if (Math.sqrt(dx * dx + dy * dy) < 60) {
      nearPoop = p;
      break;
    }
  }
  if (!nearPoop) return;

  if (Math.random() < 0.3) {
    // Cooperation (30%): Yoko cleans the poop
    yokoEl.classList.add('helping');
    setTimeout(() => yokoEl.classList.remove('helping'), 500);
    cleanPoop(room, nearPoop.id, nearPoop.el);
    showStageIndicator('<svg class="yoko-icon-inline" xmlns="http://www.w3.org/2000/svg" viewBox="5 0 40 35" style="width:28px;height:28px;vertical-align:middle;"><use href="#yoko-body"/></svg> „Çà„ÅÜ„Åì„Åå„ÅÜ„Çì„Å°„ÇíÁâá‰ªò„Åë„ÅüÔºÅ');
  } else {
    // Interference (70%): Yoko steps on poop, spawns 1 extra
    yokoEl.classList.add('stomping');
    setTimeout(() => yokoEl.classList.remove('stomping'), 400);
    const sx = parseFloat(nearPoop.el.style.left) + (-40 + Math.random() * 80);
    const sy = parseFloat(nearPoop.el.style.top) + (-40 + Math.random() * 80);
    spawnPoopAt(Math.max(10, Math.min(760, sx)), Math.max(50, Math.min(540, sy)));
    showStageIndicator('<svg class="yoko-icon-inline" xmlns="http://www.w3.org/2000/svg" viewBox="5 0 40 35" style="width:28px;height:28px;vertical-align:middle;"><use href="#yoko-body"/></svg> „Çà„ÅÜ„Åì„Åå„ÅÜ„Çì„Å°„ÇíË∏è„Çì„ÅßÂ∫É„Åí„ÅüÔºÅ');
  }
}

function spawnYokoPoop() {
  if (state.spawnFrozen) return;
  const room = state.currentRoom;
  const x = state.yokoX + 20;
  const y = state.yokoY + 60;

  const el = document.createElement('div');
  el.className = 'poop';
  let scaleVar = 0.9 + Math.random() * 0.4;
  if (state.equippedItems.includes('evade_cloak')) scaleVar *= 0.9;
  const rotVar = -15 + Math.random() * 30;
  el.style.width = (36 * scaleVar) + 'px';
  el.style.height = (38 * scaleVar) + 'px';
  el.style.transform = 'rotate(' + rotVar + 'deg)';
  el.appendChild(createPoopSVG(36 * scaleVar, 38 * scaleVar));
  el.style.left = x + 'px';
  el.style.top = y + 'px';

  const id = ++state.poopIdCounter;
  el.dataset.id = id;
  el.dataset.room = room;

  // Hidden poop mechanic (shimasa) - Yoko's poops are often hidden
  const yokoCfg = STAGES[state.currentStage];
  if (yokoCfg.mechanic === 'hidden_poop' && Math.random() < 0.5) {
    el.classList.add('hidden-poop');
  }

  el.addEventListener('click', (ev) => { ev.stopPropagation(); cleanPoop(room, id, el); });

  container.appendChild(el);
  state.poops[room].push({ id, x, y, el });
  state.totalPoops++;

  yokoEl.classList.add('pooping');
  setTimeout(() => yokoEl.classList.remove('pooping'), 600);
  showStageIndicator('„Çà„ÅÜ„Åì„Åå„ÅÜ„Çì„Å°„Çí„Åó„ÅüÔºÅ');

  updateHUD();

  if (state.totalPoops >= state.maxPoop) {
    gameOver();
  }
}

function spawnGoldenPoop() {
  if (!state.running || state.goldenActive) return;
  state.goldenActive = true;

  const room = state.currentRoom;
  const x = 60 + Math.random() * 660;
  const y = 90 + Math.random() * 380;

  const el = document.createElement('div');
  el.className = 'poop golden';
  const scaleVar = 1.0 + Math.random() * 0.3;
  el.style.width = (36 * scaleVar) + 'px';
  el.style.height = (38 * scaleVar) + 'px';
  el.appendChild(createPoopSVG(36 * scaleVar, 38 * scaleVar, true));
  el.style.left = x + 'px';
  el.style.top = y + 'px';
  // Timer bar
  const timerBar = document.createElement('div');
  timerBar.className = 'golden-timer';
  const timerFill = document.createElement('div');
  timerFill.className = 'gt-fill';
  timerBar.appendChild(timerFill);
  el.appendChild(timerBar);

  const id = ++state.poopIdCounter;
  el.dataset.id = id;
  el.dataset.room = room;
  el.dataset.golden = 'true';

  el.addEventListener('click', (ev) => {
    ev.stopPropagation();
    if (!state.running) return;
    if (state.eikoStunned || state.eikoAwakenedStun) return;
    const idx = state.poops[room].findIndex(p => p.id === id);
    if (idx === -1) return;
    playGoldenSound();
    playPikonSound();
    const px = parseFloat(el.style.left);
    const py = parseFloat(el.style.top);
    eikoX = px; eikoY = py - 10;
    updateEikoPosition();
    // Score popup
    const popup = document.createElement('div');
    popup.className = 'score-popup';
    popup.textContent = '+25';
    popup.style.left = px + 'px';
    popup.style.top = (py - 10) + 'px';
    container.appendChild(popup);
    setTimeout(() => popup.remove(), 800);
    // Sparkle
    const sparkle = document.createElement('div');
    sparkle.className = 'sparkle';
    sparkle.textContent = '‚ú®';
    sparkle.style.left = px + 'px';
    sparkle.style.top = py + 'px';
    container.appendChild(sparkle);
    setTimeout(() => sparkle.remove(), 500);
    el.classList.add('cleaned');
    setTimeout(() => el.remove(), 300);
    state.poops[room].splice(idx, 1);
    state.totalPoops--;
    state.score += 25;
    state.cleanedCount++;
    state.goldenActive = false;
    clearTimeout(goldenDisappearTimer);
    updateHUD();
    if (state.cleanedCount >= state.clearCount) {
      stageClear();
    }
  
  });

  container.appendChild(el);
  state.poops[room].push({ id, x, y, el, golden: true });
  state.totalPoops++;
  updateHUD();


  showStageIndicator('‚≠ê Èáë„ÅÆ„ÅÜ„Çì„Å°„ÅåÂá∫ÁèæÔºÅ');

  // Timer bar animation
  const goldenStart = Date.now();
  const goldenDuration = 5000;
  const barInterval = setInterval(() => {
    const elapsed = Date.now() - goldenStart;
    const pct = Math.max(0, 100 - (elapsed / goldenDuration) * 100);
    timerFill.style.width = pct + '%';
    if (pct <= 0) clearInterval(barInterval);
  }, 50);

  // Auto-disappear after 5 seconds
  const goldenDisappearTimer = setTimeout(() => {
    if (!state.goldenActive) return;
    const idx = state.poops[room].findIndex(p => p.id === id);
    if (idx !== -1) {
      el.classList.add('cleaned');
      setTimeout(() => el.remove(), 300);
      state.poops[room].splice(idx, 1);
      state.totalPoops--;
      updateHUD();
    
    }
    state.goldenActive = false;
    clearInterval(barInterval);
  }, goldenDuration);
}

function startRushMode() {
  if (!state.running || state.rushMode) return;
  state.rushMode = true;
  container.classList.add('rush-active');
  document.getElementById('rush-banner').style.display = '';
  showStageIndicator('‚ö° „ÅÜ„Çì„Å°„É©„ÉÉ„Ç∑„É•„É¢„Éº„ÉâÔºÅ');
  stopBGM();
  startRushBGM();

  // Spawn poops rapidly during rush
  let rushCount = 0;
  const maxRushPoops = 8 + Math.floor(Math.random() * 5);
  function rushSpawn() {
    if (!state.running || !state.rushMode || rushCount >= maxRushPoops) {
      stopRushMode();
      return;
    }
    spawnPoop();
    rushCount++;
    rushPoopInterval = setTimeout(rushSpawn, 300 + Math.random() * 400);
  }
  rushPoopInterval = setTimeout(rushSpawn, 500);

  // Auto-stop rush after ~8 seconds
  state.rushTimer = setTimeout(() => {
    stopRushMode();
  }, 8000);
}

function stopRushMode() {
  if (!state.rushMode) return;
  state.rushMode = false;
  clearTimeout(state.rushTimer);
  clearTimeout(rushPoopInterval);
  container.classList.remove('rush-active');
  document.getElementById('rush-banner').style.display = 'none';
  stopRushBGM();
  if (state.running) {
    startBGM(state.currentStage);
    showStageIndicator('„É©„ÉÉ„Ç∑„É•ÁµÇ‰∫ÜÔºÅ');
  }
}

function updateEikoPosition() {
  eikoEl.style.left = eikoX + 'px';
  eikoEl.style.top = eikoY + 'px';
}

function updateHUD() {
  document.getElementById('score').textContent = state.score;
  document.getElementById('timer').textContent = state.timeLeft + 'Áßí';
  document.getElementById('poop-count').textContent = state.totalPoops;
  document.getElementById('poop-max').textContent = state.maxPoop;
  document.getElementById('cleaned-count').textContent = state.cleanedCount || 0;
  document.getElementById('clear-count').textContent = state.clearCount || 0;

  const pct = (state.totalPoops / state.maxPoop) * 100;
  const bar = document.getElementById('poop-bar');
  bar.style.width = pct + '%';

  // Color warning
  const timer = document.getElementById('timer');
  if (state.timeLeft <= 10) {
    timer.style.color = '#ff4444';
  } else if (state.timeLeft <= 20) {
    timer.style.color = '#ffaa00';
  } else {
    timer.style.color = '#fff';
  }

  // Update BGM tempo based on danger level
  let tempoMul = 1;
  if (state.totalPoops >= state.maxPoop * 0.7) tempoMul *= 1.3;
  if (state.timeLeft <= 10) tempoMul *= 1.2;
  state.bgmTempoMultiplier = tempoMul;
}


function showStageIndicator(text) {
  const el = document.getElementById('stage-indicator');
  el.innerHTML = text;
  el.style.display = '';
  el.style.animation = 'none';
  el.offsetHeight; // reflow
  el.style.animation = '';
  setTimeout(() => el.style.display = 'none', 2000);
}

function gameOver() {
  stopGame();
  playBadEndBGM();

  for (let i = 0; i < 50; i++) {
    setTimeout(() => {
      const fp = document.createElement('div');
      fp.className = 'flood-poop';
      const sz = 25 + Math.random() * 35;
      fp.style.width = sz + 'px';
      fp.style.height = (sz * 1.06) + 'px';
      fp.style.transform = 'rotate(' + (-20 + Math.random() * 40) + 'deg)';
      fp.appendChild(createPoopSVG(sz, sz * 1.06));
      fp.style.left = Math.random() * 760 + 'px';
      fp.style.top = Math.random() * 560 + 'px';
      container.appendChild(fp);
    }, i * 50);
  }

  setTimeout(() => {
    const screen = document.getElementById('gameover-screen');
    screen.innerHTML = '';
    const overlay = document.createElement('div');
    overlay.className = 'bad-overlay';
    const stageName = STAGES[state.currentStage].name;
    overlay.innerHTML =
      '<div class="bad-bg"></div>' +
      '<h1>„Éê„ÉÉ„Éâ„Ç®„É≥„Éâ</h1>' +
      '<p>Stage ' + (state.currentStage + 1) + ' „Äå' + stageName + '„Äç„Åß„ÅÜ„Çì„Å°„ÅåÊ∫¢„Çå„Åü...</p>' +
      '<p>ÊÆã„Çä„ÅÜ„Çì„Å°: ' + state.totalPoops + 'ÂÄã</p>' +
      '<p style="font-size:24px; color:#e8dcd0; margin-top:10px;">„Çπ„Ç≥„Ç¢: ' + (state.totalScore + state.score) + 'ÁÇπ</p>' +
      '<button class="btn btn-retry" onclick="showTitle()">„Çø„Ç§„Éà„É´„Å´Êàª„Çã</button>';
    screen.appendChild(overlay);
    screen.style.display = '';
  }, 1500);
}

function getRank(timeLeft) {
  if (timeLeft >= 15) return { rank: 'S', color: '#FFD700' };
  if (timeLeft >= 10) return { rank: 'A', color: '#54a0ff' };
  if (timeLeft >= 5)  return { rank: 'B', color: '#4ecdc4' };
  return { rank: 'C', color: '#aaa' };
}

function showRankDisplay(rankInfo) {
  const el = document.createElement('div');
  el.className = 'rank-display rank-' + rankInfo.rank;
  el.textContent = rankInfo.rank;
  container.appendChild(el);
  setTimeout(() => el.remove(), 1200);
}

function stageClear() {
  const stageMaxCombo = state.maxCombo;
  stopGame();
  playFanfare();

  const timeBonus = state.timeLeft * 1;
  const stageScore = state.score + timeBonus;
  state.totalScore += stageScore;
  const rankInfo = getRank(state.timeLeft);
  rankInfo.maxCombo = stageMaxCombo;
  state.stageRanks.push(rankInfo.rank);

  // Show rank display
  showRankDisplay(rankInfo);

  // Is this the final stage?
  if (state.currentStage >= STAGES.length - 1) {
    // Final victory!
    gameAllClear(stageScore, timeBonus, rankInfo);
    return;
  }

  // Spawn confetti briefly
  const colors = ['#ffd700', '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ff9ff3', '#54a0ff'];
  for (let i = 0; i < 30; i++) {
    setTimeout(() => {
      const confetti = document.createElement('div');
      confetti.className = 'happy-confetti';
      confetti.style.left = Math.random() * 800 + 'px';
      confetti.style.top = '-20px';
      confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
      confetti.style.width = (6 + Math.random() * 8) + 'px';
      confetti.style.height = (6 + Math.random() * 8) + 'px';
      confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
      container.appendChild(confetti);
      setTimeout(() => confetti.remove(), 4500);
    }, i * 60);
  }

  // Show shop after brief celebration
  setTimeout(() => {
    showShop(stageScore, timeBonus, rankInfo);
  }, 1200);
}

function gameAllClear(stageScore, timeBonus, rankInfo) {
  // Determine ending type from accumulated ranks
  const ranks = state.stageRanks;
  const allS = ranks.every(r => r === 'S');
  const cCount = ranks.filter(r => r === 'C').length;
  const hasNoC = cCount === 0;
  const rankValues = { S: 4, A: 3, B: 2, C: 1 };
  const avgScore = ranks.reduce((sum, r) => sum + rankValues[r], 0) / ranks.length;

  let endingType;
  if (allS) {
    endingType = 'perfect';
  } else if (hasNoC && avgScore >= 3) {
    endingType = 'good';
  } else if (cCount >= 2) {
    endingType = 'shimasa';
  } else {
    endingType = 'normal';
  }

  playAllClearBGM();

  // Confetti amount varies by ending
  const confettiCount = endingType === 'perfect' ? 120 : endingType === 'shimasa' ? 20 : 60;
  const confettiColors = endingType === 'perfect'
    ? ['#ffd700', '#ffec8b', '#fff8dc', '#ffe135', '#f0e68c']
    : ['#ffd700', '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#ff9ff3', '#54a0ff'];

  for (let i = 0; i < confettiCount; i++) {
    setTimeout(() => {
      const confetti = document.createElement('div');
      confetti.className = 'happy-confetti';
      confetti.style.left = Math.random() * 800 + 'px';
      confetti.style.top = '-20px';
      confetti.style.backgroundColor = confettiColors[Math.floor(Math.random() * confettiColors.length)];
      confetti.style.width = (6 + Math.random() * 8) + 'px';
      confetti.style.height = (6 + Math.random() * 8) + 'px';
      confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
      container.appendChild(confetti);
      setTimeout(() => confetti.remove(), 5000);
    }, i * 50);
  }

  // Build rank display row
  const rankRow = ranks.map((r, i) =>
    '<span class="rank-badge rank-' + r + '" style="font-size:22px;">' + r + '</span>'
  ).join(' - ');

  setTimeout(() => {
    const screen = document.getElementById('clear-screen');
    screen.innerHTML = '';
    const overlay = document.createElement('div');
    overlay.className = 'happy-overlay';

    let title, message, bgStyle;

    if (endingType === 'perfect') {
      title = '‚ú® ÂÆåÁíß„Ç®„É≥„Éâ ‚ú®';
      message = 'ÂÖ®„Çπ„ÉÜ„Éº„Ç∏S„É©„É≥„ÇØÔºÅ„ÅÇ„Å™„Åü„ÅØ‰ºùË™¨„ÅÆ„ÅÜ„Çì„Å°Âá¶ÁêÜ„Éû„Çπ„Çø„ÉºÔºÅ';
      bgStyle = 'background: linear-gradient(180deg, rgba(255,215,0,0.3), rgba(255,180,0,0.1));';
    } else if (endingType === 'good') {
      title = 'üéâ „Ç∞„ÉÉ„Éâ„Ç®„É≥„Éâ üéâ';
      message = 'Á¥†Êô¥„Çâ„Åó„ÅÑÊàêÁ∏æ„Åß„ÇØ„É™„Ç¢ÔºÅ„Åà„ÅÑ„Åì„ÇÇ„Éà„É†„ÇÇÂ§ßÊ∫ÄË∂≥ÔºÅ';
      bgStyle = '';
    } else if (endingType === 'shimasa') {
      title = 'üò§ „Åó„Åæ„ÅïÊøÄÊÄí„Ç®„É≥„Éâ üò§';
      message = '„Åó„Åæ„Åï„Äå„Åì„Çì„Å™ÊàêÁ∏æ„ÅßÁâá‰ªò„Åë„Åü„Å®„ÅØË®Ä„Åà„ÇìÔºÅ„ÇÑ„ÇäÁõ¥„Åó„Åò„ÇÉÔºÅ„Äç';
      bgStyle = 'background: linear-gradient(180deg, rgba(180,60,60,0.2), rgba(100,30,30,0.1));';
    } else {
      title = 'üè† „Éé„Éº„Éû„É´„Ç®„É≥„Éâ';
      message = 'ÂÖ®„Å¶„ÅÆ„ÅÜ„Çì„Å°„ÇíÁâá‰ªò„Åë„ÅüÔºÅ„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅ';
      bgStyle = '';
    }

    overlay.setAttribute('style', bgStyle);
    overlay.innerHTML =
      '<h1>' + title + '</h1>' +
      '<p>' + message + '</p>' +
      '<p style="margin:10px 0;">„Çπ„ÉÜ„Éº„Ç∏Ë©ï‰æ°: ' + rankRow + '</p>' +
      '<p>„Çø„Ç§„É†„Éú„Éº„Éä„Çπ: +' + timeBonus + 'ÁÇπ</p>' +
      '<p style="font-size:32px; color:#ffd700; margin-top:12px;">Á∑èÂêà„Çπ„Ç≥„Ç¢: ' + state.totalScore + 'ÁÇπ</p>' +
      '<button class="btn btn-start" onclick="showTitle()">„Çø„Ç§„Éà„É´„Å´Êàª„Çã</button>';
    screen.appendChild(overlay);
    screen.style.display = '';
  }, 1000);
}

function showShop(stageScore, timeBonus, rankInfo) {
  startShopBGM();
  const screen = document.getElementById('shop-screen');
  screen.innerHTML = '';

  const overlay = document.createElement('div');
  overlay.className = 'shop-overlay';

  const nextStage = STAGES[state.currentStage + 1];
  let html = '<div class="shop-title">„Ç∑„Éß„ÉÉ„Éó</div>';
  html += '<div class="shop-stage-info">Stage ' + (state.currentStage + 1) + ' „ÇØ„É™„Ç¢ÔºÅ „É©„É≥„ÇØ: <span class="rank-badge rank-' + rankInfo.rank + '">' + rankInfo.rank + '</span> +' + stageScore + 'ÁÇπ („Çø„Ç§„É†„Éú„Éº„Éä„Çπ: +' + timeBonus + ')' + (rankInfo.maxCombo >= 3 ? ' üî•ÊúÄÂ§ß„Ç≥„É≥„Éú: ' + rankInfo.maxCombo : '') + '</div>';
  html += '<div class="shop-coins" id="shop-coins">ÊâÄÊåÅ„Çπ„Ç≥„Ç¢: ' + state.totalScore + 'ÁÇπ</div>';
  let mechanicHint = '';
  if (nextStage.mechanic === 'slippery') mechanicHint = ' ‚ö†Â∫ä„ÅåÊªë„Çã';
  if (nextStage.mechanic === 'pee_puddle') mechanicHint = ' ‚ö†„Åä„Åó„Å£„ÅìÊ∞¥„Åü„Åæ„Çä';
  if (nextStage.mechanic === 'hidden_poop') mechanicHint = ' ‚ö†„ÅÜ„Çì„Å°„ÅåÈö†„Çå„Å¶„ÅÑ„Çã';
  if (nextStage.mechanic === 'misclick_penalty') mechanicHint = ' ‚ö†' + misclickWord + 'Ôºã„Éà„É©„ÉÉ„Éó';
  html += '<div class="shop-stage-info">Ê¨°: Stage ' + (state.currentStage + 2) + ' „Äå' + nextStage.name + '„Äç' + mechanicHint + '</div>';

  // Equipment slots display
  html += '<div class="equip-slots">';
  html += '<div class="equip-slots-title">Ë£ÖÂÇô„Çπ„É≠„ÉÉ„Éà (' + state.equippedItems.length + '/' + MAX_EQUIP_SLOTS + ')</div>';
  html += '<div class="equip-slots-row">';
  for (let i = 0; i < MAX_EQUIP_SLOTS; i++) {
    const eqId = state.equippedItems[i];
    if (eqId) {
      const eqItem = findItem(eqId);
      html += '<div class="equip-slot filled" onclick="unequipItem(\'' + eqId + '\')">';
      html += '<span class="equip-slot-icon">' + eqItem.icon + '</span>';
      html += '<span class="equip-slot-name">' + eqItem.name + '</span>';
      html += '<span class="equip-slot-remove">‚úï Â§ñ„Åô</span>';
      html += '</div>';
    } else {
      html += '<div class="equip-slot empty"><span class="equip-slot-icon">‚Äî</span><span class="equip-slot-name">Á©∫„Åç„Çπ„É≠„ÉÉ„Éà</span></div>';
    }
  }
  html += '</div></div>';

  // Synergy info
  const activeSyn = getActiveSynergy();
  if (activeSyn) {
    html += '<div class="synergy-active">üåü „Ç∑„Éä„Ç∏„ÉºÁô∫Âãï‰∏≠: <strong>' + activeSyn.name + '</strong> ‚Äî ' + activeSyn.desc + '</div>';
  }
  // Synergy hints
  html += '<div class="synergy-hints"><span class="synergy-hints-title">„Ç∑„Éä„Ç∏„Éº‰∏ÄË¶ß:</span>';
  SYNERGIES.forEach(syn => {
    const item1 = findItem(syn.items[0]);
    const item2 = findItem(syn.items[1]);
    const both = syn.items.every(id => state.ownedItems.includes(id));
    const isActive = activeSyn && activeSyn.name === syn.name;
    html += '<span class="synergy-hint' + (isActive ? ' synergy-active-hint' : '') + (both ? ' synergy-ready' : '') + '">' +
      item1.icon + '+' + item2.icon + '=' + syn.icon + syn.name + '</span>';
  });
  html += '</div>';

  // Crafting section
  const availableCrafts = CRAFT_RECIPES.filter(r =>
    r.ingredients.every(id => state.ownedItems.includes(id)) && !state.ownedItems.includes(r.result.id)
  );
  if (availableCrafts.length > 0 || CRAFT_RECIPES.some(r => state.ownedItems.includes(r.result.id))) {
    html += '<div class="craft-section"><div class="craft-title">‚öóÔ∏è ÂêàÊàê</div>';
    CRAFT_RECIPES.forEach((recipe, ri) => {
      const item1 = findItem(recipe.ingredients[0]);
      const item2 = findItem(recipe.ingredients[1]);
      const hasBoth = recipe.ingredients.every(id => state.ownedItems.includes(id));
      const alreadyCrafted = state.ownedItems.includes(recipe.result.id);
      const canAffordCraft = state.totalScore >= recipe.cost;
      html += '<div class="craft-recipe' + (alreadyCrafted ? ' crafted' : '') + '">';
      html += '<div class="craft-ingredients">' + item1.icon + ' ' + item1.name + ' + ' + item2.icon + ' ' + item2.name + '</div>';
      html += '<div class="craft-arrow">‚Üí</div>';
      html += '<div class="craft-result-info">';
      html += '<span class="craft-result-icon">' + recipe.result.icon + '</span>';
      html += '<span class="craft-result-name">' + recipe.result.name + '</span>';
      html += '<div class="craft-result-desc">' + recipe.result.desc + '</div>';
      html += '<div class="shop-item-side">' + recipe.result.side + '</div>';
      html += '</div>';
      if (alreadyCrafted) {
        html += '<div class="craft-status">ÂêàÊàêÊ∏à„Åø</div>';
      } else if (hasBoth && canAffordCraft) {
        html += '<button class="shop-item-btn craft-btn" onclick="craftItem(' + ri + ')">ÂêàÊàê„Åô„Çã (' + recipe.cost + 'ÁÇπ)</button>';
      } else if (hasBoth && !canAffordCraft) {
        html += '<button class="shop-item-btn" disabled>„Çπ„Ç≥„Ç¢‰∏çË∂≥ (' + recipe.cost + 'ÁÇπ)</button>';
      } else {
        html += '<div class="craft-status craft-locked">Á¥†Êùê‰∏çË∂≥</div>';
      }
      html += '</div>';
    });
    html += '</div>';
  }

  // Shop items
  html += '<div class="shop-items">';
  getAllItems().forEach(item => {
    const owned = state.ownedItems.includes(item.id);
    const equipped = state.equippedItems.includes(item.id);
    const canAfford = state.totalScore >= item.price;
    const isCrafted = CRAFT_RECIPES.some(r => r.result.id === item.id);
    if (isCrafted && !owned) return; // Hide crafted items from normal shop if not owned
    html += '<div class="shop-item' + (equipped ? ' equipped' : '') + (isCrafted ? ' crafted-item' : '') + '">';
    html += '<div class="shop-item-icon">' + item.icon + '</div>';
    html += '<div class="shop-item-name">' + item.name + (isCrafted ? ' ‚öóÔ∏è' : '') + '</div>';
    html += '<div class="shop-item-desc">' + item.desc + '</div>';
    html += '<div class="shop-item-side">' + item.side + '</div>';
    html += '<div class="shop-item-type">' + (item.type === 'passive' ? '„Éë„ÉÉ„Ç∑„Éñ' : '„Ç¢„ÇØ„ÉÜ„Ç£„Éñ') + '</div>';
    html += '<div class="shop-item-price">' + item.price + 'ÁÇπ</div>';
    if (owned && equipped) {
      html += '<button class="shop-item-btn equipped-btn" onclick="unequipItem(\'' + item.id + '\')">Ë£ÖÂÇô‰∏≠ ‚úï</button>';
      html += '<button class="shop-item-btn sell-btn" onclick="sellItem(\'' + item.id + '\')">Â£≤Âç¥ (+' + Math.floor(item.price / 2) + 'ÁÇπ)</button>';
    } else if (owned && !equipped) {
      const slotsFull = state.equippedItems.length >= MAX_EQUIP_SLOTS;
      html += '<button class="shop-item-btn equip-btn" ' + (slotsFull ? 'disabled' : '') +
        ' onclick="equipItem(\'' + item.id + '\')">' +
        (slotsFull ? '„Çπ„É≠„ÉÉ„ÉàÊ∫ÄÊùØ' : 'Ë£ÖÂÇô„Åô„Çã') + '</button>';
      html += '<button class="shop-item-btn sell-btn" onclick="sellItem(\'' + item.id + '\')">Â£≤Âç¥ (+' + Math.floor(item.price / 2) + 'ÁÇπ)</button>';
    } else if (!isCrafted) {
      html += '<button class="shop-item-btn" id="buy-' + item.id + '" ' +
        (canAfford ? '' : 'disabled') +
        ' onclick="buyItem(\'' + item.id + '\')">' +
        (canAfford ? 'Ë≥ºÂÖ•„Åô„Çã' : '„Çπ„Ç≥„Ç¢‰∏çË∂≥') + '</button>';
    }
    html += '</div>';
  });

  html += '</div>';
  html += '<button class="shop-next-btn" onclick="proceedToNextStage()">Ê¨°„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„Å∏ ‚Üí</button>';

  overlay.innerHTML = html;
  screen.appendChild(overlay);
  screen.style.display = '';
}

function refreshShop() {
  // Re-render the shop with current state
  const stageScore = state.score;
  const timeBonus = state.timeLeft * 1;
  const rankInfo = getRank(state.timeLeft);
  showShop(stageScore, timeBonus, rankInfo);
}

function buyItem(itemId) {
  const item = SHOP_ITEMS.find(i => i.id === itemId);
  if (!item || state.ownedItems.includes(itemId) || state.totalScore < item.price) return;

  state.totalScore -= item.price;
  state.ownedItems.push(itemId);

  // Auto-equip if slots available
  if (state.equippedItems.length < MAX_EQUIP_SLOTS) {
    state.equippedItems.push(itemId);
  }

  playPikonSound();
  refreshShop();
}

function sellItem(itemId) {
  const item = findItem(itemId);
  if (!item || !state.ownedItems.includes(itemId)) return;

  // Unequip if equipped
  const eqIdx = state.equippedItems.indexOf(itemId);
  if (eqIdx !== -1) state.equippedItems.splice(eqIdx, 1);

  // Remove from owned
  state.ownedItems.splice(state.ownedItems.indexOf(itemId), 1);

  // Refund half price
  state.totalScore += Math.floor(item.price / 2);

  refreshShop();
}

function craftItem(recipeIndex) {
  const recipe = CRAFT_RECIPES[recipeIndex];
  if (!recipe) return;
  if (!recipe.ingredients.every(id => state.ownedItems.includes(id))) return;
  if (state.ownedItems.includes(recipe.result.id)) return;
  if (state.totalScore < recipe.cost) return;

  // Consume ingredients (unequip if equipped)
  recipe.ingredients.forEach(id => {
    const eqIdx = state.equippedItems.indexOf(id);
    if (eqIdx !== -1) state.equippedItems.splice(eqIdx, 1);
    state.ownedItems.splice(state.ownedItems.indexOf(id), 1);
  });

  // Pay cost
  state.totalScore -= recipe.cost;

  // Add crafted item
  state.ownedItems.push(recipe.result.id);

  playPikonSound();
  refreshShop();
}

function equipItem(itemId) {
  if (!state.ownedItems.includes(itemId)) return;
  if (state.equippedItems.includes(itemId)) return;
  if (state.equippedItems.length >= MAX_EQUIP_SLOTS) return;
  state.equippedItems.push(itemId);
  playPikonSound();
  refreshShop();
}

function unequipItem(itemId) {
  const idx = state.equippedItems.indexOf(itemId);
  if (idx === -1) return;
  state.equippedItems.splice(idx, 1);
  refreshShop();
}

function proceedToNextStage() {
  stopShopBGM();
  document.getElementById('shop-screen').style.display = 'none';
  document.getElementById('shop-screen').innerHTML = '';
  clearFlood();
  clearAllPoopElements();
  document.querySelectorAll('.happy-confetti').forEach(e => e.remove());
  document.querySelectorAll('.pee-puddle').forEach(e => e.remove());
  document.querySelectorAll('.misclick-flash').forEach(e => e.remove());
  startStage(state.currentStage + 1);
}

// Tom click -> cage
tomEl.addEventListener('click', (ev) => { ev.stopPropagation(); cageTom(); });

// Check clear periodically (when enough time passed and all poops gone)
setInterval(() => {
  if (!state.running) return;
  const cfg = STAGES[state.currentStage];
  const elapsed = cfg.time - state.timeLeft;
  if (elapsed >= 8 && state.totalPoops === 0) {
    stageClear();
  }
}, 500);

// Show title on load
showTitle();
</script>

</body>
</html>
